<h1 id="problem-statement-6-finance-spend-analytics-and-optimization">Problem Statement 6: Finance Spend Analytics and Optimization</h1>
<h2 id="problem-overview">Problem Overview</h2>
<p>Develop an AI-powered finance spend analytics and optimization platform that provides real-time visibility into organizational spending patterns, identifies cost-saving opportunities, automates expense categorization, detects anomalies and fraud, and delivers actionable insights for strategic financial decision-making.</p>
<h2 id="key-requirements">Key Requirements</h2>
<ul>
<li><strong>Intelligent Expense Categorization</strong>: Automated classification of expenses using ML and NLP</li>
<li><strong>Real-Time Spend Analytics</strong>: Live dashboards with drill-down capabilities and trend analysis</li>
<li><strong>Anomaly Detection</strong>: AI-powered identification of unusual spending patterns and potential fraud</li>
<li><strong>Budget Management</strong>: Dynamic budget tracking, forecasting, and variance analysis</li>
<li><strong>Vendor Analysis</strong>: Comprehensive vendor performance and spend optimization insights</li>
<li><strong>Compliance Monitoring</strong>: Automated policy compliance checking and audit trail management</li>
<li><strong>Predictive Forecasting</strong>: ML-based spend forecasting and budget planning</li>
<li><strong>Cost Optimization</strong>: AI-driven recommendations for cost reduction and efficiency improvements</li>
</ul>
<h2 id="suggested-data-requirements">Suggested Data Requirements</h2>
<ul>
<li>Historical financial transaction data with detailed expense records</li>
<li>Chart of accounts and expense category taxonomies</li>
<li>Vendor master data with contracts and pricing information</li>
<li>Budget and forecast data across departments and cost centers</li>
<li>Employee expense reports and approval workflows</li>
<li>Invoice and purchase order data with line-item details</li>
<li>Market pricing data for benchmarking and optimization</li>
<li>Regulatory compliance requirements and audit logs</li>
</ul>
<h2 id="key-themes">Key Themes</h2>
<ul>
<li>Machine Learning for expense categorization and anomaly detection</li>
<li>Real-time Analytics with interactive dashboards and reporting</li>
<li>Natural Language Processing for invoice and document analysis</li>
<li>Predictive Modeling for budget forecasting and trend analysis</li>
<li>Fraud Detection using statistical and behavioral analysis</li>
<li>Process Automation for approval workflows and compliance checking</li>
<li>Data Integration across ERP, procurement, and financial systems</li>
</ul>
<h2 id="technical-approach">Technical Approach</h2>
<ul>
<li><strong>AI/ML Pipeline</strong>: Advanced algorithms for categorization, anomaly detection, and forecasting</li>
<li><strong>Real-Time Processing</strong>: Stream processing for live spend monitoring and alerts</li>
<li><strong>Analytics Engine</strong>: OLAP capabilities with multi-dimensional analysis and visualization</li>
<li><strong>Integration Platform</strong>: APIs for ERP, procurement, banking, and third-party data sources</li>
<li><strong>Mobile Application</strong>: Executive dashboards and approval workflows on mobile devices</li>
<li><strong>Compliance Framework</strong>: Automated policy enforcement and audit trail generation</li>
</ul>
<h2 id="expected-outcomes">Expected Outcomes</h2>
<ul>
<li>30% reduction in manual expense processing time through AI automation</li>
<li>15% cost savings identification through spend optimization recommendations</li>
<li>90% accuracy in automated expense categorization and fraud detection</li>
<li>50% faster budget planning and forecasting cycles</li>
<li>95% compliance with financial policies and regulatory requirements</li>
<li>Real-time visibility into organizational spend with executive-level insights</li>
</ul>
<h2 id="implementation-strategy">Implementation Strategy</h2>
<p>Apply ETVX methodology with cumulative build approach for comprehensive documentation covering product requirements, functional specifications, technical architecture, and implementation-ready designs for enterprise-grade finance spend analytics and optimization platform. # Product Requirements Document (PRD) ## Finance Spend Analytics and Optimization Platform</p>
<p><em>Foundation document for comprehensive financial spend management solution</em></p>
<h2 id="etvx-framework">ETVX Framework</h2>
<h3 id="entry-criteria">ENTRY CRITERIA</h3>
<ul>
<li>✅ Problem statement analysis completed for finance spend analytics and optimization</li>
<li>✅ Market research conducted on existing financial analytics platforms and solutions</li>
<li>✅ Stakeholder requirements gathered from CFOs, finance teams, procurement professionals</li>
<li>✅ Competitive analysis completed for major spend analytics and financial management platforms</li>
<li>✅ Technical feasibility assessment completed for AI-powered financial analytics</li>
<li>✅ Regulatory compliance requirements identified (SOX, GAAP, IFRS, tax regulations)</li>
</ul>
<h3 id="task">TASK</h3>
<p>Define comprehensive product requirements for an AI-powered finance spend analytics and optimization platform that transforms organizational financial management through intelligent expense categorization, real-time analytics, anomaly detection, predictive forecasting, and automated compliance while ensuring regulatory adherence and enterprise security.</p>
<h3 id="verification-validation">VERIFICATION &amp; VALIDATION</h3>
<p><strong>Verification Checklist:</strong> - [ ] Business objectives align with CFO priorities and financial management needs - [ ] Success metrics are measurable and achievable within defined timelines - [ ] User personas represent complete financial ecosystem (CFOs, controllers, analysts, procurement) - [ ] Product features address all critical financial management workflow stages - [ ] Technical requirements support scalability and integration with ERP systems - [ ] Compliance requirements address all relevant financial regulations</p>
<p><strong>Validation Criteria:</strong> - [ ] Product vision validated with finance industry experts and CFO advisory board - [ ] Market analysis confirmed through customer interviews and financial surveys - [ ] Success metrics benchmarked against industry standards and competitor performance - [ ] User personas validated through finance professional research and stakeholder feedback - [ ] Feature prioritization confirmed with potential enterprise customers and partners - [ ] Business model validated through market analysis and pricing research</p>
<h3 id="exit-criteria">EXIT CRITERIA</h3>
<ul>
<li>✅ Complete product vision and strategy documented</li>
<li>✅ Measurable success criteria and KPIs defined</li>
<li>✅ User personas and market analysis completed</li>
<li>✅ Core product features and capabilities specified</li>
<li>✅ Technical and business constraints identified</li>
<li>✅ Foundation established for functional requirements development</li>
</ul>
<hr />
<h2 id="product-vision-and-strategy">1. Product Vision and Strategy</h2>
<h3 id="product-vision">1.1 Product Vision</h3>
<p>Transform organizational financial management through AI-powered spend analytics that provides real-time visibility, identifies optimization opportunities, ensures compliance, and delivers actionable insights that drive strategic financial decision-making and cost efficiency.</p>
<h3 id="mission-statement">1.2 Mission Statement</h3>
<p>Empower finance teams and executives with intelligent spend analytics that eliminate manual processes, uncover hidden cost savings, ensure regulatory compliance, and enable data-driven financial strategies that optimize organizational performance.</p>
<h3 id="strategic-objectives">1.3 Strategic Objectives</h3>
<ul>
<li><strong>Efficiency</strong>: Reduce manual expense processing time by 30% through AI automation</li>
<li><strong>Savings</strong>: Identify 15% cost savings through intelligent spend optimization recommendations</li>
<li><strong>Accuracy</strong>: Achieve 90% accuracy in automated expense categorization and fraud detection</li>
<li><strong>Speed</strong>: Accelerate budget planning and forecasting cycles by 50%</li>
<li><strong>Compliance</strong>: Maintain 95% compliance with financial policies and regulatory requirements</li>
</ul>
<h2 id="market-analysis">2. Market Analysis</h2>
<h3 id="market-size-and-opportunity">2.1 Market Size and Opportunity</h3>
<ul>
<li><strong>Total Addressable Market (TAM)</strong>: $45B global financial analytics market</li>
<li><strong>Serviceable Addressable Market (SAM)</strong>: $8B AI-powered spend analytics solutions</li>
<li><strong>Serviceable Obtainable Market (SOM)</strong>: $800M enterprise spend management platforms</li>
<li><strong>Growth Rate</strong>: 22% CAGR in AI-powered financial analytics adoption</li>
</ul>
<h3 id="competitive-landscape">2.2 Competitive Landscape</h3>
<p><strong>Direct Competitors:</strong> - Coupa Spend Analytics: Procurement-focused spend analysis - AppZen: AI-powered expense auditing and compliance - Oversight: Expense fraud detection and policy compliance - Concur Analytics: Travel and expense spend insights</p>
<p><strong>Indirect Competitors:</strong> - Traditional ERP Analytics: SAP Analytics, Oracle Financial Analytics - Business Intelligence: Tableau, Power BI, Qlik for financial reporting - Expense Management: Expensify, Chrome River, Certify</p>
<p><strong>Competitive Advantages:</strong> - Real-time AI-powered spend categorization and anomaly detection - Comprehensive financial optimization recommendations with ROI quantification - Advanced predictive forecasting with scenario modeling - Seamless integration with existing financial and procurement systems</p>
<h3 id="market-trends">2.3 Market Trends</h3>
<ul>
<li>Increased focus on cost optimization and financial efficiency post-pandemic</li>
<li>Growing demand for real-time financial visibility and decision support</li>
<li>Rising importance of automated compliance and audit trail management</li>
<li>Shift toward predictive financial analytics and scenario planning</li>
<li>Integration of AI/ML for fraud detection and spend optimization</li>
</ul>
<h2 id="user-personas-and-stakeholders">3. User Personas and Stakeholders</h2>
<h3 id="primary-users">3.1 Primary Users</h3>
<p><strong>Persona 1: Chief Financial Officer (Michael)</strong> - <strong>Role</strong>: CFO at Fortune 500 company overseeing $2B annual spend - <strong>Goals</strong>: Strategic cost optimization, regulatory compliance, financial risk management - <strong>Pain Points</strong>: Limited real-time visibility, manual reporting processes, compliance complexity - <strong>Success Metrics</strong>: Cost reduction targets, compliance scores, forecast accuracy - <strong>Technology Comfort</strong>: Medium - focuses on strategic insights over technical details</p>
<p><strong>Persona 2: Finance Controller (Sarah)</strong> - <strong>Role</strong>: Controller managing financial operations and reporting - <strong>Goals</strong>: Accurate financial reporting, expense policy compliance, audit readiness - <strong>Pain Points</strong>: Manual expense categorization, policy violations, audit preparation time - <strong>Success Metrics</strong>: Reporting accuracy, compliance rates, audit efficiency - <strong>Technology Comfort</strong>: High - uses multiple financial systems daily</p>
<p><strong>Persona 3: Financial Analyst (David)</strong> - <strong>Role</strong>: Senior Financial Analyst performing spend analysis and budgeting - <strong>Goals</strong>: Detailed spend insights, variance analysis, budget optimization - <strong>Pain Points</strong>: Data silos, manual analysis, limited forecasting tools - <strong>Success Metrics</strong>: Analysis quality, forecast accuracy, insight generation speed - <strong>Technology Comfort</strong>: High - proficient with analytics tools and data manipulation</p>
<p><strong>Persona 4: Procurement Manager (Lisa)</strong> - <strong>Role</strong>: Strategic Procurement Manager overseeing vendor relationships - <strong>Goals</strong>: Vendor performance optimization, contract compliance, cost negotiation - <strong>Pain Points</strong>: Limited vendor spend visibility, contract tracking, savings validation - <strong>Success Metrics</strong>: Cost savings, vendor performance, contract compliance - <strong>Technology Comfort</strong>: Medium - uses procurement systems and basic analytics</p>
<h3 id="secondary-stakeholders">3.2 Secondary Stakeholders</h3>
<ul>
<li><strong>Executive Leadership</strong>: ROI on financial technology investments, strategic insights</li>
<li><strong>Internal Audit</strong>: Compliance monitoring, fraud detection, audit trail management</li>
<li><strong>IT Leadership</strong>: System integration, security, data governance</li>
<li><strong>Department Managers</strong>: Budget management, expense approval, cost center performance</li>
</ul>
<h2 id="business-objectives-and-success-metrics">4. Business Objectives and Success Metrics</h2>
<h3 id="primary-business-objectives">4.1 Primary Business Objectives</h3>
<p><strong>Objective 1: Market Leadership in AI Financial Analytics</strong> - Achieve 20% market share in enterprise spend analytics segment within 3 years - Establish platform as industry standard for AI-powered financial optimization</p>
<p><strong>Objective 2: Operational Excellence</strong> - Process $50B+ in annual spend across client base with 99.9% uptime - Maintain sub-3 second response times for analytics queries and dashboards</p>
<p><strong>Objective 3: Customer Success</strong> - Achieve 98% customer retention rate and 70+ Net Promoter Score - Generate $250M ARR within 5 years with 40% gross margins</p>
<p><strong>Objective 4: Financial Impact</strong> - Deliver average 15% cost savings for enterprise clients - Reduce financial processing costs by 30% through automation</p>
<h3 id="key-performance-indicators-kpis">4.2 Key Performance Indicators (KPIs)</h3>
<p><strong>Efficiency Metrics:</strong> - Manual processing time reduction: Target 30% improvement - Expense categorization automation: Target 90% automated classification - Budget cycle time: Target 50% reduction in planning and forecasting cycles</p>
<p><strong>Accuracy Metrics:</strong> - Expense categorization accuracy: Target 90% correct classification - Fraud detection accuracy: Target 95% fraud identification with &lt;2% false positives - Forecast accuracy: Target 85% accuracy for quarterly financial forecasts</p>
<p><strong>Financial Impact Metrics:</strong> - Cost savings identification: Target 15% of total spend under management - ROI for customers: Target 300% ROI within 18 months of implementation - Revenue per customer: Target $500K average annual contract value</p>
<p><strong>Compliance Metrics:</strong> - Policy compliance rate: Target 95% adherence to financial policies - Audit readiness: Target 100% audit trail completeness - Regulatory compliance: Target zero compliance violations</p>
<h2 id="core-product-features-and-capabilities">5. Core Product Features and Capabilities</h2>
<h3 id="intelligent-expense-management">5.1 Intelligent Expense Management</h3>
<ul>
<li><strong>AI-Powered Categorization</strong>: Automated expense classification using ML and NLP</li>
<li><strong>Receipt Processing</strong>: OCR and intelligent data extraction from receipts and invoices</li>
<li><strong>Policy Compliance</strong>: Real-time policy checking with automated approval workflows</li>
<li><strong>Duplicate Detection</strong>: Advanced algorithms to identify and prevent duplicate expenses</li>
</ul>
<h3 id="real-time-spend-analytics">5.2 Real-Time Spend Analytics</h3>
<ul>
<li><strong>Interactive Dashboards</strong>: Executive and operational dashboards with drill-down capabilities</li>
<li><strong>Multi-Dimensional Analysis</strong>: Spend analysis by department, vendor, category, time period</li>
<li><strong>Trend Analysis</strong>: Historical spending patterns with predictive trend identification</li>
<li><strong>Comparative Analytics</strong>: Benchmarking against industry standards and peer organizations</li>
</ul>
<h3 id="advanced-anomaly-detection">5.3 Advanced Anomaly Detection</h3>
<ul>
<li><strong>Statistical Anomaly Detection</strong>: Machine learning algorithms for unusual spending pattern identification</li>
<li><strong>Fraud Detection</strong>: Behavioral analysis and rule-based fraud detection systems</li>
<li><strong>Vendor Anomalies</strong>: Unusual vendor behavior and pricing anomaly identification</li>
<li><strong>Employee Expense Anomalies</strong>: Suspicious expense patterns and policy violations</li>
</ul>
<h3 id="predictive-financial-forecasting">5.4 Predictive Financial Forecasting</h3>
<ul>
<li><strong>Budget Forecasting</strong>: AI-powered budget planning with scenario modeling</li>
<li><strong>Spend Prediction</strong>: Machine learning models for future spend prediction</li>
<li><strong>Cash Flow Forecasting</strong>: Predictive cash flow analysis with confidence intervals</li>
<li><strong>Seasonal Adjustment</strong>: Automatic seasonal pattern recognition and adjustment</li>
</ul>
<h3 id="vendor-and-contract-management">5.5 Vendor and Contract Management</h3>
<ul>
<li><strong>Vendor Performance Analytics</strong>: Comprehensive vendor spend and performance analysis</li>
<li><strong>Contract Compliance</strong>: Automated contract term monitoring and compliance tracking</li>
<li><strong>Savings Opportunity Identification</strong>: AI-driven vendor consolidation and negotiation recommendations</li>
<li><strong>Supplier Risk Assessment</strong>: Financial and operational risk analysis for key suppliers</li>
</ul>
<h3 id="compliance-and-audit-management">5.6 Compliance and Audit Management</h3>
<ul>
<li><strong>Automated Compliance Monitoring</strong>: Real-time policy and regulatory compliance checking</li>
<li><strong>Audit Trail Generation</strong>: Complete audit trails for all financial transactions and decisions</li>
<li><strong>Regulatory Reporting</strong>: Automated generation of regulatory reports and filings</li>
<li><strong>Risk Assessment</strong>: Continuous financial risk monitoring and alerting</li>
</ul>
<h2 id="technical-requirements-and-constraints">6. Technical Requirements and Constraints</h2>
<h3 id="performance-requirements">6.1 Performance Requirements</h3>
<ul>
<li><strong>Response Time</strong>: &lt;3 seconds for dashboard loading and analytics queries</li>
<li><strong>Throughput</strong>: Support 100,000+ transactions per minute with real-time processing</li>
<li><strong>Availability</strong>: 99.9% uptime with &lt;2 hours planned maintenance per month</li>
<li><strong>Scalability</strong>: Auto-scale to handle 10x transaction volume during month-end processing</li>
</ul>
<h3 id="integration-requirements">6.2 Integration Requirements</h3>
<ul>
<li><strong>ERP Integration</strong>: Seamless connectivity with SAP, Oracle, Microsoft Dynamics, NetSuite</li>
<li><strong>Banking Integration</strong>: Real-time bank feed integration for transaction data</li>
<li><strong>Procurement Systems</strong>: Integration with procurement platforms and e-procurement tools</li>
<li><strong>Expense Management</strong>: Integration with existing expense management and travel systems</li>
</ul>
<h3 id="security-and-compliance">6.3 Security and Compliance</h3>
<ul>
<li><strong>Data Protection</strong>: SOX compliance, GDPR, and regional data protection regulations</li>
<li><strong>Financial Regulations</strong>: GAAP, IFRS, and country-specific accounting standards compliance</li>
<li><strong>Data Encryption</strong>: AES-256 encryption at rest and TLS 1.3 in transit</li>
<li><strong>Access Control</strong>: Role-based access with multi-factor authentication and audit logging</li>
</ul>
<h3 id="technology-constraints">6.4 Technology Constraints</h3>
<ul>
<li><strong>Cloud Platform</strong>: Multi-cloud deployment (AWS, Azure, GCP) for redundancy and compliance</li>
<li><strong>AI/ML Stack</strong>: Support for TensorFlow, PyTorch, and scikit-learn frameworks</li>
<li><strong>Database</strong>: Support for both transactional and analytical databases (OLTP/OLAP)</li>
<li><strong>API Standards</strong>: RESTful APIs with GraphQL support for complex queries</li>
</ul>
<h2 id="business-model-and-monetization">7. Business Model and Monetization</h2>
<h3 id="revenue-streams">7.1 Revenue Streams</h3>
<p><strong>Primary Revenue:</strong> - <strong>SaaS Subscriptions</strong>: Tiered pricing based on annual spend under management - <strong>Transaction-Based Pricing</strong>: Per-transaction fees for high-volume processing - <strong>Professional Services</strong>: Implementation, training, and customization services</p>
<p><strong>Secondary Revenue:</strong> - <strong>Data Insights</strong>: Anonymized market intelligence and benchmarking reports - <strong>Third-Party Integrations</strong>: Revenue sharing from integrated financial service providers - <strong>Advanced Analytics</strong>: Premium analytics modules and custom reporting solutions</p>
<h3 id="pricing-strategy">7.2 Pricing Strategy</h3>
<p><strong>Starter Plan</strong>: $10K/month for companies with &lt;$50M annual spend - Basic analytics and categorization features - Standard integrations and support</p>
<p><strong>Professional Plan</strong>: $50K/month for companies with $50M-$500M annual spend - Advanced AI features and predictive analytics - Premium integrations and priority support</p>
<p><strong>Enterprise Plan</strong>: Custom pricing for companies with &gt;$500M annual spend - Full feature suite with customization - Dedicated success management and SLA guarantees</p>
<h3 id="go-to-market-strategy">7.3 Go-to-Market Strategy</h3>
<ul>
<li><strong>Direct Sales</strong>: Enterprise sales team targeting Fortune 1000 companies</li>
<li><strong>Partner Channel</strong>: Integration partnerships with major ERP and procurement vendors</li>
<li><strong>Digital Marketing</strong>: Content marketing, webinars, and targeted advertising to finance professionals</li>
<li><strong>Industry Events</strong>: Presence at major finance and procurement conferences</li>
</ul>
<h2 id="risk-assessment-and-mitigation">8. Risk Assessment and Mitigation</h2>
<h3 id="technical-risks">8.1 Technical Risks</h3>
<p><strong>Risk</strong>: Data quality issues affecting AI accuracy <strong>Mitigation</strong>: Comprehensive data validation, cleansing pipelines, and quality monitoring</p>
<p><strong>Risk</strong>: Integration complexity with legacy financial systems <strong>Mitigation</strong>: Standardized APIs, extensive testing, and phased integration approach</p>
<p><strong>Risk</strong>: Scalability challenges during peak processing periods <strong>Mitigation</strong>: Cloud-native architecture, auto-scaling, and performance monitoring</p>
<h3 id="business-risks">8.2 Business Risks</h3>
<p><strong>Risk</strong>: Regulatory changes affecting compliance requirements <strong>Mitigation</strong>: Legal advisory board, compliance monitoring, and adaptable architecture</p>
<p><strong>Risk</strong>: Economic downturn reducing IT spending <strong>Mitigation</strong>: ROI-focused value proposition, flexible pricing, and cost optimization features</p>
<p><strong>Risk</strong>: Competitive pressure from established ERP vendors <strong>Mitigation</strong>: Continuous innovation, strong IP portfolio, and customer lock-in through value delivery</p>
<h3 id="operational-risks">8.3 Operational Risks</h3>
<p><strong>Risk</strong>: Data security breaches affecting financial information <strong>Mitigation</strong>: Zero-trust security architecture, encryption, and regular security audits</p>
<p><strong>Risk</strong>: Key talent acquisition and retention challenges <strong>Mitigation</strong>: Competitive compensation, remote work options, and equity participation</p>
<h2 id="success-criteria-and-validation">9. Success Criteria and Validation</h2>
<h3 id="product-market-fit-indicators">9.1 Product-Market Fit Indicators</h3>
<ul>
<li><strong>Customer Retention</strong>: &gt;95% annual retention rate for enterprise customers</li>
<li><strong>Usage Growth</strong>: &gt;40% month-over-month growth in transaction volume processed</li>
<li><strong>Customer Satisfaction</strong>: Net Promoter Score &gt;70 with finance executives</li>
<li><strong>Market Recognition</strong>: Recognition as leader in industry analyst reports</li>
</ul>
<h3 id="financial-success-metrics">9.2 Financial Success Metrics</h3>
<ul>
<li><strong>Revenue Growth</strong>: Achieve $50M ARR by end of year 2</li>
<li><strong>Unit Economics</strong>: LTV:CAC ratio &gt;4:1 within 24 months</li>
<li><strong>Profitability</strong>: Achieve positive EBITDA by end of year 3</li>
<li><strong>Market Valuation</strong>: Achieve $1B+ valuation within 5 years</li>
</ul>
<h3 id="operational-success-metrics">9.3 Operational Success Metrics</h3>
<ul>
<li><strong>Cost Savings</strong>: Deliver average 15% cost savings for enterprise clients</li>
<li><strong>Processing Efficiency</strong>: 30% reduction in manual financial processing time</li>
<li><strong>Compliance</strong>: 95% policy compliance rate across all client organizations</li>
<li><strong>Industry Impact</strong>: Drive adoption of AI-powered financial analytics across industry</li>
</ul>
<p>This PRD establishes the foundation for developing a comprehensive AI-powered finance spend analytics and optimization platform that addresses critical market needs while ensuring regulatory compliance and delivering measurable business value. # Functional Requirements Document (FRD) ## Finance Spend Analytics and Optimization Platform</p>
<p><em>Building upon PRD for detailed functional specifications</em></p>
<h2 id="etvx-framework-1">ETVX Framework</h2>
<h3 id="entry-criteria-1">ENTRY CRITERIA</h3>
<ul>
<li>✅ PRD completed with product vision, business objectives, and success metrics</li>
<li>✅ User personas defined (CFO, Finance Controller, Financial Analyst, Procurement Manager)</li>
<li>✅ Core product features identified (Expense Management, Analytics, Anomaly Detection, Forecasting)</li>
<li>✅ Technical requirements and constraints established</li>
<li>✅ Business model and monetization strategy defined</li>
<li>✅ Market analysis and competitive positioning completed</li>
</ul>
<h3 id="task-1">TASK</h3>
<p>Define comprehensive functional requirements that specify exactly how the finance spend analytics platform will operate, detailing all system behaviors, user interactions, data processing workflows, AI algorithms, integration patterns, and business logic needed to achieve the product vision and success metrics.</p>
<h3 id="verification-validation-1">VERIFICATION &amp; VALIDATION</h3>
<p><strong>Verification Checklist:</strong> - [ ] All PRD features have corresponding detailed functional requirements - [ ] User workflows cover all personas and use cases from PRD - [ ] AI/ML requirements support 90% categorization accuracy and 15% cost savings goals - [ ] Integration requirements support ERP, banking, and procurement system connectivity - [ ] Performance requirements align with &lt;3s response time and 99.9% uptime targets - [ ] Compliance requirements address SOX, GAAP, IFRS, and data protection regulations</p>
<p><strong>Validation Criteria:</strong> - [ ] Requirements reviewed with finance professionals and CFO advisory board - [ ] AI algorithm specifications validated with data science team - [ ] Integration requirements confirmed with ERP and financial system partners - [ ] User experience workflows validated through finance team research and prototyping - [ ] Compliance requirements reviewed with legal and regulatory experts - [ ] Performance specifications validated through technical feasibility analysis</p>
<h3 id="exit-criteria-1">EXIT CRITERIA</h3>
<ul>
<li>✅ Complete functional specification for all system components</li>
<li>✅ Detailed user workflows and interaction patterns documented</li>
<li>✅ AI/ML algorithm requirements specified with performance criteria</li>
<li>✅ Integration and API requirements defined for all external systems</li>
<li>✅ Data management and security requirements established</li>
<li>✅ Foundation prepared for non-functional requirements development</li>
</ul>
<hr />
<h3 id="reference-to-previous-documents">Reference to Previous Documents</h3>
<p>This FRD builds upon the <strong>PRD</strong> foundation: - <strong>PRD Product Vision</strong> → Functional requirements for AI-powered finance spend analytics platform - <strong>PRD Success Metrics</strong> → Requirements supporting 30% processing time reduction, 15% cost savings, 90% accuracy - <strong>PRD User Personas</strong> → Functional workflows for CFOs, controllers, analysts, and procurement managers - <strong>PRD Core Features</strong> → Detailed functional specifications for expense management, analytics, anomaly detection, forecasting - <strong>PRD Technical Requirements</strong> → Functional requirements for performance, integration, security, and compliance</p>
<h2 id="intelligent-expense-management-module">1. Intelligent Expense Management Module</h2>
<h3 id="fr-001-automated-expense-categorization">FR-001: Automated Expense Categorization</h3>
<p><strong>Description</strong>: System shall automatically categorize expenses using AI and machine learning <strong>Priority</strong>: High <strong>Acceptance Criteria</strong>: - Achieve 90% accuracy in expense categorization across 500+ predefined categories - Support custom category creation and training with user feedback - Handle multi-line invoices with different categories per line item - Process expenses in real-time with &lt;5 second categorization time - Maintain audit trail of categorization decisions and confidence scores</p>
<h3 id="fr-002-receipt-and-invoice-processing">FR-002: Receipt and Invoice Processing</h3>
<p><strong>Description</strong>: System shall extract structured data from receipts and invoices using OCR and NLP <strong>Priority</strong>: High <strong>Acceptance Criteria</strong>: - Support PDF, JPG, PNG, and other common image formats - Extract vendor, date, amount, tax, and line item details with 95% accuracy - Handle handwritten receipts and low-quality images - Support multiple languages and international formats - Validate extracted data against business rules and flag discrepancies</p>
<h3 id="fr-003-duplicate-expense-detection">FR-003: Duplicate Expense Detection</h3>
<p><strong>Description</strong>: System shall identify and prevent duplicate expense submissions <strong>Priority</strong>: High <strong>Acceptance Criteria</strong>: - Detect duplicates based on amount, date, vendor, and description similarity - Use fuzzy matching algorithms to handle variations in data entry - Flag potential duplicates for manual review with confidence scores - Support bulk duplicate resolution with batch processing - Maintain duplicate detection history for audit purposes</p>
<h3 id="fr-004-policy-compliance-engine">FR-004: Policy Compliance Engine</h3>
<p><strong>Description</strong>: System shall enforce expense policies and approval workflows automatically <strong>Priority</strong>: High <strong>Acceptance Criteria</strong>: - Configure complex policy rules based on amount, category, employee level, and department - Support multi-level approval workflows with delegation and escalation - Real-time policy checking during expense submission - Generate policy violation reports with detailed explanations - Support policy exceptions with proper authorization and documentation</p>
<h3 id="fr-005-expense-approval-workflow">FR-005: Expense Approval Workflow</h3>
<p><strong>Description</strong>: System shall manage expense approval processes with automated routing <strong>Priority</strong>: Medium <strong>Acceptance Criteria</strong>: - Route expenses to appropriate approvers based on configurable rules - Support parallel and sequential approval processes - Send automated notifications and reminders to approvers - Enable mobile approval with digital signatures - Track approval times and bottlenecks for process optimization</p>
<h2 id="real-time-spend-analytics-module">2. Real-Time Spend Analytics Module</h2>
<h3 id="fr-006-executive-dashboard">FR-006: Executive Dashboard</h3>
<p><strong>Description</strong>: System shall provide real-time executive dashboards with key financial metrics <strong>Priority</strong>: High <strong>Acceptance Criteria</strong>: - Display total spend, budget variance, and savings opportunities in real-time - Support drill-down from summary to detailed transaction level - Provide customizable widgets and layout options - Update data with &lt;30 second latency from source systems - Export dashboard data to PDF and Excel formats</p>
<h3 id="fr-007-multi-dimensional-spend-analysis">FR-007: Multi-Dimensional Spend Analysis</h3>
<p><strong>Description</strong>: System shall enable analysis of spend across multiple dimensions <strong>Priority</strong>: High <strong>Acceptance Criteria</strong>: - Analyze spend by department, cost center, vendor, category, and time period - Support cross-dimensional filtering and comparison - Provide year-over-year and period-over-period variance analysis - Enable custom dimension creation and hierarchical grouping - Support ad-hoc query creation with drag-and-drop interface</p>
<h3 id="fr-008-trend-analysis-and-visualization">FR-008: Trend Analysis and Visualization</h3>
<p><strong>Description</strong>: System shall identify and visualize spending trends and patterns <strong>Priority</strong>: Medium <strong>Acceptance Criteria</strong>: - Detect seasonal patterns and cyclical trends in spending data - Provide interactive charts and graphs with zoom and filter capabilities - Support multiple visualization types (line, bar, pie, heat map, scatter plot) - Enable trend projection and forecasting visualization - Allow custom time period selection and comparison</p>
<h3 id="fr-009-benchmarking-and-comparative-analysis">FR-009: Benchmarking and Comparative Analysis</h3>
<p><strong>Description</strong>: System shall provide benchmarking against industry standards and peer organizations <strong>Priority</strong>: Medium <strong>Acceptance Criteria</strong>: - Compare spend metrics against industry benchmarks by sector and company size - Provide peer group analysis for similar organizations - Identify areas where spending is above or below market rates - Support custom benchmark creation and comparison - Generate benchmarking reports with actionable insights</p>
<h3 id="fr-010-real-time-alerting-system">FR-010: Real-Time Alerting System</h3>
<p><strong>Description</strong>: System shall provide configurable alerts for spending anomalies and thresholds <strong>Priority</strong>: High <strong>Acceptance Criteria</strong>: - Configure alerts based on spend thresholds, variance limits, and anomaly detection - Support multiple notification channels (email, SMS, in-app, webhook) - Enable alert escalation and acknowledgment workflows - Provide alert history and resolution tracking - Support bulk alert management and suppression rules</p>
<h2 id="advanced-anomaly-detection-module">3. Advanced Anomaly Detection Module</h2>
<h3 id="fr-011-statistical-anomaly-detection">FR-011: Statistical Anomaly Detection</h3>
<p><strong>Description</strong>: System shall detect statistical anomalies in spending patterns using machine learning <strong>Priority</strong>: High <strong>Acceptance Criteria</strong>: - Identify outliers in spending amounts, frequency, and timing - Use multiple statistical methods (Z-score, IQR, isolation forest, LSTM) - Adapt to seasonal patterns and business cycles - Provide anomaly scores and confidence levels - Support model retraining with new data and feedback</p>
<h3 id="fr-012-fraud-detection-engine">FR-012: Fraud Detection Engine</h3>
<p><strong>Description</strong>: System shall detect potential fraudulent activities and policy violations <strong>Priority</strong>: High <strong>Acceptance Criteria</strong>: - Identify suspicious expense patterns and behaviors - Detect potential vendor fraud and billing irregularities - Flag unusual employee expense patterns and policy violations - Use behavioral analysis and rule-based detection methods - Generate fraud investigation reports with supporting evidence</p>
<h3 id="fr-013-vendor-anomaly-detection">FR-013: Vendor Anomaly Detection</h3>
<p><strong>Description</strong>: System shall monitor vendor behavior and identify unusual patterns <strong>Priority</strong>: Medium <strong>Acceptance Criteria</strong>: - Detect unusual pricing changes and billing patterns from vendors - Identify potential vendor collusion and bid manipulation - Monitor vendor performance metrics and service level deviations - Flag new vendors with unusual characteristics or risk factors - Provide vendor risk scoring and monitoring dashboards</p>
<h3 id="fr-014-employee-expense-anomaly-detection">FR-014: Employee Expense Anomaly Detection</h3>
<p><strong>Description</strong>: System shall monitor employee expense patterns for anomalies <strong>Priority</strong>: Medium <strong>Acceptance Criteria</strong>: - Detect unusual expense submission patterns by employee - Identify potential policy violations and expense abuse - Monitor travel and entertainment expenses for irregularities - Flag expenses that deviate from historical patterns - Provide employee expense behavior analysis and reporting</p>
<h3 id="fr-015-anomaly-investigation-workflow">FR-015: Anomaly Investigation Workflow</h3>
<p><strong>Description</strong>: System shall provide tools for investigating and resolving detected anomalies <strong>Priority</strong>: Medium <strong>Acceptance Criteria</strong>: - Create investigation cases with assigned investigators - Provide investigation workflow with status tracking - Enable evidence collection and documentation - Support collaborative investigation with comments and attachments - Generate investigation reports and resolution summaries</p>
<h2 id="predictive-financial-forecasting-module">4. Predictive Financial Forecasting Module</h2>
<h3 id="fr-016-budget-forecasting-engine">FR-016: Budget Forecasting Engine</h3>
<p><strong>Description</strong>: System shall provide AI-powered budget planning and forecasting capabilities <strong>Priority</strong>: High <strong>Acceptance Criteria</strong>: - Generate budget forecasts based on historical data and trends - Support multiple forecasting models (linear regression, ARIMA, neural networks) - Enable scenario modeling with different assumptions and variables - Provide confidence intervals and forecast accuracy metrics - Support collaborative budget planning with multiple stakeholders</p>
<h3 id="fr-017-spend-prediction-models">FR-017: Spend Prediction Models</h3>
<p><strong>Description</strong>: System shall predict future spending patterns and requirements <strong>Priority</strong>: High <strong>Acceptance Criteria</strong>: - Predict monthly and quarterly spend by category and department - Factor in seasonality, business growth, and external economic indicators - Provide early warning for budget overruns and shortfalls - Support what-if analysis for different business scenarios - Enable model comparison and selection based on accuracy metrics</p>
<h3 id="fr-018-cash-flow-forecasting">FR-018: Cash Flow Forecasting</h3>
<p><strong>Description</strong>: System shall forecast cash flow requirements based on spending patterns <strong>Priority</strong>: Medium <strong>Acceptance Criteria</strong>: - Predict cash flow needs based on historical payment patterns - Factor in payment terms, seasonal variations, and business cycles - Provide rolling forecasts with different time horizons - Support sensitivity analysis for key variables - Generate cash flow reports for treasury and finance planning</p>
<h3 id="fr-019-seasonal-adjustment-and-modeling">FR-019: Seasonal Adjustment and Modeling</h3>
<p><strong>Description</strong>: System shall automatically detect and adjust for seasonal patterns <strong>Priority</strong>: Medium <strong>Acceptance Criteria</strong>: - Identify seasonal patterns in spending data automatically - Apply seasonal adjustments to forecasts and budgets - Support multiple seasonal patterns (monthly, quarterly, annual) - Provide seasonal decomposition analysis and visualization - Enable manual override of seasonal adjustments when needed</p>
<h3 id="fr-020-forecast-accuracy-monitoring">FR-020: Forecast Accuracy Monitoring</h3>
<p><strong>Description</strong>: System shall monitor and improve forecast accuracy over time <strong>Priority</strong>: Low <strong>Acceptance Criteria</strong>: - Track forecast accuracy against actual results - Provide forecast error analysis and improvement recommendations - Support model retraining based on accuracy feedback - Generate forecast performance reports and dashboards - Enable comparison of different forecasting methods</p>
<h2 id="vendor-and-contract-management-module">5. Vendor and Contract Management Module</h2>
<h3 id="fr-021-vendor-spend-analytics">FR-021: Vendor Spend Analytics</h3>
<p><strong>Description</strong>: System shall provide comprehensive vendor spend analysis and insights <strong>Priority</strong>: High <strong>Acceptance Criteria</strong>: - Analyze total spend by vendor with trend analysis - Identify top vendors by spend volume and transaction count - Provide vendor performance metrics and scorecards - Support vendor comparison and benchmarking analysis - Generate vendor spend reports with drill-down capabilities</p>
<h3 id="fr-022-contract-compliance-monitoring">FR-022: Contract Compliance Monitoring</h3>
<p><strong>Description</strong>: System shall monitor compliance with vendor contracts and agreements <strong>Priority</strong>: High <strong>Acceptance Criteria</strong>: - Track spending against contract terms and limits - Monitor pricing compliance with negotiated rates - Alert on contract violations and discrepancies - Support contract milestone and renewal tracking - Generate contract compliance reports and dashboards</p>
<h3 id="fr-023-vendor-consolidation-analysis">FR-023: Vendor Consolidation Analysis</h3>
<p><strong>Description</strong>: System shall identify opportunities for vendor consolidation and optimization <strong>Priority</strong>: Medium <strong>Acceptance Criteria</strong>: - Identify vendors providing similar services or products - Analyze potential savings from vendor consolidation - Provide consolidation recommendations with impact analysis - Support vendor rationalization planning and execution - Track consolidation benefits and savings realization</p>
<h3 id="fr-024-supplier-risk-assessment">FR-024: Supplier Risk Assessment</h3>
<p><strong>Description</strong>: System shall assess and monitor financial and operational risks of key suppliers <strong>Priority</strong>: Medium <strong>Acceptance Criteria</strong>: - Evaluate vendor financial health and stability - Monitor vendor performance and service level metrics - Assess geographic and concentration risks - Provide risk scoring and monitoring dashboards - Generate supplier risk reports and mitigation recommendations</p>
<h3 id="fr-025-vendor-performance-management">FR-025: Vendor Performance Management</h3>
<p><strong>Description</strong>: System shall track and manage vendor performance metrics <strong>Priority</strong>: Medium <strong>Acceptance Criteria</strong>: - Define and track key performance indicators for vendors - Support vendor scorecards and performance reviews - Enable vendor feedback and rating collection - Provide performance trend analysis and benchmarking - Generate vendor performance reports and improvement plans</p>
<h2 id="compliance-and-audit-management-module">6. Compliance and Audit Management Module</h2>
<h3 id="fr-026-automated-policy-compliance">FR-026: Automated Policy Compliance</h3>
<p><strong>Description</strong>: System shall automatically monitor compliance with financial policies <strong>Priority</strong>: High <strong>Acceptance Criteria</strong>: - Configure and enforce complex financial policies and rules - Monitor compliance in real-time with automated alerts - Generate compliance reports and violation summaries - Support policy exception handling and approval workflows - Maintain complete audit trail of policy decisions and overrides</p>
<h3 id="fr-027-regulatory-compliance-monitoring">FR-027: Regulatory Compliance Monitoring</h3>
<p><strong>Description</strong>: System shall ensure compliance with financial regulations and standards <strong>Priority</strong>: High <strong>Acceptance Criteria</strong>: - Support SOX compliance with proper controls and documentation - Ensure GAAP and IFRS compliance in financial reporting - Monitor compliance with tax regulations and requirements - Support industry-specific regulatory requirements - Generate regulatory compliance reports and certifications</p>
<h3 id="fr-028-audit-trail-management">FR-028: Audit Trail Management</h3>
<p><strong>Description</strong>: System shall maintain comprehensive audit trails for all financial transactions <strong>Priority</strong>: High <strong>Acceptance Criteria</strong>: - Record all system activities with user, timestamp, and action details - Maintain immutable audit logs with tamper-proof storage - Support audit trail search and filtering capabilities - Provide audit trail reports for internal and external audits - Ensure audit trail retention according to regulatory requirements</p>
<h3 id="fr-029-internal-controls-framework">FR-029: Internal Controls Framework</h3>
<p><strong>Description</strong>: System shall implement and monitor internal financial controls <strong>Priority</strong>: Medium <strong>Acceptance Criteria</strong>: - Define and implement segregation of duties controls - Monitor authorization limits and approval hierarchies - Detect control violations and weaknesses - Support control testing and validation processes - Generate internal controls reports and assessments</p>
<h3 id="fr-030-external-audit-support">FR-030: External Audit Support</h3>
<p><strong>Description</strong>: System shall provide tools and reports to support external audits <strong>Priority</strong>: Medium <strong>Acceptance Criteria</strong>: - Generate audit-ready reports and documentation - Support auditor access with controlled permissions - Provide audit sampling and testing capabilities - Enable audit finding tracking and resolution - Maintain audit history and documentation repository</p>
<h2 id="integration-and-data-management-module">7. Integration and Data Management Module</h2>
<h3 id="fr-031-erp-system-integration">FR-031: ERP System Integration</h3>
<p><strong>Description</strong>: System shall integrate seamlessly with major ERP systems <strong>Priority</strong>: High <strong>Acceptance Criteria</strong>: - Support real-time and batch integration with SAP, Oracle, Microsoft Dynamics - Synchronize chart of accounts, cost centers, and organizational structure - Import financial transactions and master data automatically - Handle data mapping and transformation between systems - Provide integration monitoring and error handling</p>
<h3 id="fr-032-banking-system-integration">FR-032: Banking System Integration</h3>
<p><strong>Description</strong>: System shall integrate with banking systems for transaction data <strong>Priority</strong>: High <strong>Acceptance Criteria</strong>: - Connect to major banks via secure APIs and file transfers - Import bank transactions and statements automatically - Support multiple currencies and international banking formats - Reconcile bank transactions with internal financial data - Provide bank integration status monitoring and alerts</p>
<h3 id="fr-033-procurement-system-integration">FR-033: Procurement System Integration</h3>
<p><strong>Description</strong>: System shall integrate with procurement and purchasing systems <strong>Priority</strong>: Medium <strong>Acceptance Criteria</strong>: - Import purchase orders, contracts, and vendor master data - Synchronize procurement workflows and approval processes - Support three-way matching (PO, receipt, invoice) - Integrate with e-procurement platforms and catalogs - Provide procurement data validation and quality checks</p>
<h3 id="fr-034-expense-management-integration">FR-034: Expense Management Integration</h3>
<p><strong>Description</strong>: System shall integrate with existing expense management systems <strong>Priority</strong>: Medium <strong>Acceptance Criteria</strong>: - Import expense reports and reimbursement data - Synchronize employee expense policies and limits - Support expense workflow integration and status updates - Provide expense data enrichment and categorization - Enable seamless user experience across systems</p>
<h3 id="fr-035-third-party-data-integration">FR-035: Third-Party Data Integration</h3>
<p><strong>Description</strong>: System shall integrate with external data sources for enrichment <strong>Priority</strong>: Low <strong>Acceptance Criteria</strong>: - Import market pricing data for benchmarking - Integrate with credit rating agencies for vendor risk assessment - Support economic indicator data for forecasting models - Connect to industry benchmark databases - Provide data quality validation and cleansing</p>
<h2 id="mobile-and-user-experience-module">8. Mobile and User Experience Module</h2>
<h3 id="fr-036-mobile-executive-dashboard">FR-036: Mobile Executive Dashboard</h3>
<p><strong>Description</strong>: System shall provide mobile dashboard for executives and managers <strong>Priority</strong>: High <strong>Acceptance Criteria</strong>: - Display key financial metrics and KPIs on mobile devices - Support touch-based navigation and drill-down capabilities - Provide offline access to critical dashboard data - Enable push notifications for important alerts and updates - Support both iOS and Android platforms</p>
<h3 id="fr-037-mobile-expense-approval">FR-037: Mobile Expense Approval</h3>
<p><strong>Description</strong>: System shall enable expense approval workflows on mobile devices <strong>Priority</strong>: High <strong>Acceptance Criteria</strong>: - Display expense details and supporting documentation on mobile - Enable one-click approval and rejection with comments - Support digital signatures and authentication - Provide approval queue management and prioritization - Send push notifications for pending approvals</p>
<h3 id="fr-038-mobile-analytics-and-reporting">FR-038: Mobile Analytics and Reporting</h3>
<p><strong>Description</strong>: System shall provide mobile access to analytics and reports <strong>Priority</strong>: Medium <strong>Acceptance Criteria</strong>: - Display interactive charts and graphs optimized for mobile - Support touch-based filtering and data exploration - Enable report sharing via email and messaging - Provide offline report viewing capabilities - Support mobile-optimized report formats</p>
<h3 id="fr-039-user-personalization">FR-039: User Personalization</h3>
<p><strong>Description</strong>: System shall support user personalization and customization <strong>Priority</strong>: Medium <strong>Acceptance Criteria</strong>: - Enable custom dashboard creation and widget configuration - Support personalized alert and notification preferences - Provide role-based interface customization - Enable saved searches and favorite reports - Support user preference synchronization across devices</p>
<h3 id="fr-040-collaboration-features">FR-040: Collaboration Features</h3>
<p><strong>Description</strong>: System shall provide collaboration tools for financial teams <strong>Priority</strong>: Low <strong>Acceptance Criteria</strong>: - Enable commenting and annotation on reports and transactions - Support shared dashboards and collaborative analysis - Provide workflow collaboration with task assignment - Enable document sharing and version control - Support team communication and messaging integration</p>
<p>This FRD provides comprehensive functional specifications that build upon the PRD foundation, ensuring all system behaviors and requirements are clearly defined for successful implementation of the finance spend analytics platform. # Non-Functional Requirements Document (NFRD) ## Finance Spend Analytics and Optimization Platform</p>
<p><em>Building upon PRD and FRD for comprehensive system quality attributes</em></p>
<h2 id="etvx-framework-2">ETVX Framework</h2>
<h3 id="entry-criteria-2">ENTRY CRITERIA</h3>
<ul>
<li>✅ PRD completed with business objectives, success metrics, and technical constraints</li>
<li>✅ FRD completed with 40 functional requirements across all system modules</li>
<li>✅ User personas and workflows defined for CFOs, controllers, analysts, and procurement managers</li>
<li>✅ Core system modules specified (Expense Management, Analytics, Anomaly Detection, Forecasting, Vendor Management, Compliance, Integration, Mobile)</li>
<li>✅ Integration requirements defined for ERP, banking, procurement, and expense management systems</li>
<li>✅ AI/ML requirements established for 90% categorization accuracy and fraud detection</li>
</ul>
<h3 id="task-2">TASK</h3>
<p>Define comprehensive non-functional requirements that specify system quality attributes, performance characteristics, security requirements, compliance standards, usability criteria, and operational constraints needed to deliver enterprise-grade finance spend analytics platform meeting PRD success metrics and supporting FRD functional capabilities.</p>
<h3 id="verification-validation-2">VERIFICATION &amp; VALIDATION</h3>
<p><strong>Verification Checklist:</strong> - [ ] Performance requirements support PRD targets (&lt;3s response time, 99.9% uptime) - [ ] Security requirements address financial data protection and regulatory compliance - [ ] Scalability requirements support enterprise transaction volumes and user loads - [ ] Reliability requirements ensure business continuity for financial operations - [ ] Compliance requirements cover SOX, GAAP, IFRS, GDPR, and industry regulations - [ ] Usability requirements support all user personas from PRD</p>
<p><strong>Validation Criteria:</strong> - [ ] Performance specifications validated through load testing and benchmarking - [ ] Security requirements reviewed with cybersecurity experts and compliance officers - [ ] Scalability requirements confirmed with enterprise architecture and infrastructure teams - [ ] Reliability requirements validated against business continuity and disaster recovery needs - [ ] Compliance requirements verified with legal and regulatory compliance experts - [ ] Usability requirements validated through user experience research and testing</p>
<h3 id="exit-criteria-2">EXIT CRITERIA</h3>
<ul>
<li>✅ Complete non-functional requirements specification for all quality attributes</li>
<li>✅ Performance, security, and compliance requirements quantified with measurable criteria</li>
<li>✅ Scalability and reliability requirements defined for enterprise deployment</li>
<li>✅ Usability and accessibility requirements established for all user personas</li>
<li>✅ Operational and maintenance requirements specified</li>
<li>✅ Foundation prepared for architecture design and technical specifications</li>
</ul>
<hr />
<h3 id="reference-to-previous-documents-1">Reference to Previous Documents</h3>
<p>This NFRD builds upon <strong>PRD</strong> and <strong>FRD</strong> foundations: - <strong>PRD Success Metrics</strong> → Performance requirements for &lt;3s response time, 99.9% uptime, 90% accuracy - <strong>PRD User Personas</strong> → Usability requirements for CFOs, controllers, analysts, procurement managers - <strong>PRD Technical Constraints</strong> → Security, compliance, and integration requirements - <strong>FRD Functional Modules</strong> → Non-functional requirements for each system component - <strong>FRD Integration Requirements</strong> → Performance and reliability requirements for external system connectivity - <strong>FRD AI/ML Capabilities</strong> → Performance requirements for machine learning algorithms and processing</p>
<h2 id="performance-requirements-1">1. Performance Requirements</h2>
<h3 id="nfr-001-response-time-performance">NFR-001: Response Time Performance</h3>
<p><strong>Category</strong>: Performance <strong>Priority</strong>: High <strong>Requirement</strong>: System shall provide fast response times for all user interactions <strong>Acceptance Criteria</strong>: - Dashboard loading: &lt;3 seconds for executive dashboards with up to 1M transactions - Analytics queries: &lt;5 seconds for complex multi-dimensional analysis - Expense categorization: &lt;2 seconds for individual expense processing - Report generation: &lt;10 seconds for standard reports, &lt;60 seconds for complex analytics - Mobile app response: &lt;2 seconds for all mobile interface interactions <strong>Measurement</strong>: Response time monitoring with 95th percentile targets</p>
<h3 id="nfr-002-system-throughput">NFR-002: System Throughput</h3>
<p><strong>Category</strong>: Performance <strong>Priority</strong>: High <strong>Requirement</strong>: System shall handle high transaction volumes and concurrent users <strong>Acceptance Criteria</strong>: - Transaction processing: 100,000+ transactions per minute during peak periods - Concurrent users: Support 10,000+ simultaneous users without performance degradation - API throughput: 50,000+ API calls per minute with &lt;100ms average response time - Batch processing: Process 1M+ expense records in &lt;30 minutes - Real-time processing: Handle 1,000+ real-time events per second <strong>Measurement</strong>: Load testing with sustained throughput monitoring</p>
<h3 id="nfr-003-database-performance">NFR-003: Database Performance</h3>
<p><strong>Category</strong>: Performance <strong>Priority</strong>: High <strong>Requirement</strong>: Database operations shall meet performance targets for financial data processing <strong>Acceptance Criteria</strong>: - Query performance: &lt;1 second for simple queries, &lt;5 seconds for complex analytics - Data ingestion: 10,000+ records per second for bulk data imports - Index performance: &lt;100ms for indexed lookups on transaction tables - Aggregation queries: &lt;10 seconds for monthly/quarterly spend aggregations - Concurrent connections: Support 1,000+ concurrent database connections <strong>Measurement</strong>: Database performance monitoring and query optimization</p>
<h3 id="nfr-004-aiml-processing-performance">NFR-004: AI/ML Processing Performance</h3>
<p><strong>Category</strong>: Performance <strong>Priority</strong>: High <strong>Requirement</strong>: AI and machine learning operations shall meet real-time processing requirements <strong>Acceptance Criteria</strong>: - Expense categorization: &lt;2 seconds per expense with 90% accuracy - Anomaly detection: &lt;5 seconds for transaction anomaly analysis - Fraud detection: &lt;10 seconds for comprehensive fraud analysis - Predictive modeling: &lt;60 seconds for monthly forecast generation - Model training: Complete model retraining within 4 hours <strong>Measurement</strong>: ML pipeline performance monitoring and accuracy tracking</p>
<h3 id="nfr-005-network-performance">NFR-005: Network Performance</h3>
<p><strong>Category</strong>: Performance <strong>Priority</strong>: Medium <strong>Requirement</strong>: Network operations shall optimize data transfer and minimize latency <strong>Acceptance Criteria</strong>: - API latency: &lt;50ms average response time for API endpoints - File upload: Support 100MB+ file uploads with progress tracking - Data synchronization: &lt;5 minutes for ERP data synchronization - CDN performance: &lt;200ms for static content delivery globally - Bandwidth optimization: Compress data transfers to minimize network usage <strong>Measurement</strong>: Network monitoring and bandwidth utilization tracking</p>
<h2 id="scalability-requirements">2. Scalability Requirements</h2>
<h3 id="nfr-006-horizontal-scalability">NFR-006: Horizontal Scalability</h3>
<p><strong>Category</strong>: Scalability <strong>Priority</strong>: High <strong>Requirement</strong>: System shall scale horizontally to handle increased load and data volume <strong>Acceptance Criteria</strong>: - Auto-scaling: Automatically scale compute resources based on demand - Load balancing: Distribute traffic across multiple application instances - Database sharding: Support horizontal database scaling for transaction data - Microservices scaling: Scale individual services independently based on usage - Geographic scaling: Deploy across multiple regions for global performance <strong>Measurement</strong>: Auto-scaling metrics and resource utilization monitoring</p>
<h3 id="nfr-007-data-volume-scalability">NFR-007: Data Volume Scalability</h3>
<p><strong>Category</strong>: Scalability <strong>Priority</strong>: High <strong>Requirement</strong>: System shall handle growing data volumes without performance degradation <strong>Acceptance Criteria</strong>: - Transaction storage: Support 100M+ transactions per year per customer - Historical data: Maintain 7+ years of historical financial data - Document storage: Handle 10M+ receipts and invoices with full-text search - Analytics data: Support real-time analytics on 1B+ data points - Archive management: Automatically archive old data while maintaining accessibility <strong>Measurement</strong>: Data growth monitoring and storage performance tracking</p>
<h3 id="nfr-008-user-scalability">NFR-008: User Scalability</h3>
<p><strong>Category</strong>: Scalability <strong>Priority</strong>: Medium <strong>Requirement</strong>: System shall support growing user bases and organizational complexity <strong>Acceptance Criteria</strong>: - User capacity: Support 100,000+ users per enterprise deployment - Organizational hierarchy: Handle complex organizational structures with unlimited depth - Role management: Support 1,000+ custom roles and permissions - Multi-tenancy: Isolate data and performance across multiple customer organizations - Session management: Handle 50,000+ concurrent user sessions <strong>Measurement</strong>: User activity monitoring and session performance tracking</p>
<h3 id="nfr-009-integration-scalability">NFR-009: Integration Scalability</h3>
<p><strong>Category</strong>: Scalability <strong>Priority</strong>: Medium <strong>Requirement</strong>: System shall scale integration capabilities for multiple external systems <strong>Acceptance Criteria</strong>: - API connections: Support 100+ simultaneous external system integrations - Data feeds: Handle 1,000+ real-time data feeds from various sources - Message processing: Process 1M+ integration messages per hour - Batch processing: Support parallel processing of multiple large data imports - Error handling: Gracefully handle integration failures without system impact <strong>Measurement</strong>: Integration performance monitoring and error rate tracking</p>
<h3 id="nfr-010-geographic-scalability">NFR-010: Geographic Scalability</h3>
<p><strong>Category</strong>: Scalability <strong>Priority</strong>: Low <strong>Requirement</strong>: System shall support global deployment and multi-region operations <strong>Acceptance Criteria</strong>: - Multi-region deployment: Deploy across 5+ geographic regions - Data locality: Store data in compliance with regional data residency requirements - Latency optimization: &lt;200ms response time for users in all supported regions - Disaster recovery: Maintain operations during regional outages - Currency support: Handle 50+ currencies with real-time exchange rates <strong>Measurement</strong>: Regional performance monitoring and availability tracking</p>
<h2 id="reliability-and-availability-requirements">3. Reliability and Availability Requirements</h2>
<h3 id="nfr-011-system-availability">NFR-011: System Availability</h3>
<p><strong>Category</strong>: Reliability <strong>Priority</strong>: High <strong>Requirement</strong>: System shall maintain high availability for business-critical financial operations <strong>Acceptance Criteria</strong>: - Uptime target: 99.9% availability (8.77 hours downtime per year maximum) - Planned maintenance: &lt;2 hours per month during off-peak hours - Recovery time: &lt;15 minutes recovery time from system failures - Failover capability: Automatic failover to backup systems within 60 seconds - Health monitoring: Continuous system health monitoring with proactive alerting <strong>Measurement</strong>: Uptime monitoring and availability reporting</p>
<h3 id="nfr-012-data-reliability">NFR-012: Data Reliability</h3>
<p><strong>Category</strong>: Reliability <strong>Priority</strong>: High <strong>Requirement</strong>: System shall ensure data integrity and consistency for financial information <strong>Acceptance Criteria</strong>: - Data accuracy: 99.99% data integrity with checksums and validation - Transaction consistency: ACID compliance for all financial transactions - Backup reliability: Daily backups with 99.9% backup success rate - Data recovery: &lt;4 hours for complete data recovery from backups - Corruption detection: Automatic detection and correction of data corruption <strong>Measurement</strong>: Data integrity monitoring and backup verification</p>
<h3 id="nfr-013-fault-tolerance">NFR-013: Fault Tolerance</h3>
<p><strong>Category</strong>: Reliability <strong>Priority</strong>: High <strong>Requirement</strong>: System shall continue operating despite component failures <strong>Acceptance Criteria</strong>: - Component redundancy: No single point of failure in critical system components - Graceful degradation: Continue core operations during partial system failures - Error isolation: Isolate failures to prevent cascading system issues - Recovery mechanisms: Automatic recovery from transient failures - Circuit breakers: Prevent system overload during high error conditions <strong>Measurement</strong>: Failure rate monitoring and recovery time tracking</p>
<h3 id="nfr-014-disaster-recovery">NFR-014: Disaster Recovery</h3>
<p><strong>Category</strong>: Reliability <strong>Priority</strong>: Medium <strong>Requirement</strong>: System shall recover from major disasters and maintain business continuity <strong>Acceptance Criteria</strong>: - Recovery time objective (RTO): &lt;4 hours for full system recovery - Recovery point objective (RPO): &lt;1 hour maximum data loss - Backup sites: Maintain hot standby systems in geographically separate locations - Data replication: Real-time data replication to disaster recovery sites - Recovery testing: Monthly disaster recovery testing and validation <strong>Measurement</strong>: Disaster recovery testing results and compliance reporting</p>
<h3 id="nfr-015-error-handling">NFR-015: Error Handling</h3>
<p><strong>Category</strong>: Reliability <strong>Priority</strong>: Medium <strong>Requirement</strong>: System shall handle errors gracefully and provide meaningful feedback <strong>Acceptance Criteria</strong>: - Error logging: Comprehensive error logging with severity classification - User feedback: Clear error messages with actionable guidance for users - Retry mechanisms: Automatic retry for transient errors with exponential backoff - Error recovery: Automatic recovery from common error conditions - Support escalation: Integration with support systems for critical errors <strong>Measurement</strong>: Error rate monitoring and resolution time tracking</p>
<h2 id="security-requirements">4. Security Requirements</h2>
<h3 id="nfr-016-data-protection">NFR-016: Data Protection</h3>
<p><strong>Category</strong>: Security <strong>Priority</strong>: High <strong>Requirement</strong>: System shall protect sensitive financial data using industry-standard encryption <strong>Acceptance Criteria</strong>: - Encryption at rest: AES-256 encryption for all stored financial data - Encryption in transit: TLS 1.3 for all data communications - Key management: Hardware security modules (HSM) for encryption key management - Data masking: Automatic masking of sensitive data in non-production environments - Secure deletion: Cryptographic erasure for permanent data deletion <strong>Measurement</strong>: Security audits and encryption compliance verification</p>
<h3 id="nfr-017-authentication-and-authorization">NFR-017: Authentication and Authorization</h3>
<p><strong>Category</strong>: Security <strong>Priority</strong>: High <strong>Requirement</strong>: System shall implement robust authentication and authorization mechanisms <strong>Acceptance Criteria</strong>: - Multi-factor authentication: Required MFA for all user accounts - Single sign-on: Integration with enterprise SSO systems (SAML, OAuth 2.0) - Role-based access: Granular permissions based on user roles and responsibilities - Session management: Secure session handling with automatic timeout - Password policies: Enforce strong password requirements and rotation <strong>Measurement</strong>: Authentication success rates and security incident tracking</p>
<h3 id="nfr-018-network-security">NFR-018: Network Security</h3>
<p><strong>Category</strong>: Security <strong>Priority</strong>: High <strong>Requirement</strong>: System shall implement comprehensive network security controls <strong>Acceptance Criteria</strong>: - Firewall protection: Web application firewall (WAF) with DDoS protection - Network segmentation: Isolated network zones for different system components - VPN access: Secure VPN connectivity for administrative access - Intrusion detection: Real-time monitoring for suspicious network activity - API security: OAuth 2.0 and API key management for external integrations <strong>Measurement</strong>: Security monitoring and threat detection metrics</p>
<h3 id="nfr-019-audit-and-compliance">NFR-019: Audit and Compliance</h3>
<p><strong>Category</strong>: Security <strong>Priority</strong>: High <strong>Requirement</strong>: System shall maintain comprehensive audit trails for security and compliance <strong>Acceptance Criteria</strong>: - Activity logging: Log all user activities and system operations - Immutable logs: Tamper-proof audit logs with cryptographic integrity - Log retention: Maintain audit logs for 7+ years per regulatory requirements - Access monitoring: Monitor and alert on privileged access and data access - Compliance reporting: Generate compliance reports for security audits <strong>Measurement</strong>: Audit completeness and compliance verification</p>
<h3 id="nfr-020-vulnerability-management">NFR-020: Vulnerability Management</h3>
<p><strong>Category</strong>: Security <strong>Priority</strong>: Medium <strong>Requirement</strong>: System shall implement proactive vulnerability management and security monitoring <strong>Acceptance Criteria</strong>: - Security scanning: Regular vulnerability scans and penetration testing - Patch management: Timely application of security patches and updates - Threat monitoring: Continuous monitoring for security threats and indicators - Incident response: Documented incident response procedures and escalation - Security training: Regular security awareness training for system users <strong>Measurement</strong>: Vulnerability scan results and security incident metrics</p>
<h2 id="compliance-requirements">5. Compliance Requirements</h2>
<h3 id="nfr-021-financial-regulations-compliance">NFR-021: Financial Regulations Compliance</h3>
<p><strong>Category</strong>: Compliance <strong>Priority</strong>: High <strong>Requirement</strong>: System shall comply with financial regulations and accounting standards <strong>Acceptance Criteria</strong>: - SOX compliance: Implement controls required by Sarbanes-Oxley Act - GAAP compliance: Support Generally Accepted Accounting Principles - IFRS compliance: Support International Financial Reporting Standards - Tax compliance: Support tax reporting requirements for multiple jurisdictions - Industry standards: Comply with industry-specific financial regulations <strong>Measurement</strong>: Compliance audits and regulatory reporting verification</p>
<h3 id="nfr-022-data-privacy-compliance">NFR-022: Data Privacy Compliance</h3>
<p><strong>Category</strong>: Compliance <strong>Priority</strong>: High <strong>Requirement</strong>: System shall comply with data privacy regulations and requirements <strong>Acceptance Criteria</strong>: - GDPR compliance: Support EU General Data Protection Regulation requirements - CCPA compliance: Support California Consumer Privacy Act requirements - Data residency: Store data in compliance with regional data residency laws - Privacy controls: Implement data subject rights (access, portability, deletion) - Consent management: Track and manage user consent for data processing <strong>Measurement</strong>: Privacy compliance audits and data subject request handling</p>
<h3 id="nfr-023-industry-standards-compliance">NFR-023: Industry Standards Compliance</h3>
<p><strong>Category</strong>: Compliance <strong>Priority</strong>: Medium <strong>Requirement</strong>: System shall comply with relevant industry standards and certifications <strong>Acceptance Criteria</strong>: - ISO 27001: Information security management system compliance - SOC 2 Type II: Service organization controls compliance - PCI DSS: Payment card industry data security standards (if applicable) - NIST framework: Cybersecurity framework compliance - Cloud security: Cloud security alliance (CSA) compliance <strong>Measurement</strong>: Certification audits and compliance assessment results</p>
<h3 id="nfr-024-audit-trail-requirements">NFR-024: Audit Trail Requirements</h3>
<p><strong>Category</strong>: Compliance <strong>Priority</strong>: High <strong>Requirement</strong>: System shall maintain comprehensive audit trails for regulatory compliance <strong>Acceptance Criteria</strong>: - Transaction auditing: Complete audit trail for all financial transactions - User activity: Log all user actions with timestamps and user identification - System changes: Track all system configuration and data changes - Data lineage: Maintain data lineage for regulatory reporting - Audit reporting: Generate audit reports for internal and external auditors <strong>Measurement</strong>: Audit trail completeness and regulatory compliance verification</p>
<h3 id="nfr-025-records-retention">NFR-025: Records Retention</h3>
<p><strong>Category</strong>: Compliance <strong>Priority</strong>: Medium <strong>Requirement</strong>: System shall implement appropriate records retention and disposal policies <strong>Acceptance Criteria</strong>: - Retention policies: Configurable retention periods for different data types - Automatic archival: Automatic archival of old records per retention policies - Legal holds: Support legal hold functionality for litigation requirements - Secure disposal: Cryptographic erasure for permanent record deletion - Retention reporting: Generate reports on records retention compliance <strong>Measurement</strong>: Records retention compliance and disposal verification</p>
<h2 id="usability-and-user-experience-requirements">6. Usability and User Experience Requirements</h2>
<h3 id="nfr-026-user-interface-design">NFR-026: User Interface Design</h3>
<p><strong>Category</strong>: Usability <strong>Priority</strong>: High <strong>Requirement</strong>: System shall provide intuitive and efficient user interfaces for all personas <strong>Acceptance Criteria</strong>: - Responsive design: Optimized interfaces for desktop, tablet, and mobile devices - Consistent UI: Consistent design patterns and navigation across all modules - Accessibility: WCAG 2.1 AA compliance for users with disabilities - Customization: Configurable dashboards and interface personalization - Modern design: Contemporary UI design following current best practices <strong>Measurement</strong>: User experience testing and accessibility compliance verification</p>
<h3 id="nfr-027-ease-of-use">NFR-027: Ease of Use</h3>
<p><strong>Category</strong>: Usability <strong>Priority</strong>: High <strong>Requirement</strong>: System shall be easy to learn and use for all user personas <strong>Acceptance Criteria</strong>: - Learning curve: New users productive within 2 hours of training - Task efficiency: Common tasks completable in &lt;5 clicks/steps - Error prevention: Proactive validation and guidance to prevent user errors - Help system: Context-sensitive help and documentation - User onboarding: Guided onboarding process for new users <strong>Measurement</strong>: User training time and task completion metrics</p>
<h3 id="nfr-028-performance-perception">NFR-028: Performance Perception</h3>
<p><strong>Category</strong>: Usability <strong>Priority</strong>: Medium <strong>Requirement</strong>: System shall provide responsive user experience with appropriate feedback <strong>Acceptance Criteria</strong>: - Loading indicators: Progress indicators for operations taking &gt;2 seconds - Immediate feedback: Instant feedback for all user interactions - Perceived performance: Optimized UI rendering for smooth user experience - Background processing: Non-blocking operations with status updates - Offline capability: Limited offline functionality for mobile users <strong>Measurement</strong>: User satisfaction surveys and performance perception metrics</p>
<h3 id="nfr-029-internationalization">NFR-029: Internationalization</h3>
<p><strong>Category</strong>: Usability <strong>Priority</strong>: Medium <strong>Requirement</strong>: System shall support multiple languages and regional preferences <strong>Acceptance Criteria</strong>: - Multi-language: Support 10+ languages including English, Spanish, French, German - Localization: Regional date, time, number, and currency formatting - Right-to-left: Support RTL languages like Arabic and Hebrew - Unicode support: Full Unicode support for international characters - Cultural adaptation: Culturally appropriate UI elements and workflows <strong>Measurement</strong>: Localization testing and international user feedback</p>
<h3 id="nfr-030-mobile-user-experience">NFR-030: Mobile User Experience</h3>
<p><strong>Category</strong>: Usability <strong>Priority</strong>: High <strong>Requirement</strong>: System shall provide optimized mobile experience for key workflows <strong>Acceptance Criteria</strong>: - Touch optimization: Touch-friendly interface design for mobile devices - Offline access: Core functionality available without network connectivity - Push notifications: Timely notifications for approvals and alerts - Device integration: Integration with device cameras for receipt capture - Performance: Mobile app performance equivalent to web interface <strong>Measurement</strong>: Mobile user satisfaction and app store ratings</p>
<h2 id="integration-and-interoperability-requirements">7. Integration and Interoperability Requirements</h2>
<h3 id="nfr-031-api-performance">NFR-031: API Performance</h3>
<p><strong>Category</strong>: Integration <strong>Priority</strong>: High <strong>Requirement</strong>: APIs shall provide high-performance integration capabilities <strong>Acceptance Criteria</strong>: - API response time: &lt;100ms average response time for API calls - Rate limiting: Support 10,000+ API calls per minute per client - API reliability: 99.9% API availability with proper error handling - Documentation: Comprehensive API documentation with examples - Versioning: API versioning strategy with backward compatibility <strong>Measurement</strong>: API performance monitoring and usage analytics</p>
<h3 id="nfr-032-data-integration-quality">NFR-032: Data Integration Quality</h3>
<p><strong>Category</strong>: Integration <strong>Priority</strong>: High <strong>Requirement</strong>: Data integration shall maintain high quality and consistency <strong>Acceptance Criteria</strong>: - Data accuracy: 99.9% accuracy in data transformation and mapping - Real-time sync: &lt;5 minutes latency for real-time data synchronization - Error handling: Graceful handling of integration errors with retry mechanisms - Data validation: Comprehensive validation of integrated data - Monitoring: Real-time monitoring of integration health and performance <strong>Measurement</strong>: Data quality metrics and integration success rates</p>
<h3 id="nfr-033-system-interoperability">NFR-033: System Interoperability</h3>
<p><strong>Category</strong>: Integration <strong>Priority</strong>: Medium <strong>Requirement</strong>: System shall interoperate with diverse enterprise systems and standards <strong>Acceptance Criteria</strong>: - Standard protocols: Support REST, SOAP, GraphQL, and messaging protocols - Data formats: Support JSON, XML, CSV, and industry-standard formats - Authentication: Support multiple authentication methods (OAuth, SAML, API keys) - Middleware: Integration with enterprise service bus (ESB) and middleware - Legacy systems: Support integration with legacy financial systems <strong>Measurement</strong>: Integration compatibility testing and certification</p>
<h3 id="nfr-034-cloud-integration">NFR-034: Cloud Integration</h3>
<p><strong>Category</strong>: Integration <strong>Priority</strong>: Medium <strong>Requirement</strong>: System shall integrate seamlessly with cloud services and platforms <strong>Acceptance Criteria</strong>: - Multi-cloud: Support deployment across AWS, Azure, and Google Cloud - Cloud services: Integration with cloud storage, messaging, and analytics services - Hybrid deployment: Support hybrid cloud and on-premises deployments - Container orchestration: Kubernetes-native deployment and scaling - Service mesh: Integration with service mesh for microservices communication <strong>Measurement</strong>: Cloud deployment success and performance metrics</p>
<h3 id="nfr-035-third-party-integration">NFR-035: Third-Party Integration</h3>
<p><strong>Category</strong>: Integration <strong>Priority</strong>: Low <strong>Requirement</strong>: System shall support integration with third-party services and applications <strong>Acceptance Criteria</strong>: - Marketplace: Support integration marketplace with pre-built connectors - Webhook support: Outbound webhooks for real-time event notifications - Partner APIs: Integration with financial service provider APIs - Data enrichment: Integration with external data sources for enrichment - Certification: Certified integrations with major enterprise software vendors <strong>Measurement</strong>: Third-party integration success rates and partner feedback</p>
<p>This NFRD provides comprehensive non-functional requirements that build upon the PRD and FRD foundations, ensuring the finance spend analytics platform meets enterprise-grade quality, performance, security, and compliance standards. # Architecture Diagram (AD) ## Finance Spend Analytics and Optimization Platform</p>
<p><em>Building upon PRD, FRD, and NFRD for comprehensive system architecture</em></p>
<h2 id="etvx-framework-3">ETVX Framework</h2>
<h3 id="entry-criteria-3">ENTRY CRITERIA</h3>
<ul>
<li>✅ PRD completed with business objectives and success metrics</li>
<li>✅ FRD completed with 40 functional requirements across 8 modules</li>
<li>✅ NFRD completed with 35 non-functional requirements</li>
<li>✅ Performance targets defined (&lt;3s response time, 99.9% uptime)</li>
<li>✅ Security requirements established (AES-256, MFA, SOX/GDPR compliance)</li>
<li>✅ Integration requirements specified for ERP, banking, procurement systems</li>
</ul>
<h3 id="task-3">TASK</h3>
<p>Design comprehensive system architecture supporting all FRD requirements while meeting NFRD specifications for scalable, secure, compliant finance spend analytics platform with real-time processing and AI-powered insights.</p>
<h3 id="verification-validation-3">VERIFICATION &amp; VALIDATION</h3>
<p><strong>Verification</strong>: Architecture supports all 40 FRD requirements and meets NFRD performance/security targets <strong>Validation</strong>: Design reviewed with enterprise architects and validated for enterprise deployment</p>
<h3 id="exit-criteria-3">EXIT CRITERIA</h3>
<ul>
<li>✅ Complete system architecture with components and interfaces defined</li>
<li>✅ Technology stack specified with rationale</li>
<li>✅ Integration patterns documented for external systems</li>
<li>✅ Security and compliance architecture detailed</li>
<li>✅ Foundation established for high-level design</li>
</ul>
<hr />
<h3 id="reference-to-previous-documents-2">Reference to Previous Documents</h3>
<ul>
<li><strong>PRD Business Objectives</strong> → Architecture supporting 15% cost savings, 30% processing reduction</li>
<li><strong>FRD Functional Modules</strong> → Microservices for expense management, analytics, anomaly detection</li>
<li><strong>NFRD Performance</strong> → Scalable architecture supporting &lt;3s response, 100K+ TPS</li>
<li><strong>NFRD Security</strong> → Security-first architecture with encryption, authentication, compliance</li>
</ul>
<h2 id="system-architecture-overview">1. System Architecture Overview</h2>
<h3 id="high-level-architecture">1.1 High-Level Architecture</h3>
<pre><code>┌─────────────────────────────────────────────────────────────────┐
│                    PRESENTATION LAYER                           │
├─────────────────────────────────────────────────────────────────┤
│ Web Portal │ Mobile Apps │ Executive Dashboard │ Admin Console │
│ (React)    │ (React Native)│ (D3.js)           │ (Vue.js)      │
└─────────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────────┐
│                     API GATEWAY LAYER                           │
├─────────────────────────────────────────────────────────────────┤
│ Kong Gateway │ OAuth 2.0 │ Rate Limiting │ Load Balancing     │
└─────────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────────┐
│                   MICROSERVICES LAYER                           │
├─────────────────────────────────────────────────────────────────┤
│ Expense │ Analytics │ Anomaly │ Forecasting │ Vendor │ Compliance│
│ Service │ Service   │ Service │ Service     │ Service│ Service   │
└─────────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────────┐
│                      AI/ML PIPELINE                             │
├─────────────────────────────────────────────────────────────────┤
│ ML Models │ Feature Eng │ Training │ Inference │ Model Registry │
└─────────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────────┐
│                        DATA LAYER                               │
├─────────────────────────────────────────────────────────────────┤
│PostgreSQL│Elasticsearch│Redis│MongoDB│ClickHouse│S3/Blob Storage│
└─────────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────────┐
│                    INTEGRATION LAYER                            │
├─────────────────────────────────────────────────────────────────┤
│ ERP Connectors │ Banking APIs │ Procurement │ Message Queue    │
└─────────────────────────────────────────────────────────────────┘</code></pre>
<h3 id="technology-stack">1.2 Technology Stack</h3>
<ul>
<li><strong>Frontend</strong>: React.js, React Native, D3.js, Material-UI</li>
<li><strong>Backend</strong>: Node.js, Python FastAPI, Kong API Gateway</li>
<li><strong>AI/ML</strong>: TensorFlow, PyTorch, spaCy, MLflow</li>
<li><strong>Data</strong>: PostgreSQL, Elasticsearch, Redis, MongoDB, ClickHouse</li>
<li><strong>Infrastructure</strong>: Kubernetes, Docker, Istio Service Mesh</li>
<li><strong>Integration</strong>: Apache Kafka, REST/GraphQL APIs</li>
</ul>
<h2 id="core-service-architecture">2. Core Service Architecture</h2>
<h3 id="expense-management-service">2.1 Expense Management Service</h3>
<pre><code>┌─────────────────────────────────────────────────────────────────┐
│                 EXPENSE MANAGEMENT SERVICE                       │
├─────────────────────────────────────────────────────────────────┤
│ Receipt OCR │ Categorization │ Policy Engine │ Duplicate Detection│
│ Processor   │ Engine         │               │                   │
│             │                │               │                   │
│• Tesseract  │• ML Classifier │• Rule Engine  │• Fuzzy Matching   │
│• Data Extract│• 90% Accuracy │• Approval Flow│• Confidence Score │
└─────────────────────────────────────────────────────────────────┘</code></pre>
<h3 id="analytics-service">2.2 Analytics Service</h3>
<pre><code>┌─────────────────────────────────────────────────────────────────┐
│                     ANALYTICS SERVICE                           │
├─────────────────────────────────────────────────────────────────┤
│ Query Engine │ Real-time │ Visualization │ Benchmarking Engine │
│              │ Analytics │ Engine        │                     │
│              │           │               │                     │
│• SQL Parser  │• Stream   │• Chart Builder│• Industry Compare   │
│• &lt;3s Response│• Live Dash│• Export Tools │• Peer Analysis      │
└─────────────────────────────────────────────────────────────────┘</code></pre>
<h3 id="aiml-pipeline">2.3 AI/ML Pipeline</h3>
<pre><code>┌─────────────────────────────────────────────────────────────────┐
│                      AI/ML PIPELINE                             │
├─────────────────────────────────────────────────────────────────┤
│ Data Prep │ Feature Eng │ Model Training │ Inference │ Monitoring│
│           │             │                │ Engine    │           │
│           │             │                │           │           │
│• Cleaning │• Transform  │• AutoML        │• Real-time│• Drift Det│
│• Validation│• Selection  │• Hyperparameter│• Batch    │• Accuracy │
└─────────────────────────────────────────────────────────────────┘</code></pre>
<h2 id="security-architecture">3. Security Architecture</h2>
<h3 id="security-controls">3.1 Security Controls</h3>
<pre><code>┌─────────────────────────────────────────────────────────────────┐
│                    SECURITY ARCHITECTURE                        │
├─────────────────────────────────────────────────────────────────┤
│ Identity &amp; Access │ Network Security │ Data Protection │ Compliance│
│                   │                  │                 │           │
│• OAuth 2.0/SAML   │• WAF/DDoS       │• AES-256        │• SOX      │
│• MFA Required     │• Network Seg     │• TLS 1.3        │• GDPR     │
│• RBAC             │• VPN Gateway     │• Key Management │• Audit    │
└─────────────────────────────────────────────────────────────────┘</code></pre>
<h2 id="integration-architecture">4. Integration Architecture</h2>
<h3 id="enterprise-integration">4.1 Enterprise Integration</h3>
<pre><code>┌─────────────────────────────────────────────────────────────────┐
│                  INTEGRATION ARCHITECTURE                       │
├─────────────────────────────────────────────────────────────────┤
│ ERP Integration │ Banking APIs │ Procurement │ Message Broker   │
│                 │              │ Systems     │                  │
│• SAP/Oracle     │• Bank Feeds  │• P2P Systems│• Apache Kafka    │
│• Real-time Sync │• SWIFT/OFX   │• Contracts  │• Event Streaming │
│• Data Quality   │• Multi-Currency│• Suppliers │• Error Handling │
└─────────────────────────────────────────────────────────────────┘</code></pre>
<h2 id="deployment-architecture">5. Deployment Architecture</h2>
<h3 id="cloud-native-infrastructure">5.1 Cloud-Native Infrastructure</h3>
<pre><code>┌─────────────────────────────────────────────────────────────────┐
│                   DEPLOYMENT ARCHITECTURE                       │
├─────────────────────────────────────────────────────────────────┤
│ Multi-Cloud │ Kubernetes │ Service Mesh │ CI/CD │ Monitoring    │
│             │            │              │       │               │
│• AWS/Azure  │• Auto-scale│• Istio       │• GitLab│• Prometheus  │
│• Multi-Region│• Load Bal │• Traffic Mgmt│• Blue/Green│• Grafana │
│• 99.9% SLA  │• Health Chk│• Security    │• Testing│• Alerting   │
└─────────────────────────────────────────────────────────────────┘</code></pre>
<h2 id="data-architecture">6. Data Architecture</h2>
<h3 id="data-storage-strategy">6.1 Data Storage Strategy</h3>
<ul>
<li><strong>PostgreSQL</strong>: Transactional data with ACID compliance</li>
<li><strong>Elasticsearch</strong>: Search, analytics, and log data</li>
<li><strong>Redis</strong>: Caching and session management</li>
<li><strong>MongoDB</strong>: Document storage and metadata</li>
<li><strong>ClickHouse</strong>: OLAP queries and real-time analytics</li>
<li><strong>S3/Blob</strong>: File storage and data archival</li>
</ul>
<h3 id="data-flow">6.2 Data Flow</h3>
<ol type="1">
<li><strong>Ingestion</strong>: Real-time and batch data from ERP/banking systems</li>
<li><strong>Processing</strong>: ETL pipelines with data quality validation</li>
<li><strong>Storage</strong>: Multi-tier storage based on access patterns</li>
<li><strong>Analytics</strong>: Real-time and batch analytics processing</li>
<li><strong>Serving</strong>: APIs and dashboards for data consumption</li>
</ol>
<p>This architecture provides enterprise-grade scalability, security, and performance while supporting all functional requirements and meeting non-functional specifications for the finance spend analytics platform. # High Level Design (HLD) ## Finance Spend Analytics and Optimization Platform</p>
<p><em>Building upon PRD, FRD, NFRD, and AD for detailed system design</em></p>
<h2 id="etvx-framework-4">ETVX Framework</h2>
<h3 id="entry-criteria-4">ENTRY CRITERIA</h3>
<ul>
<li>✅ PRD completed with business objectives, success metrics, and market analysis</li>
<li>✅ FRD completed with 40 functional requirements across 8 system modules</li>
<li>✅ NFRD completed with 35 non-functional requirements for performance, security, compliance</li>
<li>✅ AD completed with microservices architecture, technology stack, and integration patterns</li>
<li>✅ System architecture defined with presentation, API gateway, microservices, AI/ML, data, and integration layers</li>
<li>✅ Security architecture established with zero-trust principles and compliance controls</li>
</ul>
<h3 id="task-4">TASK</h3>
<p>Design detailed high-level system components, interfaces, data models, processing workflows, and operational procedures that implement the architecture from AD while satisfying all functional requirements from FRD and non-functional requirements from NFRD, providing implementation-ready specifications for development teams.</p>
<h3 id="verification-validation-4">VERIFICATION &amp; VALIDATION</h3>
<p><strong>Verification Checklist:</strong> - [ ] All FRD functional requirements mapped to specific HLD components - [ ] NFRD performance requirements addressed in component design (&lt;3s response, 100K+ TPS) - [ ] AD architecture patterns implemented in detailed component specifications - [ ] Data models support all expense management, analytics, and forecasting workflows - [ ] API specifications enable seamless integration with ERP, banking, and procurement systems - [ ] Security and compliance controls integrated into all component designs</p>
<p><strong>Validation Criteria:</strong> - [ ] Component designs reviewed with development teams and technical architects - [ ] Data models validated with database architects and data engineering teams - [ ] API specifications validated with integration partners and external system vendors - [ ] Security controls validated with cybersecurity experts and compliance officers - [ ] Performance characteristics validated through capacity planning and load modeling - [ ] Operational procedures validated with DevOps and infrastructure teams</p>
<h3 id="exit-criteria-4">EXIT CRITERIA</h3>
<ul>
<li>✅ Detailed component specifications for all microservices and system modules</li>
<li>✅ Comprehensive data models and database schemas defined</li>
<li>✅ API specifications and interface contracts documented</li>
<li>✅ Processing workflows and business logic detailed</li>
<li>✅ Security and compliance controls integrated into design</li>
<li>✅ Foundation prepared for low-level design and implementation specifications</li>
</ul>
<hr />
<h3 id="reference-to-previous-documents-3">Reference to Previous Documents</h3>
<p>This HLD builds upon <strong>PRD</strong>, <strong>FRD</strong>, <strong>NFRD</strong>, and <strong>AD</strong> foundations: - <strong>PRD Success Metrics</strong> → Component designs supporting 15% cost savings, 30% processing reduction, 90% accuracy - <strong>FRD Functional Requirements</strong> → Detailed component specifications for all 40 functional requirements - <strong>NFRD Performance Requirements</strong> → Component designs meeting &lt;3s response time, 99.9% uptime, 100K+ TPS - <strong>NFRD Security Requirements</strong> → Security controls integrated into all component designs - <strong>AD System Architecture</strong> → Microservices implementation with detailed component interfaces - <strong>AD Technology Stack</strong> → Component implementations using specified technologies</p>
<h2 id="system-component-overview">1. System Component Overview</h2>
<h3 id="component-hierarchy-and-dependencies">1.1 Component Hierarchy and Dependencies</h3>
<pre><code>┌─────────────────────────────────────────────────────────────────────────────────┐
│                          COMPONENT DEPENDENCY MAP                               │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  Frontend Components                    Backend Services                        │
│  ┌─────────────────┐                   ┌─────────────────┐                     │
│  │ Web Portal      │◄──────────────────┤ API Gateway     │                     │
│  │ Mobile Apps     │                   │ (Kong)          │                     │
│  │ Executive Dash  │                   └─────────────────┘                     │
│  │ Admin Console   │                            │                              │
│  └─────────────────┘                            ▼                              │
│                                        ┌─────────────────┐                     │
│                                        │ Core Services   │                     │
│                                        ├─────────────────┤                     │
│                                        │ • Expense Mgmt  │                     │
│                                        │ • Analytics     │                     │
│                                        │ • Anomaly Det   │                     │
│                                        │ • Forecasting   │                     │
│                                        │ • Vendor Mgmt   │                     │
│                                        │ • Compliance    │                     │
│                                        └─────────────────┘                     │
│                                                 │                              │
│                                                 ▼                              │
│                                        ┌─────────────────┐                     │
│                                        │ Support Services│                     │
│                                        ├─────────────────┤                     │
│                                        │ • User Mgmt     │                     │
│                                        │ • Notification  │                     │
│                                        │ • Audit         │                     │
│                                        │ • Integration   │                     │
│                                        │ • Workflow      │                     │
│                                        └─────────────────┘                     │
└─────────────────────────────────────────────────────────────────────────────────┘</code></pre>
<h3 id="service-communication-patterns">1.2 Service Communication Patterns</h3>
<ul>
<li><strong>Synchronous</strong>: REST APIs for real-time user interactions and queries</li>
<li><strong>Asynchronous</strong>: Event-driven messaging for data processing and notifications</li>
<li><strong>Streaming</strong>: Real-time data streams for analytics and monitoring</li>
<li><strong>Batch</strong>: Scheduled batch processing for reports and ML model training</li>
</ul>
<h2 id="core-service-detailed-design">2. Core Service Detailed Design</h2>
<h3 id="expense-management-service-1">2.1 Expense Management Service</h3>
<h4 id="component-architecture">2.1.1 Component Architecture</h4>
<div class="sourceCode" id="cb9"><pre class="sourceCode typescript"><code class="sourceCode typescript"><a class="sourceLine" id="cb9-1" title="1"><span class="kw">interface</span> ExpenseManagementService <span class="op">{</span></a>
<a class="sourceLine" id="cb9-2" title="2">  receiptProcessor<span class="op">:</span> ReceiptOCRProcessor<span class="op">;</span></a>
<a class="sourceLine" id="cb9-3" title="3">  categorizationEngine<span class="op">:</span> MLCategorizationEngine<span class="op">;</span></a>
<a class="sourceLine" id="cb9-4" title="4">  policyEngine<span class="op">:</span> PolicyComplianceEngine<span class="op">;</span></a>
<a class="sourceLine" id="cb9-5" title="5">  duplicateDetector<span class="op">:</span> DuplicateDetectionEngine<span class="op">;</span></a>
<a class="sourceLine" id="cb9-6" title="6">  workflowManager<span class="op">:</span> ExpenseWorkflowManager<span class="op">;</span></a>
<a class="sourceLine" id="cb9-7" title="7">  integrationHandler<span class="op">:</span> ERPIntegrationHandler<span class="op">;</span></a>
<a class="sourceLine" id="cb9-8" title="8"><span class="op">}</span></a></code></pre></div>
<h4 id="receipt-ocr-processor">2.1.2 Receipt OCR Processor</h4>
<p><strong>Purpose</strong>: Extract structured data from receipts and invoices using OCR and NLP <strong>Technology</strong>: Tesseract OCR, OpenCV, spaCy NLP <strong>Performance</strong>: Process 1000+ receipts/minute with 95% accuracy</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode typescript"><code class="sourceCode typescript"><a class="sourceLine" id="cb10-1" title="1"><span class="kw">class</span> ReceiptOCRProcessor <span class="op">{</span></a>
<a class="sourceLine" id="cb10-2" title="2">  <span class="kw">async</span> <span class="fu">processReceipt</span>(imageData<span class="op">:</span> <span class="bu">Buffer</span>)<span class="op">:</span> <span class="bu">Promise</span><span class="op">&lt;</span>ExtractedData<span class="op">&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb10-3" title="3">    <span class="co">// Image preprocessing and enhancement</span></a>
<a class="sourceLine" id="cb10-4" title="4">    <span class="kw">const</span> enhancedImage <span class="op">=</span> <span class="cf">await</span> <span class="va">this</span><span class="op">.</span><span class="fu">enhanceImage</span>(imageData)<span class="op">;</span></a>
<a class="sourceLine" id="cb10-5" title="5">    </a>
<a class="sourceLine" id="cb10-6" title="6">    <span class="co">// OCR text extraction</span></a>
<a class="sourceLine" id="cb10-7" title="7">    <span class="kw">const</span> rawText <span class="op">=</span> <span class="cf">await</span> <span class="va">this</span><span class="op">.</span><span class="fu">extractText</span>(enhancedImage)<span class="op">;</span></a>
<a class="sourceLine" id="cb10-8" title="8">    </a>
<a class="sourceLine" id="cb10-9" title="9">    <span class="co">// NLP-based data extraction</span></a>
<a class="sourceLine" id="cb10-10" title="10">    <span class="kw">const</span> structuredData <span class="op">=</span> <span class="cf">await</span> <span class="va">this</span><span class="op">.</span><span class="fu">extractStructuredData</span>(rawText)<span class="op">;</span></a>
<a class="sourceLine" id="cb10-11" title="11">    </a>
<a class="sourceLine" id="cb10-12" title="12">    <span class="co">// Validation and confidence scoring</span></a>
<a class="sourceLine" id="cb10-13" title="13">    <span class="cf">return</span> <span class="va">this</span><span class="op">.</span><span class="fu">validateAndScore</span>(structuredData)<span class="op">;</span></a>
<a class="sourceLine" id="cb10-14" title="14">  <span class="op">}</span></a>
<a class="sourceLine" id="cb10-15" title="15">  </a>
<a class="sourceLine" id="cb10-16" title="16">  <span class="kw">private</span> <span class="kw">async</span> <span class="fu">enhanceImage</span>(image<span class="op">:</span> <span class="bu">Buffer</span>)<span class="op">:</span> <span class="bu">Promise</span><span class="op">&lt;</span><span class="bu">Buffer</span><span class="op">&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb10-17" title="17">    <span class="co">// Noise reduction, contrast enhancement, deskewing</span></a>
<a class="sourceLine" id="cb10-18" title="18">  <span class="op">}</span></a>
<a class="sourceLine" id="cb10-19" title="19">  </a>
<a class="sourceLine" id="cb10-20" title="20">  <span class="kw">private</span> <span class="kw">async</span> <span class="fu">extractStructuredData</span>(text<span class="op">:</span> <span class="dt">string</span>)<span class="op">:</span> <span class="bu">Promise</span><span class="op">&lt;</span>ExtractedData<span class="op">&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb10-21" title="21">    <span class="co">// Named Entity Recognition for vendor, amount, date, tax</span></a>
<a class="sourceLine" id="cb10-22" title="22">    <span class="co">// Regular expressions for structured data patterns</span></a>
<a class="sourceLine" id="cb10-23" title="23">    <span class="co">// Machine learning models for field classification</span></a>
<a class="sourceLine" id="cb10-24" title="24">  <span class="op">}</span></a>
<a class="sourceLine" id="cb10-25" title="25"><span class="op">}</span></a></code></pre></div>
<h4 id="ml-categorization-engine">2.1.3 ML Categorization Engine</h4>
<p><strong>Purpose</strong>: Automatically categorize expenses using machine learning <strong>Technology</strong>: TensorFlow, BERT embeddings, scikit-learn <strong>Performance</strong>: 90% accuracy with &lt;2 second response time</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode typescript"><code class="sourceCode typescript"><a class="sourceLine" id="cb11-1" title="1"><span class="kw">class</span> MLCategorizationEngine <span class="op">{</span></a>
<a class="sourceLine" id="cb11-2" title="2">  <span class="kw">private</span> model<span class="op">:</span> TensorFlowModel<span class="op">;</span></a>
<a class="sourceLine" id="cb11-3" title="3">  <span class="kw">private</span> vectorizer<span class="op">:</span> BERTVectorizer<span class="op">;</span></a>
<a class="sourceLine" id="cb11-4" title="4">  </a>
<a class="sourceLine" id="cb11-5" title="5">  <span class="kw">async</span> <span class="fu">categorizeExpense</span>(expense<span class="op">:</span> ExpenseData)<span class="op">:</span> <span class="bu">Promise</span><span class="op">&lt;</span>CategoryResult<span class="op">&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb11-6" title="6">    <span class="co">// Feature extraction from expense description, vendor, amount</span></a>
<a class="sourceLine" id="cb11-7" title="7">    <span class="kw">const</span> features <span class="op">=</span> <span class="cf">await</span> <span class="va">this</span><span class="op">.</span><span class="fu">extractFeatures</span>(expense)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-8" title="8">    </a>
<a class="sourceLine" id="cb11-9" title="9">    <span class="co">// Model inference</span></a>
<a class="sourceLine" id="cb11-10" title="10">    <span class="kw">const</span> predictions <span class="op">=</span> <span class="cf">await</span> <span class="va">this</span><span class="op">.</span><span class="va">model</span><span class="op">.</span><span class="fu">predict</span>(features)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-11" title="11">    </a>
<a class="sourceLine" id="cb11-12" title="12">    <span class="co">// Post-processing and confidence scoring</span></a>
<a class="sourceLine" id="cb11-13" title="13">    <span class="cf">return</span> <span class="va">this</span><span class="op">.</span><span class="fu">formatResult</span>(predictions)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-14" title="14">  <span class="op">}</span></a>
<a class="sourceLine" id="cb11-15" title="15">  </a>
<a class="sourceLine" id="cb11-16" title="16">  <span class="kw">async</span> <span class="fu">retrainModel</span>(feedbackData<span class="op">:</span> CategoryFeedback<span class="op">[]</span>)<span class="op">:</span> <span class="bu">Promise</span><span class="op">&lt;</span><span class="dt">void</span><span class="op">&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb11-17" title="17">    <span class="co">// Incremental learning with user feedback</span></a>
<a class="sourceLine" id="cb11-18" title="18">    <span class="co">// Model validation and deployment</span></a>
<a class="sourceLine" id="cb11-19" title="19">  <span class="op">}</span></a>
<a class="sourceLine" id="cb11-20" title="20"><span class="op">}</span></a></code></pre></div>
<h4 id="policy-compliance-engine">2.1.4 Policy Compliance Engine</h4>
<p><strong>Purpose</strong>: Enforce expense policies and approval workflows <strong>Technology</strong>: Drools Rule Engine, Camunda BPMN <strong>Performance</strong>: &lt;1 second policy evaluation per expense</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode typescript"><code class="sourceCode typescript"><a class="sourceLine" id="cb12-1" title="1"><span class="kw">class</span> PolicyComplianceEngine <span class="op">{</span></a>
<a class="sourceLine" id="cb12-2" title="2">  <span class="kw">private</span> ruleEngine<span class="op">:</span> DroolsEngine<span class="op">;</span></a>
<a class="sourceLine" id="cb12-3" title="3">  <span class="kw">private</span> workflowEngine<span class="op">:</span> CamundaEngine<span class="op">;</span></a>
<a class="sourceLine" id="cb12-4" title="4">  </a>
<a class="sourceLine" id="cb12-5" title="5">  <span class="kw">async</span> <span class="fu">evaluatePolicy</span>(expense<span class="op">:</span> ExpenseData<span class="op">,</span> user<span class="op">:</span> UserContext)<span class="op">:</span> <span class="bu">Promise</span><span class="op">&lt;</span>PolicyResult<span class="op">&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb12-6" title="6">    <span class="co">// Load applicable policies based on user role and expense type</span></a>
<a class="sourceLine" id="cb12-7" title="7">    <span class="kw">const</span> policies <span class="op">=</span> <span class="cf">await</span> <span class="va">this</span><span class="op">.</span><span class="fu">loadPolicies</span>(user<span class="op">,</span> expense)<span class="op">;</span></a>
<a class="sourceLine" id="cb12-8" title="8">    </a>
<a class="sourceLine" id="cb12-9" title="9">    <span class="co">// Execute policy rules</span></a>
<a class="sourceLine" id="cb12-10" title="10">    <span class="kw">const</span> violations <span class="op">=</span> <span class="cf">await</span> <span class="va">this</span><span class="op">.</span><span class="va">ruleEngine</span><span class="op">.</span><span class="fu">evaluate</span>(expense<span class="op">,</span> policies)<span class="op">;</span></a>
<a class="sourceLine" id="cb12-11" title="11">    </a>
<a class="sourceLine" id="cb12-12" title="12">    <span class="co">// Determine approval workflow</span></a>
<a class="sourceLine" id="cb12-13" title="13">    <span class="kw">const</span> workflow <span class="op">=</span> <span class="cf">await</span> <span class="va">this</span><span class="op">.</span><span class="fu">determineWorkflow</span>(violations<span class="op">,</span> expense)<span class="op">;</span></a>
<a class="sourceLine" id="cb12-14" title="14">    </a>
<a class="sourceLine" id="cb12-15" title="15">    <span class="cf">return</span> <span class="op">{</span> violations<span class="op">,</span> workflow<span class="op">,</span> approvalRequired<span class="op">:</span> <span class="va">violations</span><span class="op">.</span><span class="at">length</span> <span class="op">&gt;</span> <span class="dv">0</span> <span class="op">};</span></a>
<a class="sourceLine" id="cb12-16" title="16">  <span class="op">}</span></a>
<a class="sourceLine" id="cb12-17" title="17"><span class="op">}</span></a></code></pre></div>
<h3 id="analytics-service-1">2.2 Analytics Service</h3>
<h4 id="component-architecture-1">2.2.1 Component Architecture</h4>
<div class="sourceCode" id="cb13"><pre class="sourceCode typescript"><code class="sourceCode typescript"><a class="sourceLine" id="cb13-1" title="1"><span class="kw">interface</span> AnalyticsService <span class="op">{</span></a>
<a class="sourceLine" id="cb13-2" title="2">  queryEngine<span class="op">:</span> AnalyticsQueryEngine<span class="op">;</span></a>
<a class="sourceLine" id="cb13-3" title="3">  aggregationEngine<span class="op">:</span> OLAPAggregationEngine<span class="op">;</span></a>
<a class="sourceLine" id="cb13-4" title="4">  visualizationEngine<span class="op">:</span> ChartVisualizationEngine<span class="op">;</span></a>
<a class="sourceLine" id="cb13-5" title="5">  realtimeAnalytics<span class="op">:</span> StreamAnalyticsEngine<span class="op">;</span></a>
<a class="sourceLine" id="cb13-6" title="6">  benchmarkEngine<span class="op">:</span> IndustryBenchmarkEngine<span class="op">;</span></a>
<a class="sourceLine" id="cb13-7" title="7"><span class="op">}</span></a></code></pre></div>
<h4 id="analytics-query-engine">2.2.2 Analytics Query Engine</h4>
<p><strong>Purpose</strong>: High-performance query processing for spend analytics <strong>Technology</strong>: ClickHouse, Apache Druid, GraphQL <strong>Performance</strong>: &lt;3 second response for complex multi-dimensional queries</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode typescript"><code class="sourceCode typescript"><a class="sourceLine" id="cb14-1" title="1"><span class="kw">class</span> AnalyticsQueryEngine <span class="op">{</span></a>
<a class="sourceLine" id="cb14-2" title="2">  <span class="kw">private</span> clickHouse<span class="op">:</span> ClickHouseClient<span class="op">;</span></a>
<a class="sourceLine" id="cb14-3" title="3">  <span class="kw">private</span> queryOptimizer<span class="op">:</span> QueryOptimizer<span class="op">;</span></a>
<a class="sourceLine" id="cb14-4" title="4">  <span class="kw">private</span> cacheManager<span class="op">:</span> RedisCacheManager<span class="op">;</span></a>
<a class="sourceLine" id="cb14-5" title="5">  </a>
<a class="sourceLine" id="cb14-6" title="6">  <span class="kw">async</span> <span class="fu">executeQuery</span>(query<span class="op">:</span> AnalyticsQuery)<span class="op">:</span> <span class="bu">Promise</span><span class="op">&lt;</span>QueryResult<span class="op">&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb14-7" title="7">    <span class="co">// Query optimization and caching</span></a>
<a class="sourceLine" id="cb14-8" title="8">    <span class="kw">const</span> optimizedQuery <span class="op">=</span> <span class="cf">await</span> <span class="va">this</span><span class="op">.</span><span class="va">queryOptimizer</span><span class="op">.</span><span class="fu">optimize</span>(query)<span class="op">;</span></a>
<a class="sourceLine" id="cb14-9" title="9">    <span class="kw">const</span> cacheKey <span class="op">=</span> <span class="va">this</span><span class="op">.</span><span class="fu">generateCacheKey</span>(optimizedQuery)<span class="op">;</span></a>
<a class="sourceLine" id="cb14-10" title="10">    </a>
<a class="sourceLine" id="cb14-11" title="11">    <span class="co">// Check cache first</span></a>
<a class="sourceLine" id="cb14-12" title="12">    <span class="kw">let</span> result <span class="op">=</span> <span class="cf">await</span> <span class="va">this</span><span class="op">.</span><span class="va">cacheManager</span><span class="op">.</span><span class="fu">get</span>(cacheKey)<span class="op">;</span></a>
<a class="sourceLine" id="cb14-13" title="13">    <span class="fu">if</span> (<span class="op">!</span>result) <span class="op">{</span></a>
<a class="sourceLine" id="cb14-14" title="14">      <span class="co">// Execute query against ClickHouse</span></a>
<a class="sourceLine" id="cb14-15" title="15">      result <span class="op">=</span> <span class="cf">await</span> <span class="va">this</span><span class="op">.</span><span class="va">clickHouse</span><span class="op">.</span><span class="fu">query</span>(optimizedQuery)<span class="op">;</span></a>
<a class="sourceLine" id="cb14-16" title="16">      <span class="cf">await</span> <span class="va">this</span><span class="op">.</span><span class="va">cacheManager</span><span class="op">.</span><span class="fu">set</span>(cacheKey<span class="op">,</span> result<span class="op">,</span> <span class="dv">300</span>)<span class="op">;</span> <span class="co">// 5 min TTL</span></a>
<a class="sourceLine" id="cb14-17" title="17">    <span class="op">}</span></a>
<a class="sourceLine" id="cb14-18" title="18">    </a>
<a class="sourceLine" id="cb14-19" title="19">    <span class="cf">return</span> <span class="va">this</span><span class="op">.</span><span class="fu">formatResult</span>(result)<span class="op">;</span></a>
<a class="sourceLine" id="cb14-20" title="20">  <span class="op">}</span></a>
<a class="sourceLine" id="cb14-21" title="21"><span class="op">}</span></a></code></pre></div>
<h4 id="real-time-analytics-engine">2.2.3 Real-time Analytics Engine</h4>
<p><strong>Purpose</strong>: Process real-time spend events for live dashboards <strong>Technology</strong>: Apache Kafka Streams, Redis, WebSocket <strong>Performance</strong>: &lt;30 second latency for real-time metrics</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode typescript"><code class="sourceCode typescript"><a class="sourceLine" id="cb15-1" title="1"><span class="kw">class</span> StreamAnalyticsEngine <span class="op">{</span></a>
<a class="sourceLine" id="cb15-2" title="2">  <span class="kw">private</span> kafkaStreams<span class="op">:</span> KafkaStreams<span class="op">;</span></a>
<a class="sourceLine" id="cb15-3" title="3">  <span class="kw">private</span> redisStreams<span class="op">:</span> RedisStreams<span class="op">;</span></a>
<a class="sourceLine" id="cb15-4" title="4">  <span class="kw">private</span> websocketManager<span class="op">:</span> WebSocketManager<span class="op">;</span></a>
<a class="sourceLine" id="cb15-5" title="5">  </a>
<a class="sourceLine" id="cb15-6" title="6">  <span class="kw">async</span> <span class="fu">processSpendEvent</span>(event<span class="op">:</span> SpendEvent)<span class="op">:</span> <span class="bu">Promise</span><span class="op">&lt;</span><span class="dt">void</span><span class="op">&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb15-7" title="7">    <span class="co">// Real-time aggregations</span></a>
<a class="sourceLine" id="cb15-8" title="8">    <span class="cf">await</span> <span class="va">this</span><span class="op">.</span><span class="fu">updateRealTimeMetrics</span>(<span class="bu">event</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb15-9" title="9">    </a>
<a class="sourceLine" id="cb15-10" title="10">    <span class="co">// Anomaly detection</span></a>
<a class="sourceLine" id="cb15-11" title="11">    <span class="kw">const</span> anomalies <span class="op">=</span> <span class="cf">await</span> <span class="va">this</span><span class="op">.</span><span class="fu">detectAnomalies</span>(<span class="bu">event</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb15-12" title="12">    </a>
<a class="sourceLine" id="cb15-13" title="13">    <span class="co">// Push updates to connected clients</span></a>
<a class="sourceLine" id="cb15-14" title="14">    <span class="cf">await</span> <span class="va">this</span><span class="op">.</span><span class="va">websocketManager</span><span class="op">.</span><span class="fu">broadcast</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb15-15" title="15">      type<span class="op">:</span> <span class="st">&#39;spend_update&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb15-16" title="16">      data<span class="op">:</span> <span class="op">{</span> <span class="bu">event</span><span class="op">,</span> anomalies <span class="op">}</span></a>
<a class="sourceLine" id="cb15-17" title="17">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb15-18" title="18">  <span class="op">}</span></a>
<a class="sourceLine" id="cb15-19" title="19">  </a>
<a class="sourceLine" id="cb15-20" title="20">  <span class="kw">private</span> <span class="kw">async</span> <span class="fu">updateRealTimeMetrics</span>(event<span class="op">:</span> SpendEvent)<span class="op">:</span> <span class="bu">Promise</span><span class="op">&lt;</span><span class="dt">void</span><span class="op">&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb15-21" title="21">    <span class="co">// Update sliding window aggregations in Redis</span></a>
<a class="sourceLine" id="cb15-22" title="22">    <span class="co">// Department spend, vendor spend, category spend</span></a>
<a class="sourceLine" id="cb15-23" title="23">  <span class="op">}</span></a>
<a class="sourceLine" id="cb15-24" title="24"><span class="op">}</span></a></code></pre></div>
<h3 id="anomaly-detection-service">2.3 Anomaly Detection Service</h3>
<h4 id="component-architecture-2">2.3.1 Component Architecture</h4>
<div class="sourceCode" id="cb16"><pre class="sourceCode typescript"><code class="sourceCode typescript"><a class="sourceLine" id="cb16-1" title="1"><span class="kw">interface</span> AnomalyDetectionService <span class="op">{</span></a>
<a class="sourceLine" id="cb16-2" title="2">  statisticalDetector<span class="op">:</span> StatisticalAnomalyDetector<span class="op">;</span></a>
<a class="sourceLine" id="cb16-3" title="3">  fraudDetector<span class="op">:</span> FraudDetectionEngine<span class="op">;</span></a>
<a class="sourceLine" id="cb16-4" title="4">  vendorAnomalyDetector<span class="op">:</span> VendorAnomalyDetector<span class="op">;</span></a>
<a class="sourceLine" id="cb16-5" title="5">  employeeAnomalyDetector<span class="op">:</span> EmployeeAnomalyDetector<span class="op">;</span></a>
<a class="sourceLine" id="cb16-6" title="6">  investigationWorkflow<span class="op">:</span> AnomalyInvestigationWorkflow<span class="op">;</span></a>
<a class="sourceLine" id="cb16-7" title="7"><span class="op">}</span></a></code></pre></div>
<h4 id="statistical-anomaly-detector">2.3.2 Statistical Anomaly Detector</h4>
<p><strong>Purpose</strong>: Detect statistical outliers in spending patterns <strong>Technology</strong>: scikit-learn, TensorFlow, statistical algorithms <strong>Performance</strong>: Process 10K+ transactions/minute with &lt;5 second detection time</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode typescript"><code class="sourceCode typescript"><a class="sourceLine" id="cb17-1" title="1"><span class="kw">class</span> StatisticalAnomalyDetector <span class="op">{</span></a>
<a class="sourceLine" id="cb17-2" title="2">  <span class="kw">private</span> models<span class="op">:</span> <span class="bu">Map</span><span class="op">&lt;</span><span class="dt">string</span><span class="op">,</span> AnomalyModel<span class="op">&gt;;</span></a>
<a class="sourceLine" id="cb17-3" title="3">  </a>
<a class="sourceLine" id="cb17-4" title="4">  <span class="kw">async</span> <span class="fu">detectAnomalies</span>(transactions<span class="op">:</span> Transaction<span class="op">[]</span>)<span class="op">:</span> <span class="bu">Promise</span><span class="op">&lt;</span>AnomalyResult<span class="op">[]&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb17-5" title="5">    <span class="kw">const</span> results<span class="op">:</span> AnomalyResult<span class="op">[]</span> <span class="op">=</span> <span class="op">[];</span></a>
<a class="sourceLine" id="cb17-6" title="6">    </a>
<a class="sourceLine" id="cb17-7" title="7">    <span class="fu">for</span> (<span class="kw">const</span> transaction <span class="kw">of</span> transactions) <span class="op">{</span></a>
<a class="sourceLine" id="cb17-8" title="8">      <span class="co">// Get appropriate model for transaction type</span></a>
<a class="sourceLine" id="cb17-9" title="9">      <span class="kw">const</span> model <span class="op">=</span> <span class="va">this</span><span class="op">.</span><span class="fu">getModel</span>(<span class="va">transaction</span><span class="op">.</span><span class="at">category</span><span class="op">,</span> <span class="va">transaction</span><span class="op">.</span><span class="at">department</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb17-10" title="10">      </a>
<a class="sourceLine" id="cb17-11" title="11">      <span class="co">// Calculate anomaly score</span></a>
<a class="sourceLine" id="cb17-12" title="12">      <span class="kw">const</span> score <span class="op">=</span> <span class="cf">await</span> <span class="va">model</span><span class="op">.</span><span class="fu">calculateAnomalyScore</span>(transaction)<span class="op">;</span></a>
<a class="sourceLine" id="cb17-13" title="13">      </a>
<a class="sourceLine" id="cb17-14" title="14">      <span class="fu">if</span> (score <span class="op">&gt;</span> <span class="va">this</span><span class="op">.</span><span class="at">threshold</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb17-15" title="15">        <span class="va">results</span><span class="op">.</span><span class="fu">push</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb17-16" title="16">          transaction<span class="op">,</span></a>
<a class="sourceLine" id="cb17-17" title="17">          score<span class="op">,</span></a>
<a class="sourceLine" id="cb17-18" title="18">          type<span class="op">:</span> <span class="st">&#39;statistical&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb17-19" title="19">          confidence<span class="op">:</span> <span class="va">this</span><span class="op">.</span><span class="fu">calculateConfidence</span>(score)</a>
<a class="sourceLine" id="cb17-20" title="20">        <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb17-21" title="21">      <span class="op">}</span></a>
<a class="sourceLine" id="cb17-22" title="22">    <span class="op">}</span></a>
<a class="sourceLine" id="cb17-23" title="23">    </a>
<a class="sourceLine" id="cb17-24" title="24">    <span class="cf">return</span> results<span class="op">;</span></a>
<a class="sourceLine" id="cb17-25" title="25">  <span class="op">}</span></a>
<a class="sourceLine" id="cb17-26" title="26">  </a>
<a class="sourceLine" id="cb17-27" title="27">  <span class="kw">private</span> <span class="fu">getModel</span>(category<span class="op">:</span> <span class="dt">string</span><span class="op">,</span> department<span class="op">:</span> <span class="dt">string</span>)<span class="op">:</span> AnomalyModel <span class="op">{</span></a>
<a class="sourceLine" id="cb17-28" title="28">    <span class="kw">const</span> key <span class="op">=</span> <span class="vs">`</span><span class="sc">${</span>category<span class="sc">}</span><span class="vs">_</span><span class="sc">${</span>department<span class="sc">}</span><span class="vs">`</span><span class="op">;</span></a>
<a class="sourceLine" id="cb17-29" title="29">    <span class="fu">if</span> (<span class="op">!</span><span class="va">this</span><span class="op">.</span><span class="va">models</span><span class="op">.</span><span class="fu">has</span>(key)) <span class="op">{</span></a>
<a class="sourceLine" id="cb17-30" title="30">      <span class="va">this</span><span class="op">.</span><span class="va">models</span><span class="op">.</span><span class="fu">set</span>(key<span class="op">,</span> <span class="kw">new</span> <span class="fu">IsolationForestModel</span>())<span class="op">;</span></a>
<a class="sourceLine" id="cb17-31" title="31">    <span class="op">}</span></a>
<a class="sourceLine" id="cb17-32" title="32">    <span class="cf">return</span> <span class="va">this</span><span class="op">.</span><span class="va">models</span><span class="op">.</span><span class="fu">get</span>(key)<span class="op">;</span></a>
<a class="sourceLine" id="cb17-33" title="33">  <span class="op">}</span></a>
<a class="sourceLine" id="cb17-34" title="34"><span class="op">}</span></a></code></pre></div>
<h4 id="fraud-detection-engine">2.3.3 Fraud Detection Engine</h4>
<p><strong>Purpose</strong>: Identify potential fraudulent activities and policy violations <strong>Technology</strong>: Graph algorithms, behavioral analysis, rule-based detection <strong>Performance</strong>: 95% fraud detection accuracy with &lt;2% false positives</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode typescript"><code class="sourceCode typescript"><a class="sourceLine" id="cb18-1" title="1"><span class="kw">class</span> FraudDetectionEngine <span class="op">{</span></a>
<a class="sourceLine" id="cb18-2" title="2">  <span class="kw">private</span> behavioralModel<span class="op">:</span> BehavioralAnalysisModel<span class="op">;</span></a>
<a class="sourceLine" id="cb18-3" title="3">  <span class="kw">private</span> ruleEngine<span class="op">:</span> FraudRuleEngine<span class="op">;</span></a>
<a class="sourceLine" id="cb18-4" title="4">  <span class="kw">private</span> graphAnalyzer<span class="op">:</span> GraphAnalyzer<span class="op">;</span></a>
<a class="sourceLine" id="cb18-5" title="5">  </a>
<a class="sourceLine" id="cb18-6" title="6">  <span class="kw">async</span> <span class="fu">detectFraud</span>(expense<span class="op">:</span> ExpenseData<span class="op">,</span> context<span class="op">:</span> UserContext)<span class="op">:</span> <span class="bu">Promise</span><span class="op">&lt;</span>FraudResult<span class="op">&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb18-7" title="7">    <span class="co">// Behavioral analysis</span></a>
<a class="sourceLine" id="cb18-8" title="8">    <span class="kw">const</span> behavioralScore <span class="op">=</span> <span class="cf">await</span> <span class="va">this</span><span class="op">.</span><span class="va">behavioralModel</span><span class="op">.</span><span class="fu">analyze</span>(expense<span class="op">,</span> context)<span class="op">;</span></a>
<a class="sourceLine" id="cb18-9" title="9">    </a>
<a class="sourceLine" id="cb18-10" title="10">    <span class="co">// Rule-based detection</span></a>
<a class="sourceLine" id="cb18-11" title="11">    <span class="kw">const</span> ruleViolations <span class="op">=</span> <span class="cf">await</span> <span class="va">this</span><span class="op">.</span><span class="va">ruleEngine</span><span class="op">.</span><span class="fu">evaluate</span>(expense)<span class="op">;</span></a>
<a class="sourceLine" id="cb18-12" title="12">    </a>
<a class="sourceLine" id="cb18-13" title="13">    <span class="co">// Graph analysis for vendor relationships</span></a>
<a class="sourceLine" id="cb18-14" title="14">    <span class="kw">const</span> graphAnomalies <span class="op">=</span> <span class="cf">await</span> <span class="va">this</span><span class="op">.</span><span class="va">graphAnalyzer</span><span class="op">.</span><span class="fu">analyzeVendorNetwork</span>(expense)<span class="op">;</span></a>
<a class="sourceLine" id="cb18-15" title="15">    </a>
<a class="sourceLine" id="cb18-16" title="16">    <span class="co">// Combine scores and determine fraud probability</span></a>
<a class="sourceLine" id="cb18-17" title="17">    <span class="kw">const</span> fraudProbability <span class="op">=</span> <span class="va">this</span><span class="op">.</span><span class="fu">combineFraudScores</span>(</a>
<a class="sourceLine" id="cb18-18" title="18">      behavioralScore<span class="op">,</span> ruleViolations<span class="op">,</span> graphAnomalies</a>
<a class="sourceLine" id="cb18-19" title="19">    )<span class="op">;</span></a>
<a class="sourceLine" id="cb18-20" title="20">    </a>
<a class="sourceLine" id="cb18-21" title="21">    <span class="cf">return</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb18-22" title="22">      probability<span class="op">:</span> fraudProbability<span class="op">,</span></a>
<a class="sourceLine" id="cb18-23" title="23">      indicators<span class="op">:</span> <span class="op">[...</span>ruleViolations<span class="op">,</span> <span class="op">...</span>graphAnomalies<span class="op">],</span></a>
<a class="sourceLine" id="cb18-24" title="24">      recommendedAction<span class="op">:</span> <span class="va">this</span><span class="op">.</span><span class="fu">getRecommendedAction</span>(fraudProbability)</a>
<a class="sourceLine" id="cb18-25" title="25">    <span class="op">};</span></a>
<a class="sourceLine" id="cb18-26" title="26">  <span class="op">}</span></a>
<a class="sourceLine" id="cb18-27" title="27"><span class="op">}</span></a></code></pre></div>
<h3 id="forecasting-service">2.4 Forecasting Service</h3>
<h4 id="component-architecture-3">2.4.1 Component Architecture</h4>
<div class="sourceCode" id="cb19"><pre class="sourceCode typescript"><code class="sourceCode typescript"><a class="sourceLine" id="cb19-1" title="1"><span class="kw">interface</span> ForecastingService <span class="op">{</span></a>
<a class="sourceLine" id="cb19-2" title="2">  budgetForecaster<span class="op">:</span> BudgetForecastingEngine<span class="op">;</span></a>
<a class="sourceLine" id="cb19-3" title="3">  spendPredictor<span class="op">:</span> SpendPredictionEngine<span class="op">;</span></a>
<a class="sourceLine" id="cb19-4" title="4">  cashFlowForecaster<span class="op">:</span> CashFlowForecastingEngine<span class="op">;</span></a>
<a class="sourceLine" id="cb19-5" title="5">  seasonalAdjuster<span class="op">:</span> SeasonalAdjustmentEngine<span class="op">;</span></a>
<a class="sourceLine" id="cb19-6" title="6">  accuracyMonitor<span class="op">:</span> ForecastAccuracyMonitor<span class="op">;</span></a>
<a class="sourceLine" id="cb19-7" title="7"><span class="op">}</span></a></code></pre></div>
<h4 id="budget-forecasting-engine">2.4.2 Budget Forecasting Engine</h4>
<p><strong>Purpose</strong>: Generate AI-powered budget forecasts with scenario modeling <strong>Technology</strong>: TensorFlow, Prophet, ARIMA models <strong>Performance</strong>: Generate quarterly forecasts in &lt;60 seconds with 85% accuracy</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode typescript"><code class="sourceCode typescript"><a class="sourceLine" id="cb20-1" title="1"><span class="kw">class</span> BudgetForecastingEngine <span class="op">{</span></a>
<a class="sourceLine" id="cb20-2" title="2">  <span class="kw">private</span> models<span class="op">:</span> <span class="bu">Map</span><span class="op">&lt;</span><span class="dt">string</span><span class="op">,</span> ForecastModel<span class="op">&gt;;</span></a>
<a class="sourceLine" id="cb20-3" title="3">  <span class="kw">private</span> scenarioEngine<span class="op">:</span> ScenarioModelingEngine<span class="op">;</span></a>
<a class="sourceLine" id="cb20-4" title="4">  </a>
<a class="sourceLine" id="cb20-5" title="5">  <span class="kw">async</span> <span class="fu">generateForecast</span>(</a>
<a class="sourceLine" id="cb20-6" title="6">    historicalData<span class="op">:</span> HistoricalSpendData<span class="op">[],</span></a>
<a class="sourceLine" id="cb20-7" title="7">    parameters<span class="op">:</span> ForecastParameters</a>
<a class="sourceLine" id="cb20-8" title="8">  )<span class="op">:</span> <span class="bu">Promise</span><span class="op">&lt;</span>BudgetForecast<span class="op">&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb20-9" title="9">    <span class="co">// Select appropriate forecasting model</span></a>
<a class="sourceLine" id="cb20-10" title="10">    <span class="kw">const</span> model <span class="op">=</span> <span class="va">this</span><span class="op">.</span><span class="fu">selectModel</span>(historicalData<span class="op">,</span> parameters)<span class="op">;</span></a>
<a class="sourceLine" id="cb20-11" title="11">    </a>
<a class="sourceLine" id="cb20-12" title="12">    <span class="co">// Generate base forecast</span></a>
<a class="sourceLine" id="cb20-13" title="13">    <span class="kw">const</span> baseForecast <span class="op">=</span> <span class="cf">await</span> <span class="va">model</span><span class="op">.</span><span class="fu">forecast</span>(historicalData<span class="op">,</span> <span class="va">parameters</span><span class="op">.</span><span class="at">horizon</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb20-14" title="14">    </a>
<a class="sourceLine" id="cb20-15" title="15">    <span class="co">// Apply scenario modeling</span></a>
<a class="sourceLine" id="cb20-16" title="16">    <span class="kw">const</span> scenarios <span class="op">=</span> <span class="cf">await</span> <span class="va">this</span><span class="op">.</span><span class="va">scenarioEngine</span><span class="op">.</span><span class="fu">generateScenarios</span>(</a>
<a class="sourceLine" id="cb20-17" title="17">      baseForecast<span class="op">,</span> <span class="va">parameters</span><span class="op">.</span><span class="at">scenarios</span></a>
<a class="sourceLine" id="cb20-18" title="18">    )<span class="op">;</span></a>
<a class="sourceLine" id="cb20-19" title="19">    </a>
<a class="sourceLine" id="cb20-20" title="20">    <span class="co">// Calculate confidence intervals</span></a>
<a class="sourceLine" id="cb20-21" title="21">    <span class="kw">const</span> confidenceIntervals <span class="op">=</span> <span class="va">this</span><span class="op">.</span><span class="fu">calculateConfidenceIntervals</span>(baseForecast)<span class="op">;</span></a>
<a class="sourceLine" id="cb20-22" title="22">    </a>
<a class="sourceLine" id="cb20-23" title="23">    <span class="cf">return</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb20-24" title="24">      forecast<span class="op">:</span> baseForecast<span class="op">,</span></a>
<a class="sourceLine" id="cb20-25" title="25">      scenarios<span class="op">,</span></a>
<a class="sourceLine" id="cb20-26" title="26">      confidenceIntervals<span class="op">,</span></a>
<a class="sourceLine" id="cb20-27" title="27">      accuracy<span class="op">:</span> <span class="cf">await</span> <span class="va">this</span><span class="op">.</span><span class="fu">estimateAccuracy</span>(model<span class="op">,</span> historicalData)</a>
<a class="sourceLine" id="cb20-28" title="28">    <span class="op">};</span></a>
<a class="sourceLine" id="cb20-29" title="29">  <span class="op">}</span></a>
<a class="sourceLine" id="cb20-30" title="30">  </a>
<a class="sourceLine" id="cb20-31" title="31">  <span class="kw">private</span> <span class="fu">selectModel</span>(data<span class="op">:</span> HistoricalSpendData<span class="op">[],</span> params<span class="op">:</span> ForecastParameters)<span class="op">:</span> ForecastModel <span class="op">{</span></a>
<a class="sourceLine" id="cb20-32" title="32">    <span class="co">// Model selection based on data characteristics</span></a>
<a class="sourceLine" id="cb20-33" title="33">    <span class="fu">if</span> (<span class="va">this</span><span class="op">.</span><span class="fu">hasSeasonality</span>(data)) <span class="op">{</span></a>
<a class="sourceLine" id="cb20-34" title="34">      <span class="cf">return</span> <span class="kw">new</span> <span class="fu">ProphetModel</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb20-35" title="35">    <span class="op">}</span> <span class="cf">else</span> <span class="fu">if</span> (<span class="va">this</span><span class="op">.</span><span class="fu">hasTrend</span>(data)) <span class="op">{</span></a>
<a class="sourceLine" id="cb20-36" title="36">      <span class="cf">return</span> <span class="kw">new</span> <span class="fu">ARIMAModel</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb20-37" title="37">    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb20-38" title="38">      <span class="cf">return</span> <span class="kw">new</span> <span class="fu">LinearRegressionModel</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb20-39" title="39">    <span class="op">}</span></a>
<a class="sourceLine" id="cb20-40" title="40">  <span class="op">}</span></a>
<a class="sourceLine" id="cb20-41" title="41"><span class="op">}</span></a></code></pre></div>
<h2 id="data-models-and-schemas">3. Data Models and Schemas</h2>
<h3 id="core-data-entities">3.1 Core Data Entities</h3>
<h4 id="expense-transaction-schema">3.1.1 Expense Transaction Schema</h4>
<div class="sourceCode" id="cb21"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb21-1" title="1"><span class="kw">CREATE</span> <span class="kw">TABLE</span> expense_transactions (</a>
<a class="sourceLine" id="cb21-2" title="2">    <span class="kw">id</span> UUID <span class="kw">PRIMARY</span> <span class="kw">KEY</span> <span class="kw">DEFAULT</span> gen_random_uuid(),</a>
<a class="sourceLine" id="cb21-3" title="3">    transaction_date <span class="dt">DATE</span> <span class="kw">NOT</span> <span class="kw">NULL</span>,</a>
<a class="sourceLine" id="cb21-4" title="4">    amount <span class="dt">DECIMAL</span>(<span class="dv">15</span>,<span class="dv">2</span>) <span class="kw">NOT</span> <span class="kw">NULL</span>,</a>
<a class="sourceLine" id="cb21-5" title="5">    currency_code <span class="dt">VARCHAR</span>(<span class="dv">3</span>) <span class="kw">NOT</span> <span class="kw">NULL</span>,</a>
<a class="sourceLine" id="cb21-6" title="6">    vendor_id UUID <span class="kw">REFERENCES</span> vendors(<span class="kw">id</span>),</a>
<a class="sourceLine" id="cb21-7" title="7">    category_id UUID <span class="kw">REFERENCES</span> expense_categories(<span class="kw">id</span>),</a>
<a class="sourceLine" id="cb21-8" title="8">    department_id UUID <span class="kw">REFERENCES</span> departments(<span class="kw">id</span>),</a>
<a class="sourceLine" id="cb21-9" title="9">    employee_id UUID <span class="kw">REFERENCES</span> employees(<span class="kw">id</span>),</a>
<a class="sourceLine" id="cb21-10" title="10">    description TEXT,</a>
<a class="sourceLine" id="cb21-11" title="11">    receipt_url <span class="dt">VARCHAR</span>(<span class="dv">500</span>),</a>
<a class="sourceLine" id="cb21-12" title="12">    status <span class="dt">VARCHAR</span>(<span class="dv">20</span>) <span class="kw">NOT</span> <span class="kw">NULL</span> <span class="kw">DEFAULT</span> <span class="st">&#39;pending&#39;</span>,</a>
<a class="sourceLine" id="cb21-13" title="13">    policy_violations JSONB,</a>
<a class="sourceLine" id="cb21-14" title="14">    approval_workflow JSONB,</a>
<a class="sourceLine" id="cb21-15" title="15">    created_at <span class="dt">TIMESTAMP</span> <span class="kw">DEFAULT</span> <span class="fu">CURRENT_TIMESTAMP</span>,</a>
<a class="sourceLine" id="cb21-16" title="16">    updated_at <span class="dt">TIMESTAMP</span> <span class="kw">DEFAULT</span> <span class="fu">CURRENT_TIMESTAMP</span>,</a>
<a class="sourceLine" id="cb21-17" title="17">    </a>
<a class="sourceLine" id="cb21-18" title="18">    <span class="co">-- Indexes for performance</span></a>
<a class="sourceLine" id="cb21-19" title="19">    <span class="kw">INDEX</span> idx_transaction_date (transaction_date),</a>
<a class="sourceLine" id="cb21-20" title="20">    <span class="kw">INDEX</span> idx_vendor_amount (vendor_id, amount),</a>
<a class="sourceLine" id="cb21-21" title="21">    <span class="kw">INDEX</span> idx_category_dept (category_id, department_id),</a>
<a class="sourceLine" id="cb21-22" title="22">    <span class="kw">INDEX</span> idx_employee_status (employee_id, status)</a>
<a class="sourceLine" id="cb21-23" title="23">);</a></code></pre></div>
<h4 id="vendor-master-schema">3.1.2 Vendor Master Schema</h4>
<div class="sourceCode" id="cb22"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb22-1" title="1"><span class="kw">CREATE</span> <span class="kw">TABLE</span> vendors (</a>
<a class="sourceLine" id="cb22-2" title="2">    <span class="kw">id</span> UUID <span class="kw">PRIMARY</span> <span class="kw">KEY</span> <span class="kw">DEFAULT</span> gen_random_uuid(),</a>
<a class="sourceLine" id="cb22-3" title="3">    vendor_name <span class="dt">VARCHAR</span>(<span class="dv">255</span>) <span class="kw">NOT</span> <span class="kw">NULL</span>,</a>
<a class="sourceLine" id="cb22-4" title="4">    vendor_code <span class="dt">VARCHAR</span>(<span class="dv">50</span>) <span class="kw">UNIQUE</span>,</a>
<a class="sourceLine" id="cb22-5" title="5">    tax_id <span class="dt">VARCHAR</span>(<span class="dv">50</span>),</a>
<a class="sourceLine" id="cb22-6" title="6">    address JSONB,</a>
<a class="sourceLine" id="cb22-7" title="7">    contact_info JSONB,</a>
<a class="sourceLine" id="cb22-8" title="8">    payment_terms <span class="dt">INTEGER</span>,</a>
<a class="sourceLine" id="cb22-9" title="9">    risk_score <span class="dt">DECIMAL</span>(<span class="dv">3</span>,<span class="dv">2</span>),</a>
<a class="sourceLine" id="cb22-10" title="10">    performance_metrics JSONB,</a>
<a class="sourceLine" id="cb22-11" title="11">    contracts JSONB,</a>
<a class="sourceLine" id="cb22-12" title="12">    status <span class="dt">VARCHAR</span>(<span class="dv">20</span>) <span class="kw">DEFAULT</span> <span class="st">&#39;active&#39;</span>,</a>
<a class="sourceLine" id="cb22-13" title="13">    created_at <span class="dt">TIMESTAMP</span> <span class="kw">DEFAULT</span> <span class="fu">CURRENT_TIMESTAMP</span>,</a>
<a class="sourceLine" id="cb22-14" title="14">    updated_at <span class="dt">TIMESTAMP</span> <span class="kw">DEFAULT</span> <span class="fu">CURRENT_TIMESTAMP</span>,</a>
<a class="sourceLine" id="cb22-15" title="15">    </a>
<a class="sourceLine" id="cb22-16" title="16">    <span class="co">-- Full-text search index</span></a>
<a class="sourceLine" id="cb22-17" title="17">    <span class="kw">INDEX</span> idx_vendor_search <span class="kw">USING</span> gin(to_tsvector(<span class="st">&#39;english&#39;</span>, vendor_name))</a>
<a class="sourceLine" id="cb22-18" title="18">);</a></code></pre></div>
<h4 id="budget-and-forecast-schema">3.1.3 Budget and Forecast Schema</h4>
<div class="sourceCode" id="cb23"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb23-1" title="1"><span class="kw">CREATE</span> <span class="kw">TABLE</span> budget_forecasts (</a>
<a class="sourceLine" id="cb23-2" title="2">    <span class="kw">id</span> UUID <span class="kw">PRIMARY</span> <span class="kw">KEY</span> <span class="kw">DEFAULT</span> gen_random_uuid(),</a>
<a class="sourceLine" id="cb23-3" title="3">    forecast_type <span class="dt">VARCHAR</span>(<span class="dv">20</span>) <span class="kw">NOT</span> <span class="kw">NULL</span>, <span class="co">-- &#39;budget&#39;, &#39;spend&#39;, &#39;cashflow&#39;</span></a>
<a class="sourceLine" id="cb23-4" title="4">    period_start <span class="dt">DATE</span> <span class="kw">NOT</span> <span class="kw">NULL</span>,</a>
<a class="sourceLine" id="cb23-5" title="5">    period_end <span class="dt">DATE</span> <span class="kw">NOT</span> <span class="kw">NULL</span>,</a>
<a class="sourceLine" id="cb23-6" title="6">    department_id UUID <span class="kw">REFERENCES</span> departments(<span class="kw">id</span>),</a>
<a class="sourceLine" id="cb23-7" title="7">    category_id UUID <span class="kw">REFERENCES</span> expense_categories(<span class="kw">id</span>),</a>
<a class="sourceLine" id="cb23-8" title="8">    forecast_values JSONB <span class="kw">NOT</span> <span class="kw">NULL</span>, <span class="co">-- time series data</span></a>
<a class="sourceLine" id="cb23-9" title="9">    confidence_intervals JSONB,</a>
<a class="sourceLine" id="cb23-10" title="10">    scenarios JSONB,</a>
<a class="sourceLine" id="cb23-11" title="11">    model_metadata JSONB,</a>
<a class="sourceLine" id="cb23-12" title="12">    accuracy_metrics JSONB,</a>
<a class="sourceLine" id="cb23-13" title="13">    created_at <span class="dt">TIMESTAMP</span> <span class="kw">DEFAULT</span> <span class="fu">CURRENT_TIMESTAMP</span>,</a>
<a class="sourceLine" id="cb23-14" title="14">    </a>
<a class="sourceLine" id="cb23-15" title="15">    <span class="kw">INDEX</span> idx_forecast_period (forecast_type, period_start, period_end),</a>
<a class="sourceLine" id="cb23-16" title="16">    <span class="kw">INDEX</span> idx_forecast_dept_cat (department_id, category_id)</a>
<a class="sourceLine" id="cb23-17" title="17">);</a></code></pre></div>
<h3 id="analytics-data-models">3.2 Analytics Data Models</h3>
<h4 id="spend-analytics-aggregation">3.2.1 Spend Analytics Aggregation</h4>
<div class="sourceCode" id="cb24"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb24-1" title="1"><span class="co">-- Materialized view for fast analytics queries</span></a>
<a class="sourceLine" id="cb24-2" title="2"><span class="kw">CREATE</span> <span class="kw">MATERIALIZED</span> <span class="kw">VIEW</span> spend_analytics_daily <span class="kw">AS</span></a>
<a class="sourceLine" id="cb24-3" title="3"><span class="kw">SELECT</span> </a>
<a class="sourceLine" id="cb24-4" title="4">    transaction_date,</a>
<a class="sourceLine" id="cb24-5" title="5">    department_id,</a>
<a class="sourceLine" id="cb24-6" title="6">    category_id,</a>
<a class="sourceLine" id="cb24-7" title="7">    vendor_id,</a>
<a class="sourceLine" id="cb24-8" title="8">    currency_code,</a>
<a class="sourceLine" id="cb24-9" title="9">    <span class="fu">COUNT</span>(<span class="op">*</span>) <span class="kw">as</span> transaction_count,</a>
<a class="sourceLine" id="cb24-10" title="10">    <span class="fu">SUM</span>(amount) <span class="kw">as</span> total_amount,</a>
<a class="sourceLine" id="cb24-11" title="11">    <span class="fu">AVG</span>(amount) <span class="kw">as</span> avg_amount,</a>
<a class="sourceLine" id="cb24-12" title="12">    <span class="fu">MIN</span>(amount) <span class="kw">as</span> min_amount,</a>
<a class="sourceLine" id="cb24-13" title="13">    <span class="fu">MAX</span>(amount) <span class="kw">as</span> max_amount,</a>
<a class="sourceLine" id="cb24-14" title="14">    <span class="fu">STDDEV</span>(amount) <span class="kw">as</span> amount_stddev</a>
<a class="sourceLine" id="cb24-15" title="15"><span class="kw">FROM</span> expense_transactions</a>
<a class="sourceLine" id="cb24-16" title="16"><span class="kw">WHERE</span> status <span class="op">=</span> <span class="st">&#39;approved&#39;</span></a>
<a class="sourceLine" id="cb24-17" title="17"><span class="kw">GROUP</span> <span class="kw">BY</span> transaction_date, department_id, category_id, vendor_id, currency_code;</a>
<a class="sourceLine" id="cb24-18" title="18"></a>
<a class="sourceLine" id="cb24-19" title="19"><span class="co">-- Refresh schedule for materialized view</span></a>
<a class="sourceLine" id="cb24-20" title="20"><span class="kw">CREATE</span> <span class="kw">INDEX</span> <span class="kw">ON</span> spend_analytics_daily (transaction_date, department_id);</a></code></pre></div>
<h4 id="anomaly-detection-results">3.2.2 Anomaly Detection Results</h4>
<div class="sourceCode" id="cb25"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb25-1" title="1"><span class="kw">CREATE</span> <span class="kw">TABLE</span> anomaly_detections (</a>
<a class="sourceLine" id="cb25-2" title="2">    <span class="kw">id</span> UUID <span class="kw">PRIMARY</span> <span class="kw">KEY</span> <span class="kw">DEFAULT</span> gen_random_uuid(),</a>
<a class="sourceLine" id="cb25-3" title="3">    transaction_id UUID <span class="kw">REFERENCES</span> expense_transactions(<span class="kw">id</span>),</a>
<a class="sourceLine" id="cb25-4" title="4">    anomaly_type <span class="dt">VARCHAR</span>(<span class="dv">50</span>) <span class="kw">NOT</span> <span class="kw">NULL</span>, <span class="co">-- &#39;statistical&#39;, &#39;fraud&#39;, &#39;vendor&#39;, &#39;employee&#39;</span></a>
<a class="sourceLine" id="cb25-5" title="5">    anomaly_score <span class="dt">DECIMAL</span>(<span class="dv">5</span>,<span class="dv">4</span>) <span class="kw">NOT</span> <span class="kw">NULL</span>,</a>
<a class="sourceLine" id="cb25-6" title="6">    confidence_level <span class="dt">DECIMAL</span>(<span class="dv">3</span>,<span class="dv">2</span>) <span class="kw">NOT</span> <span class="kw">NULL</span>,</a>
<a class="sourceLine" id="cb25-7" title="7">    indicators JSONB,</a>
<a class="sourceLine" id="cb25-8" title="8">    investigation_status <span class="dt">VARCHAR</span>(<span class="dv">20</span>) <span class="kw">DEFAULT</span> <span class="st">&#39;open&#39;</span>,</a>
<a class="sourceLine" id="cb25-9" title="9">    resolution JSONB,</a>
<a class="sourceLine" id="cb25-10" title="10">    detected_at <span class="dt">TIMESTAMP</span> <span class="kw">DEFAULT</span> <span class="fu">CURRENT_TIMESTAMP</span>,</a>
<a class="sourceLine" id="cb25-11" title="11">    resolved_at <span class="dt">TIMESTAMP</span>,</a>
<a class="sourceLine" id="cb25-12" title="12">    </a>
<a class="sourceLine" id="cb25-13" title="13">    <span class="kw">INDEX</span> idx_anomaly_type_score (anomaly_type, anomaly_score <span class="kw">DESC</span>),</a>
<a class="sourceLine" id="cb25-14" title="14">    <span class="kw">INDEX</span> idx_anomaly_status (investigation_status, detected_at)</a>
<a class="sourceLine" id="cb25-15" title="15">);</a></code></pre></div>
<h2 id="api-specifications">4. API Specifications</h2>
<h3 id="restful-api-endpoints">4.1 RESTful API Endpoints</h3>
<h4 id="expense-management-apis">4.1.1 Expense Management APIs</h4>
<div class="sourceCode" id="cb26"><pre class="sourceCode typescript"><code class="sourceCode typescript"><a class="sourceLine" id="cb26-1" title="1"><span class="co">// Expense submission and processing</span></a>
<a class="sourceLine" id="cb26-2" title="2">POST /api/v1/expenses</a>
<a class="sourceLine" id="cb26-3" title="3">GET /api/v1/expenses/<span class="op">{</span>id<span class="op">}</span></a>
<a class="sourceLine" id="cb26-4" title="4">PUT /api/v1/expenses/<span class="op">{</span>id<span class="op">}</span></a>
<a class="sourceLine" id="cb26-5" title="5">DELETE /api/v1/expenses/<span class="op">{</span>id<span class="op">}</span></a>
<a class="sourceLine" id="cb26-6" title="6"></a>
<a class="sourceLine" id="cb26-7" title="7"><span class="co">// Receipt processing</span></a>
<a class="sourceLine" id="cb26-8" title="8">POST /api/v1/expenses/receipts/upload</a>
<a class="sourceLine" id="cb26-9" title="9">POST /api/v1/expenses/receipts/<span class="bu">process</span></a>
<a class="sourceLine" id="cb26-10" title="10"></a>
<a class="sourceLine" id="cb26-11" title="11"><span class="co">// Policy compliance</span></a>
<a class="sourceLine" id="cb26-12" title="12">POST /api/v1/expenses/<span class="op">{</span>id<span class="op">}</span><span class="ss">/policy-check</span></a>
<a class="sourceLine" id="cb26-13" title="13"><span class="ss">GET /api/v1/expenses/{id}/approval</span><span class="op">-</span>workflow</a>
<a class="sourceLine" id="cb26-14" title="14"></a>
<a class="sourceLine" id="cb26-15" title="15"><span class="co">// Bulk operations</span></a>
<a class="sourceLine" id="cb26-16" title="16">POST /api/v1/expenses/bulk<span class="op">-</span><span class="im">import</span></a>
<a class="sourceLine" id="cb26-17" title="17">GET /api/v1/expenses/bulk<span class="op">-</span>status/<span class="op">{</span>jobId<span class="op">}</span></a></code></pre></div>
<h4 id="analytics-apis">4.1.2 Analytics APIs</h4>
<div class="sourceCode" id="cb27"><pre class="sourceCode typescript"><code class="sourceCode typescript"><a class="sourceLine" id="cb27-1" title="1"><span class="co">// Query and aggregation</span></a>
<a class="sourceLine" id="cb27-2" title="2">POST /api/v1/analytics/query</a>
<a class="sourceLine" id="cb27-3" title="3">GET /api/v1/analytics/dashboards/<span class="op">{</span>dashboardId<span class="op">}</span></a>
<a class="sourceLine" id="cb27-4" title="4">POST /api/v1/analytics/reports/generate</a>
<a class="sourceLine" id="cb27-5" title="5"></a>
<a class="sourceLine" id="cb27-6" title="6"><span class="co">// Real-time analytics</span></a>
<a class="sourceLine" id="cb27-7" title="7">GET /api/v1/analytics/realtime/metrics</a>
<a class="sourceLine" id="cb27-8" title="8"><span class="bu">WebSocket</span> /ws/analytics/realtime</a>
<a class="sourceLine" id="cb27-9" title="9"></a>
<a class="sourceLine" id="cb27-10" title="10"><span class="co">// Benchmarking</span></a>
<a class="sourceLine" id="cb27-11" title="11">GET /api/v1/analytics/benchmarks/industry</a>
<a class="sourceLine" id="cb27-12" title="12">GET /api/v1/analytics/benchmarks/peers</a></code></pre></div>
<h4 id="anomaly-detection-apis">4.1.3 Anomaly Detection APIs</h4>
<div class="sourceCode" id="cb28"><pre class="sourceCode typescript"><code class="sourceCode typescript"><a class="sourceLine" id="cb28-1" title="1"><span class="co">// Anomaly detection and investigation</span></a>
<a class="sourceLine" id="cb28-2" title="2">GET /api/v1/anomalies</a>
<a class="sourceLine" id="cb28-3" title="3">GET /api/v1/anomalies/<span class="op">{</span>id<span class="op">}</span></a>
<a class="sourceLine" id="cb28-4" title="4">POST /api/v1/anomalies/<span class="op">{</span>id<span class="op">}</span><span class="ss">/investigate</span></a>
<a class="sourceLine" id="cb28-5" title="5"><span class="ss">PUT /api/v1/anomalies/{id}/resolve</span></a>
<a class="sourceLine" id="cb28-6" title="6"></a>
<a class="sourceLine" id="cb28-7" title="7"><span class="co">// Fraud detection</span></a>
<a class="sourceLine" id="cb28-8" title="8">POST /api/v1/fraud/detect</a>
<a class="sourceLine" id="cb28-9" title="9">GET /api/v1/fraud/reports</a></code></pre></div>
<h3 id="graphql-schema">4.2 GraphQL Schema</h3>
<pre class="graphql"><code>type Query {
  expenses(filter: ExpenseFilter, pagination: Pagination): ExpenseConnection
  analytics(query: AnalyticsQuery): AnalyticsResult
  anomalies(filter: AnomalyFilter): [Anomaly]
  forecasts(type: ForecastType, period: DateRange): [Forecast]
}

type Mutation {
  createExpense(input: CreateExpenseInput): Expense
  processReceipt(file: Upload): ReceiptProcessingResult
  generateForecast(input: ForecastInput): Forecast
  resolveAnomaly(id: ID!, resolution: AnomalyResolution): Anomaly
}

type Subscription {
  expenseUpdates(filter: ExpenseFilter): Expense
  realtimeMetrics(dashboard: String): MetricUpdate
  anomalyAlerts: Anomaly
}</code></pre>
<h2 id="integration-patterns">5. Integration Patterns</h2>
<h3 id="erp-integration-architecture">5.1 ERP Integration Architecture</h3>
<div class="sourceCode" id="cb30"><pre class="sourceCode typescript"><code class="sourceCode typescript"><a class="sourceLine" id="cb30-1" title="1"><span class="kw">class</span> ERPIntegrationService <span class="op">{</span></a>
<a class="sourceLine" id="cb30-2" title="2">  <span class="kw">private</span> connectors<span class="op">:</span> <span class="bu">Map</span><span class="op">&lt;</span><span class="dt">string</span><span class="op">,</span> ERPConnector<span class="op">&gt;;</span></a>
<a class="sourceLine" id="cb30-3" title="3">  </a>
<a class="sourceLine" id="cb30-4" title="4">  <span class="kw">async</span> <span class="fu">syncExpenseData</span>(erpSystem<span class="op">:</span> <span class="dt">string</span><span class="op">,</span> syncConfig<span class="op">:</span> SyncConfig)<span class="op">:</span> <span class="bu">Promise</span><span class="op">&lt;</span>SyncResult<span class="op">&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb30-5" title="5">    <span class="kw">const</span> connector <span class="op">=</span> <span class="va">this</span><span class="op">.</span><span class="va">connectors</span><span class="op">.</span><span class="fu">get</span>(erpSystem)<span class="op">;</span></a>
<a class="sourceLine" id="cb30-6" title="6">    </a>
<a class="sourceLine" id="cb30-7" title="7">    <span class="co">// Extract data from ERP</span></a>
<a class="sourceLine" id="cb30-8" title="8">    <span class="kw">const</span> erpData <span class="op">=</span> <span class="cf">await</span> <span class="va">connector</span><span class="op">.</span><span class="fu">extractExpenseData</span>(syncConfig)<span class="op">;</span></a>
<a class="sourceLine" id="cb30-9" title="9">    </a>
<a class="sourceLine" id="cb30-10" title="10">    <span class="co">// Transform data to internal format</span></a>
<a class="sourceLine" id="cb30-11" title="11">    <span class="kw">const</span> transformedData <span class="op">=</span> <span class="cf">await</span> <span class="va">this</span><span class="op">.</span><span class="fu">transformData</span>(erpData<span class="op">,</span> erpSystem)<span class="op">;</span></a>
<a class="sourceLine" id="cb30-12" title="12">    </a>
<a class="sourceLine" id="cb30-13" title="13">    <span class="co">// Load data into analytics platform</span></a>
<a class="sourceLine" id="cb30-14" title="14">    <span class="kw">const</span> loadResult <span class="op">=</span> <span class="cf">await</span> <span class="va">this</span><span class="op">.</span><span class="fu">loadData</span>(transformedData)<span class="op">;</span></a>
<a class="sourceLine" id="cb30-15" title="15">    </a>
<a class="sourceLine" id="cb30-16" title="16">    <span class="co">// Update sync status</span></a>
<a class="sourceLine" id="cb30-17" title="17">    <span class="cf">await</span> <span class="va">this</span><span class="op">.</span><span class="fu">updateSyncStatus</span>(erpSystem<span class="op">,</span> loadResult)<span class="op">;</span></a>
<a class="sourceLine" id="cb30-18" title="18">    </a>
<a class="sourceLine" id="cb30-19" title="19">    <span class="cf">return</span> loadResult<span class="op">;</span></a>
<a class="sourceLine" id="cb30-20" title="20">  <span class="op">}</span></a>
<a class="sourceLine" id="cb30-21" title="21"><span class="op">}</span></a>
<a class="sourceLine" id="cb30-22" title="22"></a>
<a class="sourceLine" id="cb30-23" title="23"><span class="co">// SAP Integration Connector</span></a>
<a class="sourceLine" id="cb30-24" title="24"><span class="kw">class</span> SAPConnector <span class="kw">implements</span> ERPConnector <span class="op">{</span></a>
<a class="sourceLine" id="cb30-25" title="25">  <span class="kw">async</span> <span class="fu">extractExpenseData</span>(config<span class="op">:</span> SyncConfig)<span class="op">:</span> <span class="bu">Promise</span><span class="op">&lt;</span>ERPData<span class="op">[]&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb30-26" title="26">    <span class="co">// RFC calls to SAP for expense data</span></a>
<a class="sourceLine" id="cb30-27" title="27">    <span class="co">// Handle SAP-specific data formats and structures</span></a>
<a class="sourceLine" id="cb30-28" title="28">  <span class="op">}</span></a>
<a class="sourceLine" id="cb30-29" title="29"><span class="op">}</span></a></code></pre></div>
<h3 id="banking-integration">5.2 Banking Integration</h3>
<div class="sourceCode" id="cb31"><pre class="sourceCode typescript"><code class="sourceCode typescript"><a class="sourceLine" id="cb31-1" title="1"><span class="kw">class</span> BankingIntegrationService <span class="op">{</span></a>
<a class="sourceLine" id="cb31-2" title="2">  <span class="kw">async</span> <span class="fu">processBankFeed</span>(bankCode<span class="op">:</span> <span class="dt">string</span><span class="op">,</span> feedData<span class="op">:</span> BankFeedData)<span class="op">:</span> <span class="bu">Promise</span><span class="op">&lt;</span>ProcessingResult<span class="op">&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb31-3" title="3">    <span class="co">// Parse bank feed format (MT940, OFX, CSV)</span></a>
<a class="sourceLine" id="cb31-4" title="4">    <span class="kw">const</span> transactions <span class="op">=</span> <span class="cf">await</span> <span class="va">this</span><span class="op">.</span><span class="fu">parseBankFeed</span>(feedData)<span class="op">;</span></a>
<a class="sourceLine" id="cb31-5" title="5">    </a>
<a class="sourceLine" id="cb31-6" title="6">    <span class="co">// Match transactions with internal expense records</span></a>
<a class="sourceLine" id="cb31-7" title="7">    <span class="kw">const</span> matchedTransactions <span class="op">=</span> <span class="cf">await</span> <span class="va">this</span><span class="op">.</span><span class="fu">matchTransactions</span>(transactions)<span class="op">;</span></a>
<a class="sourceLine" id="cb31-8" title="8">    </a>
<a class="sourceLine" id="cb31-9" title="9">    <span class="co">// Create expense records for unmatched transactions</span></a>
<a class="sourceLine" id="cb31-10" title="10">    <span class="kw">const</span> newExpenses <span class="op">=</span> <span class="cf">await</span> <span class="va">this</span><span class="op">.</span><span class="fu">createExpenseRecords</span>(<span class="va">matchedTransactions</span><span class="op">.</span><span class="at">unmatched</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb31-11" title="11">    </a>
<a class="sourceLine" id="cb31-12" title="12">    <span class="cf">return</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb31-13" title="13">      matched<span class="op">:</span> <span class="va">matchedTransactions</span><span class="op">.</span><span class="va">matched</span><span class="op">.</span><span class="at">length</span><span class="op">,</span></a>
<a class="sourceLine" id="cb31-14" title="14">      created<span class="op">:</span> <span class="va">newExpenses</span><span class="op">.</span><span class="at">length</span><span class="op">,</span></a>
<a class="sourceLine" id="cb31-15" title="15">      errors<span class="op">:</span> <span class="va">matchedTransactions</span><span class="op">.</span><span class="at">errors</span></a>
<a class="sourceLine" id="cb31-16" title="16">    <span class="op">};</span></a>
<a class="sourceLine" id="cb31-17" title="17">  <span class="op">}</span></a>
<a class="sourceLine" id="cb31-18" title="18"><span class="op">}</span></a></code></pre></div>
<p>This HLD provides comprehensive component specifications, data models, APIs, and integration patterns that build upon all previous documents, ensuring implementation-ready designs for the finance spend analytics platform. # Low Level Design (LLD) ## Finance Spend Analytics and Optimization Platform</p>
<p><em>Building upon PRD, FRD, NFRD, AD, and HLD for implementation-ready specifications</em></p>
<h2 id="etvx-framework-5">ETVX Framework</h2>
<h3 id="entry-criteria-5">ENTRY CRITERIA</h3>
<ul>
<li>✅ PRD completed with business objectives and success metrics</li>
<li>✅ FRD completed with 40 functional requirements across 8 modules</li>
<li>✅ NFRD completed with 35 non-functional requirements</li>
<li>✅ AD completed with microservices architecture and technology stack</li>
<li>✅ HLD completed with detailed component specifications, data models, and API designs</li>
<li>✅ Component interfaces and processing workflows defined</li>
</ul>
<h3 id="task-5">TASK</h3>
<p>Create implementation-ready low-level design specifications including detailed class structures, database schemas, API implementations, algorithm specifications, configuration files, and deployment scripts that enable direct development of the finance spend analytics platform.</p>
<h3 id="verification-validation-5">VERIFICATION &amp; VALIDATION</h3>
<p><strong>Verification</strong>: All HLD components have corresponding LLD implementations with complete class structures and database schemas <strong>Validation</strong>: LLD specifications reviewed with development teams and validated for direct implementation</p>
<h3 id="exit-criteria-5">EXIT CRITERIA</h3>
<ul>
<li>✅ Complete class diagrams and implementation structures</li>
<li>✅ Detailed database schemas with indexes and constraints</li>
<li>✅ API implementation specifications with request/response formats</li>
<li>✅ Algorithm implementations for ML and analytics components</li>
<li>✅ Configuration and deployment specifications</li>
<li>✅ Foundation prepared for pseudocode and implementation</li>
</ul>
<hr />
<h3 id="reference-to-previous-documents-4">Reference to Previous Documents</h3>
<p>This LLD builds upon <strong>PRD</strong>, <strong>FRD</strong>, <strong>NFRD</strong>, <strong>AD</strong>, and <strong>HLD</strong> foundations: - <strong>PRD Success Metrics</strong> → Implementation supporting 15% cost savings, 30% processing reduction, 90% accuracy - <strong>FRD Functional Requirements</strong> → Implementation classes for all 40 functional requirements - <strong>NFRD Performance Requirements</strong> → Implementation optimized for &lt;3s response time, 99.9% uptime - <strong>AD Technology Stack</strong> → Implementation using specified technologies (Node.js, Python, TensorFlow, PostgreSQL) - <strong>HLD Component Specifications</strong> → Detailed class implementations for all HLD components</p>
<h2 id="database-schema-implementation">1. Database Schema Implementation</h2>
<h3 id="core-transaction-tables">1.1 Core Transaction Tables</h3>
<div class="sourceCode" id="cb32"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb32-1" title="1"><span class="co">-- Expense transactions with optimized indexes</span></a>
<a class="sourceLine" id="cb32-2" title="2"><span class="kw">CREATE</span> <span class="kw">TABLE</span> expense_transactions (</a>
<a class="sourceLine" id="cb32-3" title="3">    <span class="kw">id</span> UUID <span class="kw">PRIMARY</span> <span class="kw">KEY</span> <span class="kw">DEFAULT</span> gen_random_uuid(),</a>
<a class="sourceLine" id="cb32-4" title="4">    transaction_date <span class="dt">DATE</span> <span class="kw">NOT</span> <span class="kw">NULL</span>,</a>
<a class="sourceLine" id="cb32-5" title="5">    amount <span class="dt">DECIMAL</span>(<span class="dv">15</span>,<span class="dv">2</span>) <span class="kw">NOT</span> <span class="kw">NULL</span> <span class="kw">CHECK</span> (amount <span class="op">&gt;</span> <span class="dv">0</span>),</a>
<a class="sourceLine" id="cb32-6" title="6">    currency_code <span class="dt">VARCHAR</span>(<span class="dv">3</span>) <span class="kw">NOT</span> <span class="kw">NULL</span> <span class="kw">DEFAULT</span> <span class="st">&#39;USD&#39;</span>,</a>
<a class="sourceLine" id="cb32-7" title="7">    vendor_id UUID <span class="kw">NOT</span> <span class="kw">NULL</span> <span class="kw">REFERENCES</span> vendors(<span class="kw">id</span>),</a>
<a class="sourceLine" id="cb32-8" title="8">    category_id UUID <span class="kw">NOT</span> <span class="kw">NULL</span> <span class="kw">REFERENCES</span> expense_categories(<span class="kw">id</span>),</a>
<a class="sourceLine" id="cb32-9" title="9">    department_id UUID <span class="kw">NOT</span> <span class="kw">NULL</span> <span class="kw">REFERENCES</span> departments(<span class="kw">id</span>),</a>
<a class="sourceLine" id="cb32-10" title="10">    employee_id UUID <span class="kw">NOT</span> <span class="kw">NULL</span> <span class="kw">REFERENCES</span> employees(<span class="kw">id</span>),</a>
<a class="sourceLine" id="cb32-11" title="11">    description TEXT,</a>
<a class="sourceLine" id="cb32-12" title="12">    receipt_url <span class="dt">VARCHAR</span>(<span class="dv">500</span>),</a>
<a class="sourceLine" id="cb32-13" title="13">    receipt_data JSONB,</a>
<a class="sourceLine" id="cb32-14" title="14">    status expense_status <span class="kw">NOT</span> <span class="kw">NULL</span> <span class="kw">DEFAULT</span> <span class="st">&#39;pending&#39;</span>,</a>
<a class="sourceLine" id="cb32-15" title="15">    policy_violations JSONB <span class="kw">DEFAULT</span> <span class="st">&#39;[]&#39;</span>,</a>
<a class="sourceLine" id="cb32-16" title="16">    approval_workflow JSONB,</a>
<a class="sourceLine" id="cb32-17" title="17">    ml_category_confidence <span class="dt">DECIMAL</span>(<span class="dv">3</span>,<span class="dv">2</span>),</a>
<a class="sourceLine" id="cb32-18" title="18">    anomaly_score <span class="dt">DECIMAL</span>(<span class="dv">5</span>,<span class="dv">4</span>),</a>
<a class="sourceLine" id="cb32-19" title="19">    created_at <span class="dt">TIMESTAMP</span> <span class="kw">WITH</span> <span class="dt">TIME</span> <span class="dt">ZONE</span> <span class="kw">DEFAULT</span> <span class="fu">CURRENT_TIMESTAMP</span>,</a>
<a class="sourceLine" id="cb32-20" title="20">    updated_at <span class="dt">TIMESTAMP</span> <span class="kw">WITH</span> <span class="dt">TIME</span> <span class="dt">ZONE</span> <span class="kw">DEFAULT</span> <span class="fu">CURRENT_TIMESTAMP</span>,</a>
<a class="sourceLine" id="cb32-21" title="21">    version <span class="dt">INTEGER</span> <span class="kw">DEFAULT</span> <span class="dv">1</span>,</a>
<a class="sourceLine" id="cb32-22" title="22">    </a>
<a class="sourceLine" id="cb32-23" title="23">    <span class="co">-- Performance indexes</span></a>
<a class="sourceLine" id="cb32-24" title="24">    <span class="kw">CONSTRAINT</span> valid_amount <span class="kw">CHECK</span> (amount <span class="op">&gt;</span> <span class="dv">0</span> <span class="kw">AND</span> amount <span class="op">&lt;</span> <span class="dv">1000000</span>),</a>
<a class="sourceLine" id="cb32-25" title="25">    <span class="kw">CONSTRAINT</span> valid_confidence <span class="kw">CHECK</span> (ml_category_confidence <span class="kw">BETWEEN</span> <span class="dv">0</span> <span class="kw">AND</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb32-26" title="26">);</a>
<a class="sourceLine" id="cb32-27" title="27"></a>
<a class="sourceLine" id="cb32-28" title="28"><span class="co">-- Optimized indexes for query performance</span></a>
<a class="sourceLine" id="cb32-29" title="29"><span class="kw">CREATE</span> <span class="kw">INDEX</span> CONCURRENTLY idx_expense_date_dept <span class="kw">ON</span> expense_transactions </a>
<a class="sourceLine" id="cb32-30" title="30">    <span class="kw">USING</span> btree (transaction_date <span class="kw">DESC</span>, department_id);</a>
<a class="sourceLine" id="cb32-31" title="31"><span class="kw">CREATE</span> <span class="kw">INDEX</span> CONCURRENTLY idx_expense_vendor_amount <span class="kw">ON</span> expense_transactions </a>
<a class="sourceLine" id="cb32-32" title="32">    <span class="kw">USING</span> btree (vendor_id, amount <span class="kw">DESC</span>);</a>
<a class="sourceLine" id="cb32-33" title="33"><span class="kw">CREATE</span> <span class="kw">INDEX</span> CONCURRENTLY idx_expense_category_status <span class="kw">ON</span> expense_transactions </a>
<a class="sourceLine" id="cb32-34" title="34">    <span class="kw">USING</span> btree (category_id, status);</a>
<a class="sourceLine" id="cb32-35" title="35"><span class="kw">CREATE</span> <span class="kw">INDEX</span> CONCURRENTLY idx_expense_employee_date <span class="kw">ON</span> expense_transactions </a>
<a class="sourceLine" id="cb32-36" title="36">    <span class="kw">USING</span> btree (employee_id, transaction_date <span class="kw">DESC</span>);</a>
<a class="sourceLine" id="cb32-37" title="37"><span class="kw">CREATE</span> <span class="kw">INDEX</span> CONCURRENTLY idx_expense_anomaly <span class="kw">ON</span> expense_transactions </a>
<a class="sourceLine" id="cb32-38" title="38">    <span class="kw">USING</span> btree (anomaly_score <span class="kw">DESC</span>) <span class="kw">WHERE</span> anomaly_score <span class="op">&gt;</span> <span class="fl">0.7</span>;</a>
<a class="sourceLine" id="cb32-39" title="39"></a>
<a class="sourceLine" id="cb32-40" title="40"><span class="co">-- Partitioning for large datasets</span></a>
<a class="sourceLine" id="cb32-41" title="41"><span class="kw">CREATE</span> <span class="kw">TABLE</span> expense_transactions_y2024 <span class="kw">PARTITION</span> <span class="kw">OF</span> expense_transactions</a>
<a class="sourceLine" id="cb32-42" title="42">    <span class="cf">FOR</span> <span class="kw">VALUES</span> <span class="kw">FROM</span> (<span class="st">&#39;2024-01-01&#39;</span>) <span class="kw">TO</span> (<span class="st">&#39;2025-01-01&#39;</span>);</a></code></pre></div>
<h3 id="analytics-aggregation-tables">1.2 Analytics Aggregation Tables</h3>
<div class="sourceCode" id="cb33"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb33-1" title="1"><span class="co">-- Pre-aggregated data for fast analytics</span></a>
<a class="sourceLine" id="cb33-2" title="2"><span class="kw">CREATE</span> <span class="kw">TABLE</span> spend_analytics_monthly (</a>
<a class="sourceLine" id="cb33-3" title="3">    <span class="kw">id</span> UUID <span class="kw">PRIMARY</span> <span class="kw">KEY</span> <span class="kw">DEFAULT</span> gen_random_uuid(),</a>
<a class="sourceLine" id="cb33-4" title="4">    year_month <span class="dt">DATE</span> <span class="kw">NOT</span> <span class="kw">NULL</span>,</a>
<a class="sourceLine" id="cb33-5" title="5">    department_id UUID <span class="kw">REFERENCES</span> departments(<span class="kw">id</span>),</a>
<a class="sourceLine" id="cb33-6" title="6">    category_id UUID <span class="kw">REFERENCES</span> expense_categories(<span class="kw">id</span>),</a>
<a class="sourceLine" id="cb33-7" title="7">    vendor_id UUID <span class="kw">REFERENCES</span> vendors(<span class="kw">id</span>),</a>
<a class="sourceLine" id="cb33-8" title="8">    currency_code <span class="dt">VARCHAR</span>(<span class="dv">3</span>) <span class="kw">NOT</span> <span class="kw">NULL</span>,</a>
<a class="sourceLine" id="cb33-9" title="9">    transaction_count <span class="dt">INTEGER</span> <span class="kw">NOT</span> <span class="kw">NULL</span>,</a>
<a class="sourceLine" id="cb33-10" title="10">    total_amount <span class="dt">DECIMAL</span>(<span class="dv">15</span>,<span class="dv">2</span>) <span class="kw">NOT</span> <span class="kw">NULL</span>,</a>
<a class="sourceLine" id="cb33-11" title="11">    avg_amount <span class="dt">DECIMAL</span>(<span class="dv">15</span>,<span class="dv">2</span>) <span class="kw">NOT</span> <span class="kw">NULL</span>,</a>
<a class="sourceLine" id="cb33-12" title="12">    median_amount <span class="dt">DECIMAL</span>(<span class="dv">15</span>,<span class="dv">2</span>),</a>
<a class="sourceLine" id="cb33-13" title="13">    std_deviation <span class="dt">DECIMAL</span>(<span class="dv">15</span>,<span class="dv">2</span>),</a>
<a class="sourceLine" id="cb33-14" title="14">    min_amount <span class="dt">DECIMAL</span>(<span class="dv">15</span>,<span class="dv">2</span>) <span class="kw">NOT</span> <span class="kw">NULL</span>,</a>
<a class="sourceLine" id="cb33-15" title="15">    max_amount <span class="dt">DECIMAL</span>(<span class="dv">15</span>,<span class="dv">2</span>) <span class="kw">NOT</span> <span class="kw">NULL</span>,</a>
<a class="sourceLine" id="cb33-16" title="16">    policy_violation_count <span class="dt">INTEGER</span> <span class="kw">DEFAULT</span> <span class="dv">0</span>,</a>
<a class="sourceLine" id="cb33-17" title="17">    anomaly_count <span class="dt">INTEGER</span> <span class="kw">DEFAULT</span> <span class="dv">0</span>,</a>
<a class="sourceLine" id="cb33-18" title="18">    created_at <span class="dt">TIMESTAMP</span> <span class="kw">WITH</span> <span class="dt">TIME</span> <span class="dt">ZONE</span> <span class="kw">DEFAULT</span> <span class="fu">CURRENT_TIMESTAMP</span>,</a>
<a class="sourceLine" id="cb33-19" title="19">    </a>
<a class="sourceLine" id="cb33-20" title="20">    <span class="kw">UNIQUE</span>(year_month, department_id, category_id, vendor_id, currency_code)</a>
<a class="sourceLine" id="cb33-21" title="21">);</a>
<a class="sourceLine" id="cb33-22" title="22"></a>
<a class="sourceLine" id="cb33-23" title="23"><span class="co">-- Materialized view for real-time analytics</span></a>
<a class="sourceLine" id="cb33-24" title="24"><span class="kw">CREATE</span> <span class="kw">MATERIALIZED</span> <span class="kw">VIEW</span> spend_realtime_metrics <span class="kw">AS</span></a>
<a class="sourceLine" id="cb33-25" title="25"><span class="kw">SELECT</span> </a>
<a class="sourceLine" id="cb33-26" title="26">    DATE_TRUNC(<span class="st">&#39;hour&#39;</span>, created_at) <span class="kw">as</span> hour_bucket,</a>
<a class="sourceLine" id="cb33-27" title="27">    department_id,</a>
<a class="sourceLine" id="cb33-28" title="28">    <span class="fu">COUNT</span>(<span class="op">*</span>) <span class="kw">as</span> hourly_transactions,</a>
<a class="sourceLine" id="cb33-29" title="29">    <span class="fu">SUM</span>(amount) <span class="kw">as</span> hourly_spend,</a>
<a class="sourceLine" id="cb33-30" title="30">    <span class="fu">AVG</span>(amount) <span class="kw">as</span> avg_transaction_size,</a>
<a class="sourceLine" id="cb33-31" title="31">    <span class="fu">COUNT</span>(<span class="op">*</span>) <span class="kw">FILTER</span> (<span class="kw">WHERE</span> anomaly_score <span class="op">&gt;</span> <span class="fl">0.7</span>) <span class="kw">as</span> anomaly_count</a>
<a class="sourceLine" id="cb33-32" title="32"><span class="kw">FROM</span> expense_transactions</a>
<a class="sourceLine" id="cb33-33" title="33"><span class="kw">WHERE</span> created_at <span class="op">&gt;=</span> <span class="fu">CURRENT_TIMESTAMP</span> <span class="op">-</span> <span class="dt">INTERVAL</span> <span class="st">&#39;24 hours&#39;</span></a>
<a class="sourceLine" id="cb33-34" title="34"><span class="kw">GROUP</span> <span class="kw">BY</span> hour_bucket, department_id;</a>
<a class="sourceLine" id="cb33-35" title="35"></a>
<a class="sourceLine" id="cb33-36" title="36"><span class="co">-- Auto-refresh materialized view</span></a>
<a class="sourceLine" id="cb33-37" title="37"><span class="kw">CREATE</span> <span class="kw">OR</span> <span class="kw">REPLACE</span> <span class="kw">FUNCTION</span> refresh_realtime_metrics()</a>
<a class="sourceLine" id="cb33-38" title="38">RETURNS void <span class="kw">AS</span> $$</a>
<a class="sourceLine" id="cb33-39" title="39"><span class="cf">BEGIN</span></a>
<a class="sourceLine" id="cb33-40" title="40">    <span class="kw">REFRESH</span> <span class="kw">MATERIALIZED</span> <span class="kw">VIEW</span> CONCURRENTLY spend_realtime_metrics;</a>
<a class="sourceLine" id="cb33-41" title="41"><span class="cf">END</span>;</a>
<a class="sourceLine" id="cb33-42" title="42">$$ LANGUAGE plpgsql;</a>
<a class="sourceLine" id="cb33-43" title="43"></a>
<a class="sourceLine" id="cb33-44" title="44"><span class="kw">SELECT</span> cron.schedule(<span class="st">&#39;refresh-realtime-metrics&#39;</span>, <span class="st">&#39;*/5 * * * *&#39;</span>, <span class="st">&#39;SELECT refresh_realtime_metrics();&#39;</span>);</a></code></pre></div>
<h3 id="ml-model-metadata-tables">1.3 ML Model Metadata Tables</h3>
<div class="sourceCode" id="cb34"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb34-1" title="1"><span class="co">-- ML model registry and versioning</span></a>
<a class="sourceLine" id="cb34-2" title="2"><span class="kw">CREATE</span> <span class="kw">TABLE</span> ml_models (</a>
<a class="sourceLine" id="cb34-3" title="3">    <span class="kw">id</span> UUID <span class="kw">PRIMARY</span> <span class="kw">KEY</span> <span class="kw">DEFAULT</span> gen_random_uuid(),</a>
<a class="sourceLine" id="cb34-4" title="4">    model_name <span class="dt">VARCHAR</span>(<span class="dv">100</span>) <span class="kw">NOT</span> <span class="kw">NULL</span>,</a>
<a class="sourceLine" id="cb34-5" title="5">    model_type <span class="dt">VARCHAR</span>(<span class="dv">50</span>) <span class="kw">NOT</span> <span class="kw">NULL</span>, <span class="co">-- &#39;categorization&#39;, &#39;anomaly&#39;, &#39;forecast&#39;</span></a>
<a class="sourceLine" id="cb34-6" title="6">    version <span class="dt">VARCHAR</span>(<span class="dv">20</span>) <span class="kw">NOT</span> <span class="kw">NULL</span>,</a>
<a class="sourceLine" id="cb34-7" title="7">    model_path <span class="dt">VARCHAR</span>(<span class="dv">500</span>) <span class="kw">NOT</span> <span class="kw">NULL</span>,</a>
<a class="sourceLine" id="cb34-8" title="8">    training_data_hash <span class="dt">VARCHAR</span>(<span class="dv">64</span>),</a>
<a class="sourceLine" id="cb34-9" title="9">    hyperparameters JSONB,</a>
<a class="sourceLine" id="cb34-10" title="10">    performance_metrics JSONB,</a>
<a class="sourceLine" id="cb34-11" title="11">    feature_importance JSONB,</a>
<a class="sourceLine" id="cb34-12" title="12">    is_active <span class="dt">BOOLEAN</span> <span class="kw">DEFAULT</span> <span class="kw">false</span>,</a>
<a class="sourceLine" id="cb34-13" title="13">    created_at <span class="dt">TIMESTAMP</span> <span class="kw">WITH</span> <span class="dt">TIME</span> <span class="dt">ZONE</span> <span class="kw">DEFAULT</span> <span class="fu">CURRENT_TIMESTAMP</span>,</a>
<a class="sourceLine" id="cb34-14" title="14">    </a>
<a class="sourceLine" id="cb34-15" title="15">    <span class="kw">UNIQUE</span>(model_name, version)</a>
<a class="sourceLine" id="cb34-16" title="16">);</a>
<a class="sourceLine" id="cb34-17" title="17"></a>
<a class="sourceLine" id="cb34-18" title="18"><span class="co">-- Model training history and experiments</span></a>
<a class="sourceLine" id="cb34-19" title="19"><span class="kw">CREATE</span> <span class="kw">TABLE</span> model_training_runs (</a>
<a class="sourceLine" id="cb34-20" title="20">    <span class="kw">id</span> UUID <span class="kw">PRIMARY</span> <span class="kw">KEY</span> <span class="kw">DEFAULT</span> gen_random_uuid(),</a>
<a class="sourceLine" id="cb34-21" title="21">    model_id UUID <span class="kw">REFERENCES</span> ml_models(<span class="kw">id</span>),</a>
<a class="sourceLine" id="cb34-22" title="22">    training_start <span class="dt">TIMESTAMP</span> <span class="kw">WITH</span> <span class="dt">TIME</span> <span class="dt">ZONE</span> <span class="kw">NOT</span> <span class="kw">NULL</span>,</a>
<a class="sourceLine" id="cb34-23" title="23">    training_end <span class="dt">TIMESTAMP</span> <span class="kw">WITH</span> <span class="dt">TIME</span> <span class="dt">ZONE</span>,</a>
<a class="sourceLine" id="cb34-24" title="24">    training_data_size <span class="dt">INTEGER</span>,</a>
<a class="sourceLine" id="cb34-25" title="25">    validation_accuracy <span class="dt">DECIMAL</span>(<span class="dv">5</span>,<span class="dv">4</span>),</a>
<a class="sourceLine" id="cb34-26" title="26">    test_accuracy <span class="dt">DECIMAL</span>(<span class="dv">5</span>,<span class="dv">4</span>),</a>
<a class="sourceLine" id="cb34-27" title="27">    training_loss <span class="dt">DECIMAL</span>(<span class="dv">10</span>,<span class="dv">6</span>),</a>
<a class="sourceLine" id="cb34-28" title="28">    validation_loss <span class="dt">DECIMAL</span>(<span class="dv">10</span>,<span class="dv">6</span>),</a>
<a class="sourceLine" id="cb34-29" title="29">    training_config JSONB,</a>
<a class="sourceLine" id="cb34-30" title="30">    status <span class="dt">VARCHAR</span>(<span class="dv">20</span>) <span class="kw">DEFAULT</span> <span class="st">&#39;running&#39;</span>,</a>
<a class="sourceLine" id="cb34-31" title="31">    error_message TEXT,</a>
<a class="sourceLine" id="cb34-32" title="32">    </a>
<a class="sourceLine" id="cb34-33" title="33">    <span class="kw">INDEX</span> idx_training_model_date (model_id, training_start <span class="kw">DESC</span>)</a>
<a class="sourceLine" id="cb34-34" title="34">);</a></code></pre></div>
<h2 id="core-service-implementation-classes">2. Core Service Implementation Classes</h2>
<h3 id="expense-management-service-classes">2.1 Expense Management Service Classes</h3>
<h4 id="receipt-ocr-processor-implementation">2.1.1 Receipt OCR Processor Implementation</h4>
<div class="sourceCode" id="cb35"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb35-1" title="1"><span class="im">from</span> typing <span class="im">import</span> Dict, List, Optional, Tuple</a>
<a class="sourceLine" id="cb35-2" title="2"><span class="im">import</span> cv2</a>
<a class="sourceLine" id="cb35-3" title="3"><span class="im">import</span> pytesseract</a>
<a class="sourceLine" id="cb35-4" title="4"><span class="im">import</span> spacy</a>
<a class="sourceLine" id="cb35-5" title="5"><span class="im">import</span> numpy <span class="im">as</span> np</a>
<a class="sourceLine" id="cb35-6" title="6"><span class="im">from</span> dataclasses <span class="im">import</span> dataclass</a>
<a class="sourceLine" id="cb35-7" title="7"><span class="im">from</span> decimal <span class="im">import</span> Decimal</a>
<a class="sourceLine" id="cb35-8" title="8"><span class="im">import</span> re</a>
<a class="sourceLine" id="cb35-9" title="9"><span class="im">from</span> datetime <span class="im">import</span> datetime</a>
<a class="sourceLine" id="cb35-10" title="10"></a>
<a class="sourceLine" id="cb35-11" title="11"><span class="at">@dataclass</span></a>
<a class="sourceLine" id="cb35-12" title="12"><span class="kw">class</span> ExtractedReceiptData:</a>
<a class="sourceLine" id="cb35-13" title="13">    vendor_name: Optional[<span class="bu">str</span>]</a>
<a class="sourceLine" id="cb35-14" title="14">    amount: Optional[Decimal]</a>
<a class="sourceLine" id="cb35-15" title="15">    date: Optional[datetime]</a>
<a class="sourceLine" id="cb35-16" title="16">    tax_amount: Optional[Decimal]</a>
<a class="sourceLine" id="cb35-17" title="17">    line_items: List[Dict]</a>
<a class="sourceLine" id="cb35-18" title="18">    confidence_score: <span class="bu">float</span></a>
<a class="sourceLine" id="cb35-19" title="19">    raw_text: <span class="bu">str</span></a>
<a class="sourceLine" id="cb35-20" title="20"></a>
<a class="sourceLine" id="cb35-21" title="21"><span class="kw">class</span> ReceiptOCRProcessor:</a>
<a class="sourceLine" id="cb35-22" title="22">    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</a>
<a class="sourceLine" id="cb35-23" title="23">        <span class="va">self</span>.nlp <span class="op">=</span> spacy.load(<span class="st">&quot;en_core_web_sm&quot;</span>)</a>
<a class="sourceLine" id="cb35-24" title="24">        <span class="va">self</span>.amount_pattern <span class="op">=</span> re.<span class="bu">compile</span>(<span class="vs">r&#39;\$?(\d{1,3}(?:,\d</span><span class="sc">{3}</span><span class="vs">)*(?:\.\d</span><span class="sc">{2}</span><span class="vs">)?)&#39;</span>)</a>
<a class="sourceLine" id="cb35-25" title="25">        <span class="va">self</span>.date_patterns <span class="op">=</span> [</a>
<a class="sourceLine" id="cb35-26" title="26">            re.<span class="bu">compile</span>(<span class="vs">r&#39;(\d{1,2})/(\d{1,2})/(\d{2,4})&#39;</span>),</a>
<a class="sourceLine" id="cb35-27" title="27">            re.<span class="bu">compile</span>(<span class="vs">r&#39;(\d{1,2})-(\d{1,2})-(\d{2,4})&#39;</span>),</a>
<a class="sourceLine" id="cb35-28" title="28">            re.<span class="bu">compile</span>(<span class="vs">r&#39;(\w</span><span class="sc">{3}</span><span class="vs">)\s+(\d{1,2}),?\s+(\d</span><span class="sc">{4}</span><span class="vs">)&#39;</span>)</a>
<a class="sourceLine" id="cb35-29" title="29">        ]</a>
<a class="sourceLine" id="cb35-30" title="30">    </a>
<a class="sourceLine" id="cb35-31" title="31">    <span class="cf">async</span> <span class="kw">def</span> process_receipt(<span class="va">self</span>, image_data: <span class="bu">bytes</span>) <span class="op">-&gt;</span> ExtractedReceiptData:</a>
<a class="sourceLine" id="cb35-32" title="32">        <span class="co">&quot;&quot;&quot;Process receipt image and extract structured data&quot;&quot;&quot;</span></a>
<a class="sourceLine" id="cb35-33" title="33">        <span class="cf">try</span>:</a>
<a class="sourceLine" id="cb35-34" title="34">            <span class="co"># Image preprocessing</span></a>
<a class="sourceLine" id="cb35-35" title="35">            enhanced_image <span class="op">=</span> <span class="va">self</span>._enhance_image(image_data)</a>
<a class="sourceLine" id="cb35-36" title="36">            </a>
<a class="sourceLine" id="cb35-37" title="37">            <span class="co"># OCR text extraction</span></a>
<a class="sourceLine" id="cb35-38" title="38">            raw_text <span class="op">=</span> <span class="va">self</span>._extract_text(enhanced_image)</a>
<a class="sourceLine" id="cb35-39" title="39">            </a>
<a class="sourceLine" id="cb35-40" title="40">            <span class="co"># NLP-based data extraction</span></a>
<a class="sourceLine" id="cb35-41" title="41">            extracted_data <span class="op">=</span> <span class="va">self</span>._extract_structured_data(raw_text)</a>
<a class="sourceLine" id="cb35-42" title="42">            </a>
<a class="sourceLine" id="cb35-43" title="43">            <span class="co"># Validate and score confidence</span></a>
<a class="sourceLine" id="cb35-44" title="44">            validated_data <span class="op">=</span> <span class="va">self</span>._validate_and_score(extracted_data, raw_text)</a>
<a class="sourceLine" id="cb35-45" title="45">            </a>
<a class="sourceLine" id="cb35-46" title="46">            <span class="cf">return</span> validated_data</a>
<a class="sourceLine" id="cb35-47" title="47">            </a>
<a class="sourceLine" id="cb35-48" title="48">        <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</a>
<a class="sourceLine" id="cb35-49" title="49">            <span class="cf">return</span> ExtractedReceiptData(</a>
<a class="sourceLine" id="cb35-50" title="50">                vendor_name<span class="op">=</span><span class="va">None</span>, amount<span class="op">=</span><span class="va">None</span>, date<span class="op">=</span><span class="va">None</span>,</a>
<a class="sourceLine" id="cb35-51" title="51">                tax_amount<span class="op">=</span><span class="va">None</span>, line_items<span class="op">=</span>[], confidence_score<span class="op">=</span><span class="fl">0.0</span>,</a>
<a class="sourceLine" id="cb35-52" title="52">                raw_text<span class="op">=</span><span class="bu">str</span>(e)</a>
<a class="sourceLine" id="cb35-53" title="53">            )</a>
<a class="sourceLine" id="cb35-54" title="54">    </a>
<a class="sourceLine" id="cb35-55" title="55">    <span class="kw">def</span> _enhance_image(<span class="va">self</span>, image_data: <span class="bu">bytes</span>) <span class="op">-&gt;</span> np.ndarray:</a>
<a class="sourceLine" id="cb35-56" title="56">        <span class="co">&quot;&quot;&quot;Enhance image quality for better OCR&quot;&quot;&quot;</span></a>
<a class="sourceLine" id="cb35-57" title="57">        <span class="co"># Convert bytes to numpy array</span></a>
<a class="sourceLine" id="cb35-58" title="58">        nparr <span class="op">=</span> np.frombuffer(image_data, np.uint8)</a>
<a class="sourceLine" id="cb35-59" title="59">        image <span class="op">=</span> cv2.imdecode(nparr, cv2.IMREAD_COLOR)</a>
<a class="sourceLine" id="cb35-60" title="60">        </a>
<a class="sourceLine" id="cb35-61" title="61">        <span class="co"># Convert to grayscale</span></a>
<a class="sourceLine" id="cb35-62" title="62">        gray <span class="op">=</span> cv2.cvtColor(image, cv2.COLOR_BGR2GRAY)</a>
<a class="sourceLine" id="cb35-63" title="63">        </a>
<a class="sourceLine" id="cb35-64" title="64">        <span class="co"># Noise reduction</span></a>
<a class="sourceLine" id="cb35-65" title="65">        denoised <span class="op">=</span> cv2.fastNlMeansDenoising(gray)</a>
<a class="sourceLine" id="cb35-66" title="66">        </a>
<a class="sourceLine" id="cb35-67" title="67">        <span class="co"># Contrast enhancement</span></a>
<a class="sourceLine" id="cb35-68" title="68">        clahe <span class="op">=</span> cv2.createCLAHE(clipLimit<span class="op">=</span><span class="fl">2.0</span>, tileGridSize<span class="op">=</span>(<span class="dv">8</span>,<span class="dv">8</span>))</a>
<a class="sourceLine" id="cb35-69" title="69">        enhanced <span class="op">=</span> clahe.<span class="bu">apply</span>(denoised)</a>
<a class="sourceLine" id="cb35-70" title="70">        </a>
<a class="sourceLine" id="cb35-71" title="71">        <span class="co"># Deskewing</span></a>
<a class="sourceLine" id="cb35-72" title="72">        coords <span class="op">=</span> np.column_stack(np.where(enhanced <span class="op">&gt;</span> <span class="dv">0</span>))</a>
<a class="sourceLine" id="cb35-73" title="73">        angle <span class="op">=</span> cv2.minAreaRect(coords)[<span class="op">-</span><span class="dv">1</span>]</a>
<a class="sourceLine" id="cb35-74" title="74">        <span class="cf">if</span> angle <span class="op">&lt;</span> <span class="dv">-45</span>:</a>
<a class="sourceLine" id="cb35-75" title="75">            angle <span class="op">=</span> <span class="op">-</span>(<span class="dv">90</span> <span class="op">+</span> angle)</a>
<a class="sourceLine" id="cb35-76" title="76">        <span class="cf">else</span>:</a>
<a class="sourceLine" id="cb35-77" title="77">            angle <span class="op">=</span> <span class="op">-</span>angle</a>
<a class="sourceLine" id="cb35-78" title="78">        </a>
<a class="sourceLine" id="cb35-79" title="79">        (h, w) <span class="op">=</span> enhanced.shape[:<span class="dv">2</span>]</a>
<a class="sourceLine" id="cb35-80" title="80">        center <span class="op">=</span> (w <span class="op">//</span> <span class="dv">2</span>, h <span class="op">//</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb35-81" title="81">        M <span class="op">=</span> cv2.getRotationMatrix2D(center, angle, <span class="fl">1.0</span>)</a>
<a class="sourceLine" id="cb35-82" title="82">        rotated <span class="op">=</span> cv2.warpAffine(enhanced, M, (w, h), </a>
<a class="sourceLine" id="cb35-83" title="83">                                flags<span class="op">=</span>cv2.INTER_CUBIC, </a>
<a class="sourceLine" id="cb35-84" title="84">                                borderMode<span class="op">=</span>cv2.BORDER_REPLICATE)</a>
<a class="sourceLine" id="cb35-85" title="85">        </a>
<a class="sourceLine" id="cb35-86" title="86">        <span class="cf">return</span> rotated</a>
<a class="sourceLine" id="cb35-87" title="87">    </a>
<a class="sourceLine" id="cb35-88" title="88">    <span class="kw">def</span> _extract_text(<span class="va">self</span>, image: np.ndarray) <span class="op">-&gt;</span> <span class="bu">str</span>:</a>
<a class="sourceLine" id="cb35-89" title="89">        <span class="co">&quot;&quot;&quot;Extract text using Tesseract OCR&quot;&quot;&quot;</span></a>
<a class="sourceLine" id="cb35-90" title="90">        config <span class="op">=</span> <span class="st">&#39;--oem 3 --psm 6 -c tessedit_char_whitelist=0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz.,/$-: &#39;</span></a>
<a class="sourceLine" id="cb35-91" title="91">        text <span class="op">=</span> pytesseract.image_to_string(image, config<span class="op">=</span>config)</a>
<a class="sourceLine" id="cb35-92" title="92">        <span class="cf">return</span> text.strip()</a>
<a class="sourceLine" id="cb35-93" title="93">    </a>
<a class="sourceLine" id="cb35-94" title="94">    <span class="kw">def</span> _extract_structured_data(<span class="va">self</span>, text: <span class="bu">str</span>) <span class="op">-&gt;</span> Dict:</a>
<a class="sourceLine" id="cb35-95" title="95">        <span class="co">&quot;&quot;&quot;Extract structured data using NLP&quot;&quot;&quot;</span></a>
<a class="sourceLine" id="cb35-96" title="96">        doc <span class="op">=</span> <span class="va">self</span>.nlp(text)</a>
<a class="sourceLine" id="cb35-97" title="97">        </a>
<a class="sourceLine" id="cb35-98" title="98">        <span class="co"># Extract vendor name (usually first organization entity)</span></a>
<a class="sourceLine" id="cb35-99" title="99">        vendor_name <span class="op">=</span> <span class="va">None</span></a>
<a class="sourceLine" id="cb35-100" title="100">        <span class="cf">for</span> ent <span class="kw">in</span> doc.ents:</a>
<a class="sourceLine" id="cb35-101" title="101">            <span class="cf">if</span> ent.label_ <span class="op">==</span> <span class="st">&quot;ORG&quot;</span>:</a>
<a class="sourceLine" id="cb35-102" title="102">                vendor_name <span class="op">=</span> ent.text</a>
<a class="sourceLine" id="cb35-103" title="103">                <span class="cf">break</span></a>
<a class="sourceLine" id="cb35-104" title="104">        </a>
<a class="sourceLine" id="cb35-105" title="105">        <span class="co"># Extract amounts</span></a>
<a class="sourceLine" id="cb35-106" title="106">        amounts <span class="op">=</span> []</a>
<a class="sourceLine" id="cb35-107" title="107">        <span class="cf">for</span> match <span class="kw">in</span> <span class="va">self</span>.amount_pattern.finditer(text):</a>
<a class="sourceLine" id="cb35-108" title="108">            <span class="cf">try</span>:</a>
<a class="sourceLine" id="cb35-109" title="109">                amount <span class="op">=</span> Decimal(match.group(<span class="dv">1</span>).replace(<span class="st">&#39;,&#39;</span>, <span class="st">&#39;&#39;</span>))</a>
<a class="sourceLine" id="cb35-110" title="110">                amounts.append(amount)</a>
<a class="sourceLine" id="cb35-111" title="111">            <span class="cf">except</span>:</a>
<a class="sourceLine" id="cb35-112" title="112">                <span class="cf">continue</span></a>
<a class="sourceLine" id="cb35-113" title="113">        </a>
<a class="sourceLine" id="cb35-114" title="114">        <span class="co"># Extract date</span></a>
<a class="sourceLine" id="cb35-115" title="115">        date <span class="op">=</span> <span class="va">None</span></a>
<a class="sourceLine" id="cb35-116" title="116">        <span class="cf">for</span> pattern <span class="kw">in</span> <span class="va">self</span>.date_patterns:</a>
<a class="sourceLine" id="cb35-117" title="117">            match <span class="op">=</span> pattern.search(text)</a>
<a class="sourceLine" id="cb35-118" title="118">            <span class="cf">if</span> match:</a>
<a class="sourceLine" id="cb35-119" title="119">                <span class="cf">try</span>:</a>
<a class="sourceLine" id="cb35-120" title="120">                    date <span class="op">=</span> <span class="va">self</span>._parse_date(match.groups())</a>
<a class="sourceLine" id="cb35-121" title="121">                    <span class="cf">break</span></a>
<a class="sourceLine" id="cb35-122" title="122">                <span class="cf">except</span>:</a>
<a class="sourceLine" id="cb35-123" title="123">                    <span class="cf">continue</span></a>
<a class="sourceLine" id="cb35-124" title="124">        </a>
<a class="sourceLine" id="cb35-125" title="125">        <span class="co"># Determine total amount (usually the largest amount)</span></a>
<a class="sourceLine" id="cb35-126" title="126">        total_amount <span class="op">=</span> <span class="bu">max</span>(amounts) <span class="cf">if</span> amounts <span class="cf">else</span> <span class="va">None</span></a>
<a class="sourceLine" id="cb35-127" title="127">        </a>
<a class="sourceLine" id="cb35-128" title="128">        <span class="cf">return</span> {</a>
<a class="sourceLine" id="cb35-129" title="129">            <span class="st">&#39;vendor_name&#39;</span>: vendor_name,</a>
<a class="sourceLine" id="cb35-130" title="130">            <span class="st">&#39;amount&#39;</span>: total_amount,</a>
<a class="sourceLine" id="cb35-131" title="131">            <span class="st">&#39;date&#39;</span>: date,</a>
<a class="sourceLine" id="cb35-132" title="132">            <span class="st">&#39;amounts&#39;</span>: amounts,</a>
<a class="sourceLine" id="cb35-133" title="133">            <span class="st">&#39;raw_text&#39;</span>: text</a>
<a class="sourceLine" id="cb35-134" title="134">        }</a>
<a class="sourceLine" id="cb35-135" title="135">    </a>
<a class="sourceLine" id="cb35-136" title="136">    <span class="kw">def</span> _validate_and_score(<span class="va">self</span>, data: Dict, raw_text: <span class="bu">str</span>) <span class="op">-&gt;</span> ExtractedReceiptData:</a>
<a class="sourceLine" id="cb35-137" title="137">        <span class="co">&quot;&quot;&quot;Validate extracted data and calculate confidence score&quot;&quot;&quot;</span></a>
<a class="sourceLine" id="cb35-138" title="138">        confidence_factors <span class="op">=</span> []</a>
<a class="sourceLine" id="cb35-139" title="139">        </a>
<a class="sourceLine" id="cb35-140" title="140">        <span class="co"># Vendor name confidence</span></a>
<a class="sourceLine" id="cb35-141" title="141">        <span class="cf">if</span> data[<span class="st">&#39;vendor_name&#39;</span>]:</a>
<a class="sourceLine" id="cb35-142" title="142">            confidence_factors.append(<span class="fl">0.3</span>)</a>
<a class="sourceLine" id="cb35-143" title="143">        </a>
<a class="sourceLine" id="cb35-144" title="144">        <span class="co"># Amount confidence</span></a>
<a class="sourceLine" id="cb35-145" title="145">        <span class="cf">if</span> data[<span class="st">&#39;amount&#39;</span>] <span class="kw">and</span> data[<span class="st">&#39;amount&#39;</span>] <span class="op">&gt;</span> <span class="dv">0</span>:</a>
<a class="sourceLine" id="cb35-146" title="146">            confidence_factors.append(<span class="fl">0.4</span>)</a>
<a class="sourceLine" id="cb35-147" title="147">        </a>
<a class="sourceLine" id="cb35-148" title="148">        <span class="co"># Date confidence</span></a>
<a class="sourceLine" id="cb35-149" title="149">        <span class="cf">if</span> data[<span class="st">&#39;date&#39;</span>]:</a>
<a class="sourceLine" id="cb35-150" title="150">            confidence_factors.append(<span class="fl">0.2</span>)</a>
<a class="sourceLine" id="cb35-151" title="151">        </a>
<a class="sourceLine" id="cb35-152" title="152">        <span class="co"># Text quality confidence</span></a>
<a class="sourceLine" id="cb35-153" title="153">        text_quality <span class="op">=</span> <span class="bu">len</span>([c <span class="cf">for</span> c <span class="kw">in</span> raw_text <span class="cf">if</span> c.isalnum()]) <span class="op">/</span> <span class="bu">max</span>(<span class="bu">len</span>(raw_text), <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb35-154" title="154">        confidence_factors.append(<span class="bu">min</span>(text_quality, <span class="fl">0.1</span>))</a>
<a class="sourceLine" id="cb35-155" title="155">        </a>
<a class="sourceLine" id="cb35-156" title="156">        confidence_score <span class="op">=</span> <span class="bu">sum</span>(confidence_factors)</a>
<a class="sourceLine" id="cb35-157" title="157">        </a>
<a class="sourceLine" id="cb35-158" title="158">        <span class="cf">return</span> ExtractedReceiptData(</a>
<a class="sourceLine" id="cb35-159" title="159">            vendor_name<span class="op">=</span>data[<span class="st">&#39;vendor_name&#39;</span>],</a>
<a class="sourceLine" id="cb35-160" title="160">            amount<span class="op">=</span>data[<span class="st">&#39;amount&#39;</span>],</a>
<a class="sourceLine" id="cb35-161" title="161">            date<span class="op">=</span>data[<span class="st">&#39;date&#39;</span>],</a>
<a class="sourceLine" id="cb35-162" title="162">            tax_amount<span class="op">=</span><span class="va">None</span>,  <span class="co"># </span><span class="al">TODO</span><span class="co">: Implement tax extraction</span></a>
<a class="sourceLine" id="cb35-163" title="163">            line_items<span class="op">=</span>[],    <span class="co"># </span><span class="al">TODO</span><span class="co">: Implement line item extraction</span></a>
<a class="sourceLine" id="cb35-164" title="164">            confidence_score<span class="op">=</span>confidence_score,</a>
<a class="sourceLine" id="cb35-165" title="165">            raw_text<span class="op">=</span>raw_text</a>
<a class="sourceLine" id="cb35-166" title="166">        )</a></code></pre></div>
<h4 id="ml-categorization-engine-implementation">2.1.2 ML Categorization Engine Implementation</h4>
<div class="sourceCode" id="cb36"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb36-1" title="1"><span class="im">import</span> tensorflow <span class="im">as</span> tf</a>
<a class="sourceLine" id="cb36-2" title="2"><span class="im">from</span> transformers <span class="im">import</span> AutoTokenizer, TFAutoModel</a>
<a class="sourceLine" id="cb36-3" title="3"><span class="im">import</span> numpy <span class="im">as</span> np</a>
<a class="sourceLine" id="cb36-4" title="4"><span class="im">from</span> typing <span class="im">import</span> Dict, List, Tuple</a>
<a class="sourceLine" id="cb36-5" title="5"><span class="im">import</span> joblib</a>
<a class="sourceLine" id="cb36-6" title="6"><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> LabelEncoder</a>
<a class="sourceLine" id="cb36-7" title="7"><span class="im">import</span> redis</a>
<a class="sourceLine" id="cb36-8" title="8"><span class="im">import</span> json</a>
<a class="sourceLine" id="cb36-9" title="9"></a>
<a class="sourceLine" id="cb36-10" title="10"><span class="at">@dataclass</span></a>
<a class="sourceLine" id="cb36-11" title="11"><span class="kw">class</span> CategoryPrediction:</a>
<a class="sourceLine" id="cb36-12" title="12">    category_id: <span class="bu">str</span></a>
<a class="sourceLine" id="cb36-13" title="13">    category_name: <span class="bu">str</span></a>
<a class="sourceLine" id="cb36-14" title="14">    confidence: <span class="bu">float</span></a>
<a class="sourceLine" id="cb36-15" title="15">    subcategory: Optional[<span class="bu">str</span>] <span class="op">=</span> <span class="va">None</span></a>
<a class="sourceLine" id="cb36-16" title="16"></a>
<a class="sourceLine" id="cb36-17" title="17"><span class="kw">class</span> MLCategorizationEngine:</a>
<a class="sourceLine" id="cb36-18" title="18">    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, model_path: <span class="bu">str</span>, redis_client: redis.Redis):</a>
<a class="sourceLine" id="cb36-19" title="19">        <span class="va">self</span>.model_path <span class="op">=</span> model_path</a>
<a class="sourceLine" id="cb36-20" title="20">        <span class="va">self</span>.redis_client <span class="op">=</span> redis_client</a>
<a class="sourceLine" id="cb36-21" title="21">        <span class="va">self</span>.tokenizer <span class="op">=</span> AutoTokenizer.from_pretrained(<span class="st">&#39;bert-base-uncased&#39;</span>)</a>
<a class="sourceLine" id="cb36-22" title="22">        <span class="va">self</span>.model <span class="op">=</span> <span class="va">None</span></a>
<a class="sourceLine" id="cb36-23" title="23">        <span class="va">self</span>.label_encoder <span class="op">=</span> <span class="va">None</span></a>
<a class="sourceLine" id="cb36-24" title="24">        <span class="va">self</span>.category_mapping <span class="op">=</span> {}</a>
<a class="sourceLine" id="cb36-25" title="25">        <span class="va">self</span>._load_model()</a>
<a class="sourceLine" id="cb36-26" title="26">    </a>
<a class="sourceLine" id="cb36-27" title="27">    <span class="kw">def</span> _load_model(<span class="va">self</span>):</a>
<a class="sourceLine" id="cb36-28" title="28">        <span class="co">&quot;&quot;&quot;Load trained categorization model&quot;&quot;&quot;</span></a>
<a class="sourceLine" id="cb36-29" title="29">        <span class="cf">try</span>:</a>
<a class="sourceLine" id="cb36-30" title="30">            <span class="co"># Load TensorFlow model</span></a>
<a class="sourceLine" id="cb36-31" title="31">            <span class="va">self</span>.model <span class="op">=</span> tf.keras.models.load_model(<span class="ss">f&quot;</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>model_path<span class="sc">}</span><span class="ss">/categorization_model&quot;</span>)</a>
<a class="sourceLine" id="cb36-32" title="32">            </a>
<a class="sourceLine" id="cb36-33" title="33">            <span class="co"># Load label encoder</span></a>
<a class="sourceLine" id="cb36-34" title="34">            <span class="va">self</span>.label_encoder <span class="op">=</span> joblib.load(<span class="ss">f&quot;</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>model_path<span class="sc">}</span><span class="ss">/label_encoder.pkl&quot;</span>)</a>
<a class="sourceLine" id="cb36-35" title="35">            </a>
<a class="sourceLine" id="cb36-36" title="36">            <span class="co"># Load category mapping</span></a>
<a class="sourceLine" id="cb36-37" title="37">            <span class="cf">with</span> <span class="bu">open</span>(<span class="ss">f&quot;</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>model_path<span class="sc">}</span><span class="ss">/category_mapping.json&quot;</span>, <span class="st">&#39;r&#39;</span>) <span class="im">as</span> f:</a>
<a class="sourceLine" id="cb36-38" title="38">                <span class="va">self</span>.category_mapping <span class="op">=</span> json.load(f)</a>
<a class="sourceLine" id="cb36-39" title="39">                </a>
<a class="sourceLine" id="cb36-40" title="40">        <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</a>
<a class="sourceLine" id="cb36-41" title="41">            <span class="cf">raise</span> <span class="pp">Exception</span>(<span class="ss">f&quot;Failed to load categorization model: </span><span class="sc">{</span><span class="bu">str</span>(e)<span class="sc">}</span><span class="ss">&quot;</span>)</a>
<a class="sourceLine" id="cb36-42" title="42">    </a>
<a class="sourceLine" id="cb36-43" title="43">    <span class="cf">async</span> <span class="kw">def</span> categorize_expense(<span class="va">self</span>, expense_data: Dict) <span class="op">-&gt;</span> CategoryPrediction:</a>
<a class="sourceLine" id="cb36-44" title="44">        <span class="co">&quot;&quot;&quot;Categorize expense using ML model&quot;&quot;&quot;</span></a>
<a class="sourceLine" id="cb36-45" title="45">        <span class="cf">try</span>:</a>
<a class="sourceLine" id="cb36-46" title="46">            <span class="co"># Check cache first</span></a>
<a class="sourceLine" id="cb36-47" title="47">            cache_key <span class="op">=</span> <span class="va">self</span>._generate_cache_key(expense_data)</a>
<a class="sourceLine" id="cb36-48" title="48">            cached_result <span class="op">=</span> <span class="va">self</span>.redis_client.get(cache_key)</a>
<a class="sourceLine" id="cb36-49" title="49">            <span class="cf">if</span> cached_result:</a>
<a class="sourceLine" id="cb36-50" title="50">                <span class="cf">return</span> CategoryPrediction(<span class="op">**</span>json.loads(cached_result))</a>
<a class="sourceLine" id="cb36-51" title="51">            </a>
<a class="sourceLine" id="cb36-52" title="52">            <span class="co"># Extract features</span></a>
<a class="sourceLine" id="cb36-53" title="53">            features <span class="op">=</span> <span class="va">self</span>._extract_features(expense_data)</a>
<a class="sourceLine" id="cb36-54" title="54">            </a>
<a class="sourceLine" id="cb36-55" title="55">            <span class="co"># Get BERT embeddings</span></a>
<a class="sourceLine" id="cb36-56" title="56">            embeddings <span class="op">=</span> <span class="va">self</span>._get_bert_embeddings(features[<span class="st">&#39;text&#39;</span>])</a>
<a class="sourceLine" id="cb36-57" title="57">            </a>
<a class="sourceLine" id="cb36-58" title="58">            <span class="co"># Combine with numerical features</span></a>
<a class="sourceLine" id="cb36-59" title="59">            combined_features <span class="op">=</span> np.concatenate([</a>
<a class="sourceLine" id="cb36-60" title="60">                embeddings,</a>
<a class="sourceLine" id="cb36-61" title="61">                features[<span class="st">&#39;numerical&#39;</span>]</a>
<a class="sourceLine" id="cb36-62" title="62">            ])</a>
<a class="sourceLine" id="cb36-63" title="63">            </a>
<a class="sourceLine" id="cb36-64" title="64">            <span class="co"># Predict category</span></a>
<a class="sourceLine" id="cb36-65" title="65">            prediction <span class="op">=</span> <span class="va">self</span>.model.predict(combined_features.reshape(<span class="dv">1</span>, <span class="dv">-1</span>))</a>
<a class="sourceLine" id="cb36-66" title="66">            predicted_class <span class="op">=</span> np.argmax(prediction[<span class="dv">0</span>])</a>
<a class="sourceLine" id="cb36-67" title="67">            confidence <span class="op">=</span> <span class="bu">float</span>(np.<span class="bu">max</span>(prediction[<span class="dv">0</span>]))</a>
<a class="sourceLine" id="cb36-68" title="68">            </a>
<a class="sourceLine" id="cb36-69" title="69">            <span class="co"># Decode prediction</span></a>
<a class="sourceLine" id="cb36-70" title="70">            category_name <span class="op">=</span> <span class="va">self</span>.label_encoder.inverse_transform([predicted_class])[<span class="dv">0</span>]</a>
<a class="sourceLine" id="cb36-71" title="71">            category_id <span class="op">=</span> <span class="va">self</span>.category_mapping.get(category_name, <span class="st">&#39;unknown&#39;</span>)</a>
<a class="sourceLine" id="cb36-72" title="72">            </a>
<a class="sourceLine" id="cb36-73" title="73">            result <span class="op">=</span> CategoryPrediction(</a>
<a class="sourceLine" id="cb36-74" title="74">                category_id<span class="op">=</span>category_id,</a>
<a class="sourceLine" id="cb36-75" title="75">                category_name<span class="op">=</span>category_name,</a>
<a class="sourceLine" id="cb36-76" title="76">                confidence<span class="op">=</span>confidence</a>
<a class="sourceLine" id="cb36-77" title="77">            )</a>
<a class="sourceLine" id="cb36-78" title="78">            </a>
<a class="sourceLine" id="cb36-79" title="79">            <span class="co"># Cache result</span></a>
<a class="sourceLine" id="cb36-80" title="80">            <span class="va">self</span>.redis_client.setex(</a>
<a class="sourceLine" id="cb36-81" title="81">                cache_key, <span class="dv">3600</span>,  <span class="co"># 1 hour TTL</span></a>
<a class="sourceLine" id="cb36-82" title="82">                json.dumps(result.__dict__)</a>
<a class="sourceLine" id="cb36-83" title="83">            )</a>
<a class="sourceLine" id="cb36-84" title="84">            </a>
<a class="sourceLine" id="cb36-85" title="85">            <span class="cf">return</span> result</a>
<a class="sourceLine" id="cb36-86" title="86">            </a>
<a class="sourceLine" id="cb36-87" title="87">        <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</a>
<a class="sourceLine" id="cb36-88" title="88">            <span class="co"># Return default category on error</span></a>
<a class="sourceLine" id="cb36-89" title="89">            <span class="cf">return</span> CategoryPrediction(</a>
<a class="sourceLine" id="cb36-90" title="90">                category_id<span class="op">=</span><span class="st">&#39;misc&#39;</span>,</a>
<a class="sourceLine" id="cb36-91" title="91">                category_name<span class="op">=</span><span class="st">&#39;Miscellaneous&#39;</span>,</a>
<a class="sourceLine" id="cb36-92" title="92">                confidence<span class="op">=</span><span class="fl">0.0</span></a>
<a class="sourceLine" id="cb36-93" title="93">            )</a>
<a class="sourceLine" id="cb36-94" title="94">    </a>
<a class="sourceLine" id="cb36-95" title="95">    <span class="kw">def</span> _extract_features(<span class="va">self</span>, expense_data: Dict) <span class="op">-&gt;</span> Dict:</a>
<a class="sourceLine" id="cb36-96" title="96">        <span class="co">&quot;&quot;&quot;Extract features for ML model&quot;&quot;&quot;</span></a>
<a class="sourceLine" id="cb36-97" title="97">        <span class="co"># Text features</span></a>
<a class="sourceLine" id="cb36-98" title="98">        text_parts <span class="op">=</span> []</a>
<a class="sourceLine" id="cb36-99" title="99">        <span class="cf">if</span> expense_data.get(<span class="st">&#39;description&#39;</span>):</a>
<a class="sourceLine" id="cb36-100" title="100">            text_parts.append(expense_data[<span class="st">&#39;description&#39;</span>])</a>
<a class="sourceLine" id="cb36-101" title="101">        <span class="cf">if</span> expense_data.get(<span class="st">&#39;vendor_name&#39;</span>):</a>
<a class="sourceLine" id="cb36-102" title="102">            text_parts.append(expense_data[<span class="st">&#39;vendor_name&#39;</span>])</a>
<a class="sourceLine" id="cb36-103" title="103">        </a>
<a class="sourceLine" id="cb36-104" title="104">        text_feature <span class="op">=</span> <span class="st">&#39; &#39;</span>.join(text_parts).lower()</a>
<a class="sourceLine" id="cb36-105" title="105">        </a>
<a class="sourceLine" id="cb36-106" title="106">        <span class="co"># Numerical features</span></a>
<a class="sourceLine" id="cb36-107" title="107">        amount <span class="op">=</span> <span class="bu">float</span>(expense_data.get(<span class="st">&#39;amount&#39;</span>, <span class="dv">0</span>))</a>
<a class="sourceLine" id="cb36-108" title="108">        day_of_week <span class="op">=</span> expense_data.get(<span class="st">&#39;transaction_date&#39;</span>, datetime.now()).weekday()</a>
<a class="sourceLine" id="cb36-109" title="109">        hour_of_day <span class="op">=</span> expense_data.get(<span class="st">&#39;transaction_date&#39;</span>, datetime.now()).hour</a>
<a class="sourceLine" id="cb36-110" title="110">        </a>
<a class="sourceLine" id="cb36-111" title="111">        <span class="co"># Amount buckets (log scale)</span></a>
<a class="sourceLine" id="cb36-112" title="112">        amount_bucket <span class="op">=</span> <span class="bu">int</span>(np.log10(<span class="bu">max</span>(amount, <span class="dv">1</span>)))</a>
<a class="sourceLine" id="cb36-113" title="113">        </a>
<a class="sourceLine" id="cb36-114" title="114">        numerical_features <span class="op">=</span> np.array([</a>
<a class="sourceLine" id="cb36-115" title="115">            amount,</a>
<a class="sourceLine" id="cb36-116" title="116">            day_of_week,</a>
<a class="sourceLine" id="cb36-117" title="117">            hour_of_day,</a>
<a class="sourceLine" id="cb36-118" title="118">            amount_bucket</a>
<a class="sourceLine" id="cb36-119" title="119">        ])</a>
<a class="sourceLine" id="cb36-120" title="120">        </a>
<a class="sourceLine" id="cb36-121" title="121">        <span class="cf">return</span> {</a>
<a class="sourceLine" id="cb36-122" title="122">            <span class="st">&#39;text&#39;</span>: text_feature,</a>
<a class="sourceLine" id="cb36-123" title="123">            <span class="st">&#39;numerical&#39;</span>: numerical_features</a>
<a class="sourceLine" id="cb36-124" title="124">        }</a>
<a class="sourceLine" id="cb36-125" title="125">    </a>
<a class="sourceLine" id="cb36-126" title="126">    <span class="kw">def</span> _get_bert_embeddings(<span class="va">self</span>, text: <span class="bu">str</span>) <span class="op">-&gt;</span> np.ndarray:</a>
<a class="sourceLine" id="cb36-127" title="127">        <span class="co">&quot;&quot;&quot;Get BERT embeddings for text&quot;&quot;&quot;</span></a>
<a class="sourceLine" id="cb36-128" title="128">        <span class="co"># Tokenize text</span></a>
<a class="sourceLine" id="cb36-129" title="129">        tokens <span class="op">=</span> <span class="va">self</span>.tokenizer(</a>
<a class="sourceLine" id="cb36-130" title="130">            text,</a>
<a class="sourceLine" id="cb36-131" title="131">            max_length<span class="op">=</span><span class="dv">128</span>,</a>
<a class="sourceLine" id="cb36-132" title="132">            truncation<span class="op">=</span><span class="va">True</span>,</a>
<a class="sourceLine" id="cb36-133" title="133">            padding<span class="op">=</span><span class="st">&#39;max_length&#39;</span>,</a>
<a class="sourceLine" id="cb36-134" title="134">            return_tensors<span class="op">=</span><span class="st">&#39;tf&#39;</span></a>
<a class="sourceLine" id="cb36-135" title="135">        )</a>
<a class="sourceLine" id="cb36-136" title="136">        </a>
<a class="sourceLine" id="cb36-137" title="137">        <span class="co"># Get embeddings from pre-trained BERT</span></a>
<a class="sourceLine" id="cb36-138" title="138">        bert_model <span class="op">=</span> TFAutoModel.from_pretrained(<span class="st">&#39;bert-base-uncased&#39;</span>)</a>
<a class="sourceLine" id="cb36-139" title="139">        outputs <span class="op">=</span> bert_model(tokens)</a>
<a class="sourceLine" id="cb36-140" title="140">        </a>
<a class="sourceLine" id="cb36-141" title="141">        <span class="co"># Use CLS token embedding</span></a>
<a class="sourceLine" id="cb36-142" title="142">        cls_embedding <span class="op">=</span> outputs.last_hidden_state[:, <span class="dv">0</span>, :].numpy()</a>
<a class="sourceLine" id="cb36-143" title="143">        </a>
<a class="sourceLine" id="cb36-144" title="144">        <span class="cf">return</span> cls_embedding.flatten()</a>
<a class="sourceLine" id="cb36-145" title="145">    </a>
<a class="sourceLine" id="cb36-146" title="146">    <span class="kw">def</span> _generate_cache_key(<span class="va">self</span>, expense_data: Dict) <span class="op">-&gt;</span> <span class="bu">str</span>:</a>
<a class="sourceLine" id="cb36-147" title="147">        <span class="co">&quot;&quot;&quot;Generate cache key for expense data&quot;&quot;&quot;</span></a>
<a class="sourceLine" id="cb36-148" title="148">        key_parts <span class="op">=</span> [</a>
<a class="sourceLine" id="cb36-149" title="149">            expense_data.get(<span class="st">&#39;description&#39;</span>, <span class="st">&#39;&#39;</span>),</a>
<a class="sourceLine" id="cb36-150" title="150">            expense_data.get(<span class="st">&#39;vendor_name&#39;</span>, <span class="st">&#39;&#39;</span>),</a>
<a class="sourceLine" id="cb36-151" title="151">            <span class="bu">str</span>(expense_data.get(<span class="st">&#39;amount&#39;</span>, <span class="dv">0</span>))</a>
<a class="sourceLine" id="cb36-152" title="152">        ]</a>
<a class="sourceLine" id="cb36-153" title="153">        <span class="cf">return</span> <span class="ss">f&quot;categorization:</span><span class="sc">{</span><span class="bu">hash</span>(<span class="st">&#39;|&#39;</span>.join(key_parts))<span class="sc">}</span><span class="ss">&quot;</span></a></code></pre></div>
<h3 id="analytics-service-implementation">2.2 Analytics Service Implementation</h3>
<h4 id="analytics-query-engine-1">2.2.1 Analytics Query Engine</h4>
<div class="sourceCode" id="cb37"><pre class="sourceCode typescript"><code class="sourceCode typescript"><a class="sourceLine" id="cb37-1" title="1"><span class="im">import</span> <span class="op">{</span> Pool <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;pg&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb37-2" title="2"><span class="im">import</span> Redis <span class="im">from</span> <span class="st">&#39;ioredis&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb37-3" title="3"><span class="im">import</span> <span class="op">{</span> ClickHouse <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;clickhouse&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb37-4" title="4"></a>
<a class="sourceLine" id="cb37-5" title="5"><span class="kw">interface</span> AnalyticsQuery <span class="op">{</span></a>
<a class="sourceLine" id="cb37-6" title="6">  dimensions<span class="op">:</span> <span class="dt">string</span><span class="op">[];</span></a>
<a class="sourceLine" id="cb37-7" title="7">  metrics<span class="op">:</span> <span class="dt">string</span><span class="op">[];</span></a>
<a class="sourceLine" id="cb37-8" title="8">  filters<span class="op">:</span> QueryFilter<span class="op">[];</span></a>
<a class="sourceLine" id="cb37-9" title="9">  dateRange<span class="op">:</span> DateRange<span class="op">;</span></a>
<a class="sourceLine" id="cb37-10" title="10">  groupBy<span class="op">?:</span> <span class="dt">string</span><span class="op">[];</span></a>
<a class="sourceLine" id="cb37-11" title="11">  orderBy<span class="op">?:</span> OrderBy<span class="op">[];</span></a>
<a class="sourceLine" id="cb37-12" title="12">  limit<span class="op">?:</span> <span class="dt">number</span><span class="op">;</span></a>
<a class="sourceLine" id="cb37-13" title="13"><span class="op">}</span></a>
<a class="sourceLine" id="cb37-14" title="14"></a>
<a class="sourceLine" id="cb37-15" title="15"><span class="kw">interface</span> QueryResult <span class="op">{</span></a>
<a class="sourceLine" id="cb37-16" title="16">  data<span class="op">:</span> <span class="dt">any</span><span class="op">[];</span></a>
<a class="sourceLine" id="cb37-17" title="17">  metadata<span class="op">:</span> QueryMetadata<span class="op">;</span></a>
<a class="sourceLine" id="cb37-18" title="18">  executionTime<span class="op">:</span> <span class="dt">number</span><span class="op">;</span></a>
<a class="sourceLine" id="cb37-19" title="19">  fromCache<span class="op">:</span> <span class="dt">boolean</span><span class="op">;</span></a>
<a class="sourceLine" id="cb37-20" title="20"><span class="op">}</span></a>
<a class="sourceLine" id="cb37-21" title="21"></a>
<a class="sourceLine" id="cb37-22" title="22"><span class="kw">class</span> AnalyticsQueryEngine <span class="op">{</span></a>
<a class="sourceLine" id="cb37-23" title="23">  <span class="kw">private</span> pgPool<span class="op">:</span> Pool<span class="op">;</span></a>
<a class="sourceLine" id="cb37-24" title="24">  <span class="kw">private</span> redis<span class="op">:</span> Redis<span class="op">;</span></a>
<a class="sourceLine" id="cb37-25" title="25">  <span class="kw">private</span> clickhouse<span class="op">:</span> ClickHouse<span class="op">;</span></a>
<a class="sourceLine" id="cb37-26" title="26">  <span class="kw">private</span> queryOptimizer<span class="op">:</span> QueryOptimizer<span class="op">;</span></a>
<a class="sourceLine" id="cb37-27" title="27"></a>
<a class="sourceLine" id="cb37-28" title="28">  <span class="kw">constructor</span>(config<span class="op">:</span> DatabaseConfig) <span class="op">{</span></a>
<a class="sourceLine" id="cb37-29" title="29">    <span class="va">this</span><span class="op">.</span><span class="at">pgPool</span> <span class="op">=</span> <span class="kw">new</span> <span class="fu">Pool</span>(<span class="va">config</span><span class="op">.</span><span class="at">postgres</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb37-30" title="30">    <span class="va">this</span><span class="op">.</span><span class="at">redis</span> <span class="op">=</span> <span class="kw">new</span> <span class="fu">Redis</span>(<span class="va">config</span><span class="op">.</span><span class="at">redis</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb37-31" title="31">    <span class="va">this</span><span class="op">.</span><span class="at">clickhouse</span> <span class="op">=</span> <span class="kw">new</span> <span class="fu">ClickHouse</span>(<span class="va">config</span><span class="op">.</span><span class="at">clickhouse</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb37-32" title="32">    <span class="va">this</span><span class="op">.</span><span class="at">queryOptimizer</span> <span class="op">=</span> <span class="kw">new</span> <span class="fu">QueryOptimizer</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb37-33" title="33">  <span class="op">}</span></a>
<a class="sourceLine" id="cb37-34" title="34"></a>
<a class="sourceLine" id="cb37-35" title="35">  <span class="kw">async</span> <span class="fu">executeQuery</span>(query<span class="op">:</span> AnalyticsQuery)<span class="op">:</span> <span class="bu">Promise</span><span class="op">&lt;</span>QueryResult<span class="op">&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb37-36" title="36">    <span class="kw">const</span> startTime <span class="op">=</span> <span class="bu">Date</span>.<span class="fu">now</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb37-37" title="37">    </a>
<a class="sourceLine" id="cb37-38" title="38">    <span class="cf">try</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb37-39" title="39">      <span class="co">// Optimize query</span></a>
<a class="sourceLine" id="cb37-40" title="40">      <span class="kw">const</span> optimizedQuery <span class="op">=</span> <span class="cf">await</span> <span class="va">this</span><span class="op">.</span><span class="va">queryOptimizer</span><span class="op">.</span><span class="fu">optimize</span>(query)<span class="op">;</span></a>
<a class="sourceLine" id="cb37-41" title="41">      </a>
<a class="sourceLine" id="cb37-42" title="42">      <span class="co">// Generate cache key</span></a>
<a class="sourceLine" id="cb37-43" title="43">      <span class="kw">const</span> cacheKey <span class="op">=</span> <span class="va">this</span><span class="op">.</span><span class="fu">generateCacheKey</span>(optimizedQuery)<span class="op">;</span></a>
<a class="sourceLine" id="cb37-44" title="44">      </a>
<a class="sourceLine" id="cb37-45" title="45">      <span class="co">// Check cache first</span></a>
<a class="sourceLine" id="cb37-46" title="46">      <span class="kw">const</span> cachedResult <span class="op">=</span> <span class="cf">await</span> <span class="va">this</span><span class="op">.</span><span class="va">redis</span><span class="op">.</span><span class="fu">get</span>(cacheKey)<span class="op">;</span></a>
<a class="sourceLine" id="cb37-47" title="47">      <span class="fu">if</span> (cachedResult) <span class="op">{</span></a>
<a class="sourceLine" id="cb37-48" title="48">        <span class="cf">return</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb37-49" title="49">          <span class="op">...</span><span class="bu">JSON</span><span class="op">.</span><span class="fu">parse</span>(cachedResult)<span class="op">,</span></a>
<a class="sourceLine" id="cb37-50" title="50">          executionTime<span class="op">:</span> <span class="bu">Date</span>.<span class="fu">now</span>() <span class="op">-</span> startTime<span class="op">,</span></a>
<a class="sourceLine" id="cb37-51" title="51">          fromCache<span class="op">:</span> <span class="kw">true</span></a>
<a class="sourceLine" id="cb37-52" title="52">        <span class="op">};</span></a>
<a class="sourceLine" id="cb37-53" title="53">      <span class="op">}</span></a>
<a class="sourceLine" id="cb37-54" title="54">      </a>
<a class="sourceLine" id="cb37-55" title="55">      <span class="co">// Execute query based on data size and complexity</span></a>
<a class="sourceLine" id="cb37-56" title="56">      <span class="kw">let</span> result<span class="op">;</span></a>
<a class="sourceLine" id="cb37-57" title="57">      <span class="fu">if</span> (<span class="va">this</span><span class="op">.</span><span class="fu">shouldUseClickHouse</span>(optimizedQuery)) <span class="op">{</span></a>
<a class="sourceLine" id="cb37-58" title="58">        result <span class="op">=</span> <span class="cf">await</span> <span class="va">this</span><span class="op">.</span><span class="fu">executeClickHouseQuery</span>(optimizedQuery)<span class="op">;</span></a>
<a class="sourceLine" id="cb37-59" title="59">      <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb37-60" title="60">        result <span class="op">=</span> <span class="cf">await</span> <span class="va">this</span><span class="op">.</span><span class="fu">executePostgresQuery</span>(optimizedQuery)<span class="op">;</span></a>
<a class="sourceLine" id="cb37-61" title="61">      <span class="op">}</span></a>
<a class="sourceLine" id="cb37-62" title="62">      </a>
<a class="sourceLine" id="cb37-63" title="63">      <span class="co">// Cache result</span></a>
<a class="sourceLine" id="cb37-64" title="64">      <span class="cf">await</span> <span class="va">this</span><span class="op">.</span><span class="va">redis</span><span class="op">.</span><span class="fu">setex</span>(</a>
<a class="sourceLine" id="cb37-65" title="65">        cacheKey<span class="op">,</span></a>
<a class="sourceLine" id="cb37-66" title="66">        <span class="va">this</span><span class="op">.</span><span class="fu">getCacheTTL</span>(optimizedQuery)<span class="op">,</span></a>
<a class="sourceLine" id="cb37-67" title="67">        <span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>(result)</a>
<a class="sourceLine" id="cb37-68" title="68">      )<span class="op">;</span></a>
<a class="sourceLine" id="cb37-69" title="69">      </a>
<a class="sourceLine" id="cb37-70" title="70">      <span class="cf">return</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb37-71" title="71">        <span class="op">...</span>result<span class="op">,</span></a>
<a class="sourceLine" id="cb37-72" title="72">        executionTime<span class="op">:</span> <span class="bu">Date</span>.<span class="fu">now</span>() <span class="op">-</span> startTime<span class="op">,</span></a>
<a class="sourceLine" id="cb37-73" title="73">        fromCache<span class="op">:</span> <span class="kw">false</span></a>
<a class="sourceLine" id="cb37-74" title="74">      <span class="op">};</span></a>
<a class="sourceLine" id="cb37-75" title="75">      </a>
<a class="sourceLine" id="cb37-76" title="76">    <span class="op">}</span> <span class="fu">catch</span> (error) <span class="op">{</span></a>
<a class="sourceLine" id="cb37-77" title="77">      <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">Error</span>(<span class="vs">`Query execution failed: </span><span class="sc">${</span><span class="va">error</span><span class="op">.</span><span class="at">message</span><span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb37-78" title="78">    <span class="op">}</span></a>
<a class="sourceLine" id="cb37-79" title="79">  <span class="op">}</span></a>
<a class="sourceLine" id="cb37-80" title="80"></a>
<a class="sourceLine" id="cb37-81" title="81">  <span class="kw">private</span> <span class="kw">async</span> <span class="fu">executeClickHouseQuery</span>(query<span class="op">:</span> AnalyticsQuery)<span class="op">:</span> <span class="bu">Promise</span><span class="op">&lt;</span><span class="dt">any</span><span class="op">&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb37-82" title="82">    <span class="kw">const</span> sql <span class="op">=</span> <span class="va">this</span><span class="op">.</span><span class="fu">buildClickHouseSQL</span>(query)<span class="op">;</span></a>
<a class="sourceLine" id="cb37-83" title="83">    </a>
<a class="sourceLine" id="cb37-84" title="84">    <span class="kw">const</span> result <span class="op">=</span> <span class="cf">await</span> <span class="va">this</span><span class="op">.</span><span class="va">clickhouse</span><span class="op">.</span><span class="fu">query</span>(sql).<span class="fu">toPromise</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb37-85" title="85">    </a>
<a class="sourceLine" id="cb37-86" title="86">    <span class="cf">return</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb37-87" title="87">      data<span class="op">:</span> result<span class="op">,</span></a>
<a class="sourceLine" id="cb37-88" title="88">      metadata<span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb37-89" title="89">        rowCount<span class="op">:</span> <span class="va">result</span><span class="op">.</span><span class="at">length</span><span class="op">,</span></a>
<a class="sourceLine" id="cb37-90" title="90">        columns<span class="op">:</span> <span class="bu">Object</span>.<span class="fu">keys</span>(result<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">||</span> <span class="op">{}</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb37-91" title="91">        dataSource<span class="op">:</span> <span class="st">&#39;clickhouse&#39;</span></a>
<a class="sourceLine" id="cb37-92" title="92">      <span class="op">}</span></a>
<a class="sourceLine" id="cb37-93" title="93">    <span class="op">};</span></a>
<a class="sourceLine" id="cb37-94" title="94">  <span class="op">}</span></a>
<a class="sourceLine" id="cb37-95" title="95"></a>
<a class="sourceLine" id="cb37-96" title="96">  <span class="kw">private</span> <span class="fu">buildClickHouseSQL</span>(query<span class="op">:</span> AnalyticsQuery)<span class="op">:</span> <span class="dt">string</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb37-97" title="97">    <span class="kw">const</span> selectClause <span class="op">=</span> <span class="op">[...</span><span class="va">query</span><span class="op">.</span><span class="at">dimensions</span><span class="op">,</span> <span class="op">...</span><span class="va">query</span><span class="op">.</span><span class="at">metrics</span><span class="op">]</span>.<span class="fu">join</span>(<span class="st">&#39;, &#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb37-98" title="98">    <span class="kw">const</span> fromClause <span class="op">=</span> <span class="st">&#39;spend_analytics_daily&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb37-99" title="99">    <span class="kw">const</span> whereClause <span class="op">=</span> <span class="va">this</span><span class="op">.</span><span class="fu">buildWhereClause</span>(<span class="va">query</span><span class="op">.</span><span class="at">filters</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb37-100" title="100">    <span class="kw">const</span> groupByClause <span class="op">=</span> <span class="va">query</span><span class="op">.</span><span class="va">groupBy</span><span class="op">?.</span><span class="at">length</span> <span class="op">?</span> </a>
<a class="sourceLine" id="cb37-101" title="101">      <span class="vs">`GROUP BY </span><span class="sc">${</span><span class="va">query</span><span class="op">.</span><span class="va">groupBy</span><span class="op">.</span><span class="fu">join</span>(<span class="st">&#39;, &#39;</span>)<span class="sc">}</span><span class="vs">`</span> <span class="op">:</span> <span class="st">&#39;&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb37-102" title="102">    <span class="kw">const</span> orderByClause <span class="op">=</span> <span class="va">query</span><span class="op">.</span><span class="va">orderBy</span><span class="op">?.</span><span class="at">length</span> <span class="op">?</span></a>
<a class="sourceLine" id="cb37-103" title="103">      <span class="vs">`ORDER BY </span><span class="sc">${</span><span class="va">query</span><span class="op">.</span><span class="va">orderBy</span><span class="op">.</span><span class="fu">map</span>(o <span class="kw">=&gt;</span> <span class="vs">`</span><span class="sc">${</span><span class="va">o</span><span class="op">.</span><span class="at">field</span><span class="sc">}</span><span class="vs"> </span><span class="sc">${</span><span class="va">o</span><span class="op">.</span><span class="at">direction</span><span class="sc">}</span><span class="vs">`</span>).<span class="fu">join</span>(<span class="st">&#39;, &#39;</span>)<span class="sc">}</span><span class="vs">`</span> <span class="op">:</span> <span class="st">&#39;&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb37-104" title="104">    <span class="kw">const</span> limitClause <span class="op">=</span> <span class="va">query</span><span class="op">.</span><span class="at">limit</span> <span class="op">?</span> <span class="vs">`LIMIT </span><span class="sc">${</span><span class="va">query</span><span class="op">.</span><span class="at">limit</span><span class="sc">}</span><span class="vs">`</span> <span class="op">:</span> <span class="st">&#39;&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb37-105" title="105"></a>
<a class="sourceLine" id="cb37-106" title="106">    <span class="cf">return</span> <span class="vs">`</span></a>
<a class="sourceLine" id="cb37-107" title="107"><span class="vs">      SELECT </span><span class="sc">${</span>selectClause<span class="sc">}</span></a>
<a class="sourceLine" id="cb37-108" title="108"><span class="vs">      FROM </span><span class="sc">${</span>fromClause<span class="sc">}</span></a>
<a class="sourceLine" id="cb37-109" title="109"><span class="vs">      </span><span class="sc">${</span>whereClause<span class="sc">}</span></a>
<a class="sourceLine" id="cb37-110" title="110"><span class="vs">      </span><span class="sc">${</span>groupByClause<span class="sc">}</span></a>
<a class="sourceLine" id="cb37-111" title="111"><span class="vs">      </span><span class="sc">${</span>orderByClause<span class="sc">}</span></a>
<a class="sourceLine" id="cb37-112" title="112"><span class="vs">      </span><span class="sc">${</span>limitClause<span class="sc">}</span></a>
<a class="sourceLine" id="cb37-113" title="113"><span class="vs">    `</span>.<span class="fu">trim</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb37-114" title="114">  <span class="op">}</span></a>
<a class="sourceLine" id="cb37-115" title="115"></a>
<a class="sourceLine" id="cb37-116" title="116">  <span class="kw">private</span> <span class="fu">shouldUseClickHouse</span>(query<span class="op">:</span> AnalyticsQuery)<span class="op">:</span> <span class="dt">boolean</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb37-117" title="117">    <span class="co">// Use ClickHouse for large aggregations and analytical queries</span></a>
<a class="sourceLine" id="cb37-118" title="118">    <span class="kw">const</span> hasAggregations <span class="op">=</span> <span class="va">query</span><span class="op">.</span><span class="va">metrics</span><span class="op">.</span><span class="fu">some</span>(m <span class="kw">=&gt;</span> </a>
<a class="sourceLine" id="cb37-119" title="119">      <span class="op">[</span><span class="st">&#39;SUM&#39;</span><span class="op">,</span> <span class="st">&#39;AVG&#39;</span><span class="op">,</span> <span class="st">&#39;COUNT&#39;</span><span class="op">,</span> <span class="st">&#39;MAX&#39;</span><span class="op">,</span> <span class="st">&#39;MIN&#39;</span><span class="op">]</span>.<span class="fu">some</span>(agg <span class="kw">=&gt;</span> <span class="va">m</span><span class="op">.</span><span class="fu">includes</span>(agg))</a>
<a class="sourceLine" id="cb37-120" title="120">    )<span class="op">;</span></a>
<a class="sourceLine" id="cb37-121" title="121">    <span class="kw">const</span> hasLargeDateRange <span class="op">=</span> <span class="va">this</span><span class="op">.</span><span class="fu">getDateRangeDays</span>(<span class="va">query</span><span class="op">.</span><span class="at">dateRange</span>) <span class="op">&gt;</span> <span class="dv">90</span><span class="op">;</span></a>
<a class="sourceLine" id="cb37-122" title="122">    </a>
<a class="sourceLine" id="cb37-123" title="123">    <span class="cf">return</span> hasAggregations <span class="op">||</span> hasLargeDateRange<span class="op">;</span></a>
<a class="sourceLine" id="cb37-124" title="124">  <span class="op">}</span></a>
<a class="sourceLine" id="cb37-125" title="125"></a>
<a class="sourceLine" id="cb37-126" title="126">  <span class="kw">private</span> <span class="fu">generateCacheKey</span>(query<span class="op">:</span> AnalyticsQuery)<span class="op">:</span> <span class="dt">string</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb37-127" title="127">    <span class="kw">const</span> queryString <span class="op">=</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>(query<span class="op">,</span> <span class="bu">Object</span>.<span class="fu">keys</span>(query).<span class="fu">sort</span>())<span class="op">;</span></a>
<a class="sourceLine" id="cb37-128" title="128">    <span class="cf">return</span> <span class="vs">`analytics:</span><span class="sc">${</span><span class="va">this</span><span class="op">.</span><span class="fu">hashString</span>(queryString)<span class="sc">}</span><span class="vs">`</span><span class="op">;</span></a>
<a class="sourceLine" id="cb37-129" title="129">  <span class="op">}</span></a>
<a class="sourceLine" id="cb37-130" title="130"></a>
<a class="sourceLine" id="cb37-131" title="131">  <span class="kw">private</span> <span class="fu">getCacheTTL</span>(query<span class="op">:</span> AnalyticsQuery)<span class="op">:</span> <span class="dt">number</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb37-132" title="132">    <span class="co">// Real-time queries: 5 minutes</span></a>
<a class="sourceLine" id="cb37-133" title="133">    <span class="co">// Daily aggregations: 1 hour</span></a>
<a class="sourceLine" id="cb37-134" title="134">    <span class="co">// Historical data: 24 hours</span></a>
<a class="sourceLine" id="cb37-135" title="135">    <span class="kw">const</span> dateRangeDays <span class="op">=</span> <span class="va">this</span><span class="op">.</span><span class="fu">getDateRangeDays</span>(<span class="va">query</span><span class="op">.</span><span class="at">dateRange</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb37-136" title="136">    </a>
<a class="sourceLine" id="cb37-137" title="137">    <span class="fu">if</span> (dateRangeDays <span class="op">&lt;=</span> <span class="dv">1</span>) <span class="cf">return</span> <span class="dv">300</span><span class="op">;</span>      <span class="co">// 5 minutes</span></a>
<a class="sourceLine" id="cb37-138" title="138">    <span class="fu">if</span> (dateRangeDays <span class="op">&lt;=</span> <span class="dv">30</span>) <span class="cf">return</span> <span class="dv">3600</span><span class="op">;</span>    <span class="co">// 1 hour</span></a>
<a class="sourceLine" id="cb37-139" title="139">    <span class="cf">return</span> <span class="dv">86400</span><span class="op">;</span>                            <span class="co">// 24 hours</span></a>
<a class="sourceLine" id="cb37-140" title="140">  <span class="op">}</span></a>
<a class="sourceLine" id="cb37-141" title="141"><span class="op">}</span></a></code></pre></div>
<h2 id="configuration-and-deployment">3. Configuration and Deployment</h2>
<h3 id="kubernetes-deployment-configuration">3.1 Kubernetes Deployment Configuration</h3>
<div class="sourceCode" id="cb38"><pre class="sourceCode yaml"><code class="sourceCode yaml"><a class="sourceLine" id="cb38-1" title="1"><span class="co"># expense-management-service.yaml</span></a>
<a class="sourceLine" id="cb38-2" title="2"><span class="fu">apiVersion:</span><span class="at"> apps/v1</span></a>
<a class="sourceLine" id="cb38-3" title="3"><span class="fu">kind:</span><span class="at"> Deployment</span></a>
<a class="sourceLine" id="cb38-4" title="4"><span class="fu">metadata:</span></a>
<a class="sourceLine" id="cb38-5" title="5">  <span class="fu">name:</span><span class="at"> expense-management-service</span></a>
<a class="sourceLine" id="cb38-6" title="6">  <span class="fu">labels:</span></a>
<a class="sourceLine" id="cb38-7" title="7">    <span class="fu">app:</span><span class="at"> expense-management</span></a>
<a class="sourceLine" id="cb38-8" title="8">    <span class="fu">version:</span><span class="at"> v1.0.0</span></a>
<a class="sourceLine" id="cb38-9" title="9"><span class="fu">spec:</span></a>
<a class="sourceLine" id="cb38-10" title="10">  <span class="fu">replicas:</span><span class="at"> </span><span class="dv">3</span></a>
<a class="sourceLine" id="cb38-11" title="11">  <span class="fu">selector:</span></a>
<a class="sourceLine" id="cb38-12" title="12">    <span class="fu">matchLabels:</span></a>
<a class="sourceLine" id="cb38-13" title="13">      <span class="fu">app:</span><span class="at"> expense-management</span></a>
<a class="sourceLine" id="cb38-14" title="14">  <span class="fu">template:</span></a>
<a class="sourceLine" id="cb38-15" title="15">    <span class="fu">metadata:</span></a>
<a class="sourceLine" id="cb38-16" title="16">      <span class="fu">labels:</span></a>
<a class="sourceLine" id="cb38-17" title="17">        <span class="fu">app:</span><span class="at"> expense-management</span></a>
<a class="sourceLine" id="cb38-18" title="18">    <span class="fu">spec:</span></a>
<a class="sourceLine" id="cb38-19" title="19">      <span class="fu">containers:</span></a>
<a class="sourceLine" id="cb38-20" title="20">      <span class="kw">-</span> <span class="fu">name:</span><span class="at"> expense-service</span></a>
<a class="sourceLine" id="cb38-21" title="21">        <span class="fu">image:</span><span class="at"> finance-platform/expense-service:1.0.0</span></a>
<a class="sourceLine" id="cb38-22" title="22">        <span class="fu">ports:</span></a>
<a class="sourceLine" id="cb38-23" title="23">        <span class="kw">-</span> <span class="fu">containerPort:</span><span class="at"> </span><span class="dv">8080</span></a>
<a class="sourceLine" id="cb38-24" title="24">        <span class="fu">env:</span></a>
<a class="sourceLine" id="cb38-25" title="25">        <span class="kw">-</span> <span class="fu">name:</span><span class="at"> DATABASE_URL</span></a>
<a class="sourceLine" id="cb38-26" title="26">          <span class="fu">valueFrom:</span></a>
<a class="sourceLine" id="cb38-27" title="27">            <span class="fu">secretKeyRef:</span></a>
<a class="sourceLine" id="cb38-28" title="28">              <span class="fu">name:</span><span class="at"> database-secret</span></a>
<a class="sourceLine" id="cb38-29" title="29">              <span class="fu">key:</span><span class="at"> url</span></a>
<a class="sourceLine" id="cb38-30" title="30">        <span class="kw">-</span> <span class="fu">name:</span><span class="at"> REDIS_URL</span></a>
<a class="sourceLine" id="cb38-31" title="31">          <span class="fu">valueFrom:</span></a>
<a class="sourceLine" id="cb38-32" title="32">            <span class="fu">secretKeyRef:</span></a>
<a class="sourceLine" id="cb38-33" title="33">              <span class="fu">name:</span><span class="at"> redis-secret</span></a>
<a class="sourceLine" id="cb38-34" title="34">              <span class="fu">key:</span><span class="at"> url</span></a>
<a class="sourceLine" id="cb38-35" title="35">        <span class="kw">-</span> <span class="fu">name:</span><span class="at"> ML_MODEL_PATH</span></a>
<a class="sourceLine" id="cb38-36" title="36">          <span class="fu">value:</span><span class="at"> </span><span class="st">&quot;/models/categorization&quot;</span></a>
<a class="sourceLine" id="cb38-37" title="37">        <span class="fu">resources:</span></a>
<a class="sourceLine" id="cb38-38" title="38">          <span class="fu">requests:</span></a>
<a class="sourceLine" id="cb38-39" title="39">            <span class="fu">memory:</span><span class="at"> </span><span class="st">&quot;512Mi&quot;</span></a>
<a class="sourceLine" id="cb38-40" title="40">            <span class="fu">cpu:</span><span class="at"> </span><span class="st">&quot;250m&quot;</span></a>
<a class="sourceLine" id="cb38-41" title="41">          <span class="fu">limits:</span></a>
<a class="sourceLine" id="cb38-42" title="42">            <span class="fu">memory:</span><span class="at"> </span><span class="st">&quot;1Gi&quot;</span></a>
<a class="sourceLine" id="cb38-43" title="43">            <span class="fu">cpu:</span><span class="at"> </span><span class="st">&quot;500m&quot;</span></a>
<a class="sourceLine" id="cb38-44" title="44">        <span class="fu">livenessProbe:</span></a>
<a class="sourceLine" id="cb38-45" title="45">          <span class="fu">httpGet:</span></a>
<a class="sourceLine" id="cb38-46" title="46">            <span class="fu">path:</span><span class="at"> /health</span></a>
<a class="sourceLine" id="cb38-47" title="47">            <span class="fu">port:</span><span class="at"> </span><span class="dv">8080</span></a>
<a class="sourceLine" id="cb38-48" title="48">          <span class="fu">initialDelaySeconds:</span><span class="at"> </span><span class="dv">30</span></a>
<a class="sourceLine" id="cb38-49" title="49">          <span class="fu">periodSeconds:</span><span class="at"> </span><span class="dv">10</span></a>
<a class="sourceLine" id="cb38-50" title="50">        <span class="fu">readinessProbe:</span></a>
<a class="sourceLine" id="cb38-51" title="51">          <span class="fu">httpGet:</span></a>
<a class="sourceLine" id="cb38-52" title="52">            <span class="fu">path:</span><span class="at"> /ready</span></a>
<a class="sourceLine" id="cb38-53" title="53">            <span class="fu">port:</span><span class="at"> </span><span class="dv">8080</span></a>
<a class="sourceLine" id="cb38-54" title="54">          <span class="fu">initialDelaySeconds:</span><span class="at"> </span><span class="dv">5</span></a>
<a class="sourceLine" id="cb38-55" title="55">          <span class="fu">periodSeconds:</span><span class="at"> </span><span class="dv">5</span></a>
<a class="sourceLine" id="cb38-56" title="56">        <span class="fu">volumeMounts:</span></a>
<a class="sourceLine" id="cb38-57" title="57">        <span class="kw">-</span> <span class="fu">name:</span><span class="at"> ml-models</span></a>
<a class="sourceLine" id="cb38-58" title="58">          <span class="fu">mountPath:</span><span class="at"> /models</span></a>
<a class="sourceLine" id="cb38-59" title="59">          <span class="fu">readOnly:</span><span class="at"> </span><span class="ch">true</span></a>
<a class="sourceLine" id="cb38-60" title="60">      <span class="fu">volumes:</span></a>
<a class="sourceLine" id="cb38-61" title="61">      <span class="kw">-</span> <span class="fu">name:</span><span class="at"> ml-models</span></a>
<a class="sourceLine" id="cb38-62" title="62">        <span class="fu">persistentVolumeClaim:</span></a>
<a class="sourceLine" id="cb38-63" title="63">          <span class="fu">claimName:</span><span class="at"> ml-models-pvc</span></a>
<a class="sourceLine" id="cb38-64" title="64"><span class="ot">---</span></a>
<a class="sourceLine" id="cb38-65" title="65"><span class="fu">apiVersion:</span><span class="at"> v1</span></a>
<a class="sourceLine" id="cb38-66" title="66"><span class="fu">kind:</span><span class="at"> Service</span></a>
<a class="sourceLine" id="cb38-67" title="67"><span class="fu">metadata:</span></a>
<a class="sourceLine" id="cb38-68" title="68">  <span class="fu">name:</span><span class="at"> expense-management-service</span></a>
<a class="sourceLine" id="cb38-69" title="69"><span class="fu">spec:</span></a>
<a class="sourceLine" id="cb38-70" title="70">  <span class="fu">selector:</span></a>
<a class="sourceLine" id="cb38-71" title="71">    <span class="fu">app:</span><span class="at"> expense-management</span></a>
<a class="sourceLine" id="cb38-72" title="72">  <span class="fu">ports:</span></a>
<a class="sourceLine" id="cb38-73" title="73">  <span class="kw">-</span> <span class="fu">port:</span><span class="at"> </span><span class="dv">80</span></a>
<a class="sourceLine" id="cb38-74" title="74">    <span class="fu">targetPort:</span><span class="at"> </span><span class="dv">8080</span></a>
<a class="sourceLine" id="cb38-75" title="75">  <span class="fu">type:</span><span class="at"> ClusterIP</span></a>
<a class="sourceLine" id="cb38-76" title="76"><span class="ot">---</span></a>
<a class="sourceLine" id="cb38-77" title="77"><span class="fu">apiVersion:</span><span class="at"> autoscaling/v2</span></a>
<a class="sourceLine" id="cb38-78" title="78"><span class="fu">kind:</span><span class="at"> HorizontalPodAutoscaler</span></a>
<a class="sourceLine" id="cb38-79" title="79"><span class="fu">metadata:</span></a>
<a class="sourceLine" id="cb38-80" title="80">  <span class="fu">name:</span><span class="at"> expense-management-hpa</span></a>
<a class="sourceLine" id="cb38-81" title="81"><span class="fu">spec:</span></a>
<a class="sourceLine" id="cb38-82" title="82">  <span class="fu">scaleTargetRef:</span></a>
<a class="sourceLine" id="cb38-83" title="83">    <span class="fu">apiVersion:</span><span class="at"> apps/v1</span></a>
<a class="sourceLine" id="cb38-84" title="84">    <span class="fu">kind:</span><span class="at"> Deployment</span></a>
<a class="sourceLine" id="cb38-85" title="85">    <span class="fu">name:</span><span class="at"> expense-management-service</span></a>
<a class="sourceLine" id="cb38-86" title="86">  <span class="fu">minReplicas:</span><span class="at"> </span><span class="dv">3</span></a>
<a class="sourceLine" id="cb38-87" title="87">  <span class="fu">maxReplicas:</span><span class="at"> </span><span class="dv">10</span></a>
<a class="sourceLine" id="cb38-88" title="88">  <span class="fu">metrics:</span></a>
<a class="sourceLine" id="cb38-89" title="89">  <span class="kw">-</span> <span class="fu">type:</span><span class="at"> Resource</span></a>
<a class="sourceLine" id="cb38-90" title="90">    <span class="fu">resource:</span></a>
<a class="sourceLine" id="cb38-91" title="91">      <span class="fu">name:</span><span class="at"> cpu</span></a>
<a class="sourceLine" id="cb38-92" title="92">      <span class="fu">target:</span></a>
<a class="sourceLine" id="cb38-93" title="93">        <span class="fu">type:</span><span class="at"> Utilization</span></a>
<a class="sourceLine" id="cb38-94" title="94">        <span class="fu">averageUtilization:</span><span class="at"> </span><span class="dv">70</span></a>
<a class="sourceLine" id="cb38-95" title="95">  <span class="kw">-</span> <span class="fu">type:</span><span class="at"> Resource</span></a>
<a class="sourceLine" id="cb38-96" title="96">    <span class="fu">resource:</span></a>
<a class="sourceLine" id="cb38-97" title="97">      <span class="fu">name:</span><span class="at"> memory</span></a>
<a class="sourceLine" id="cb38-98" title="98">      <span class="fu">target:</span></a>
<a class="sourceLine" id="cb38-99" title="99">        <span class="fu">type:</span><span class="at"> Utilization</span></a>
<a class="sourceLine" id="cb38-100" title="100">        <span class="fu">averageUtilization:</span><span class="at"> </span><span class="dv">80</span></a></code></pre></div>
<h3 id="docker-configuration">3.2 Docker Configuration</h3>
<div class="sourceCode" id="cb39"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><a class="sourceLine" id="cb39-1" title="1"><span class="co"># Dockerfile for Expense Management Service</span></a>
<a class="sourceLine" id="cb39-2" title="2"><span class="kw">FROM</span> node:18-alpine AS builder</a>
<a class="sourceLine" id="cb39-3" title="3"></a>
<a class="sourceLine" id="cb39-4" title="4"><span class="kw">WORKDIR</span> /app</a>
<a class="sourceLine" id="cb39-5" title="5"><span class="kw">COPY</span> package*.json ./</a>
<a class="sourceLine" id="cb39-6" title="6"><span class="kw">RUN</span> npm ci --only=production</a>
<a class="sourceLine" id="cb39-7" title="7"></a>
<a class="sourceLine" id="cb39-8" title="8"><span class="kw">FROM</span> node:18-alpine AS runtime</a>
<a class="sourceLine" id="cb39-9" title="9"></a>
<a class="sourceLine" id="cb39-10" title="10"><span class="co"># Install system dependencies for OCR</span></a>
<a class="sourceLine" id="cb39-11" title="11"><span class="kw">RUN</span> apk add --no-cache \</a>
<a class="sourceLine" id="cb39-12" title="12">    tesseract-ocr \</a>
<a class="sourceLine" id="cb39-13" title="13">    tesseract-ocr-data-eng \</a>
<a class="sourceLine" id="cb39-14" title="14">    opencv-dev \</a>
<a class="sourceLine" id="cb39-15" title="15">    python3 \</a>
<a class="sourceLine" id="cb39-16" title="16">    py3-pip</a>
<a class="sourceLine" id="cb39-17" title="17"></a>
<a class="sourceLine" id="cb39-18" title="18"><span class="co"># Install Python dependencies</span></a>
<a class="sourceLine" id="cb39-19" title="19"><span class="kw">COPY</span> requirements.txt .</a>
<a class="sourceLine" id="cb39-20" title="20"><span class="kw">RUN</span> pip3 install -r requirements.txt</a>
<a class="sourceLine" id="cb39-21" title="21"></a>
<a class="sourceLine" id="cb39-22" title="22"><span class="co"># Copy application</span></a>
<a class="sourceLine" id="cb39-23" title="23"><span class="kw">WORKDIR</span> /app</a>
<a class="sourceLine" id="cb39-24" title="24"><span class="kw">COPY</span> --from=builder /app/node_modules ./node_modules</a>
<a class="sourceLine" id="cb39-25" title="25"><span class="kw">COPY</span> . .</a>
<a class="sourceLine" id="cb39-26" title="26"></a>
<a class="sourceLine" id="cb39-27" title="27"><span class="co"># Create non-root user</span></a>
<a class="sourceLine" id="cb39-28" title="28"><span class="kw">RUN</span> addgroup -g 1001 -S nodejs &amp;&amp; \</a>
<a class="sourceLine" id="cb39-29" title="29">    adduser -S nodejs -u 1001</a>
<a class="sourceLine" id="cb39-30" title="30"></a>
<a class="sourceLine" id="cb39-31" title="31"><span class="co"># Set ownership and permissions</span></a>
<a class="sourceLine" id="cb39-32" title="32"><span class="kw">RUN</span> chown -R nodejs:nodejs /app</a>
<a class="sourceLine" id="cb39-33" title="33"><span class="kw">USER</span> nodejs</a>
<a class="sourceLine" id="cb39-34" title="34"></a>
<a class="sourceLine" id="cb39-35" title="35"><span class="kw">EXPOSE</span> 8080</a>
<a class="sourceLine" id="cb39-36" title="36"></a>
<a class="sourceLine" id="cb39-37" title="37"><span class="kw">HEALTHCHECK</span> --interval=30s --timeout=3s --start-period=5s --retries=3 \</a>
<a class="sourceLine" id="cb39-38" title="38">  <span class="kw">CMD</span> curl -f http://localhost:8080/health || exit 1</a>
<a class="sourceLine" id="cb39-39" title="39"></a>
<a class="sourceLine" id="cb39-40" title="40"><span class="kw">CMD</span> [<span class="st">&quot;node&quot;</span>, <span class="st">&quot;dist/server.js&quot;</span>]</a></code></pre></div>
<h3 id="environment-configuration">3.3 Environment Configuration</h3>
<div class="sourceCode" id="cb40"><pre class="sourceCode yaml"><code class="sourceCode yaml"><a class="sourceLine" id="cb40-1" title="1"><span class="co"># config/production.yaml</span></a>
<a class="sourceLine" id="cb40-2" title="2"><span class="fu">database:</span></a>
<a class="sourceLine" id="cb40-3" title="3">  <span class="fu">postgres:</span></a>
<a class="sourceLine" id="cb40-4" title="4">    <span class="fu">host:</span><span class="at"> postgres-cluster.finance-platform.svc.cluster.local</span></a>
<a class="sourceLine" id="cb40-5" title="5">    <span class="fu">port:</span><span class="at"> </span><span class="dv">5432</span></a>
<a class="sourceLine" id="cb40-6" title="6">    <span class="fu">database:</span><span class="at"> finance_platform</span></a>
<a class="sourceLine" id="cb40-7" title="7">    <span class="fu">pool:</span></a>
<a class="sourceLine" id="cb40-8" title="8">      <span class="fu">min:</span><span class="at"> </span><span class="dv">5</span></a>
<a class="sourceLine" id="cb40-9" title="9">      <span class="fu">max:</span><span class="at"> </span><span class="dv">20</span></a>
<a class="sourceLine" id="cb40-10" title="10">      <span class="fu">acquireTimeoutMillis:</span><span class="at"> </span><span class="dv">30000</span></a>
<a class="sourceLine" id="cb40-11" title="11">      <span class="fu">idleTimeoutMillis:</span><span class="at"> </span><span class="dv">30000</span></a>
<a class="sourceLine" id="cb40-12" title="12">  </a>
<a class="sourceLine" id="cb40-13" title="13">  <span class="fu">clickhouse:</span></a>
<a class="sourceLine" id="cb40-14" title="14">    <span class="fu">host:</span><span class="at"> clickhouse-cluster.finance-platform.svc.cluster.local</span></a>
<a class="sourceLine" id="cb40-15" title="15">    <span class="fu">port:</span><span class="at"> </span><span class="dv">8123</span></a>
<a class="sourceLine" id="cb40-16" title="16">    <span class="fu">database:</span><span class="at"> analytics</span></a>
<a class="sourceLine" id="cb40-17" title="17">    </a>
<a class="sourceLine" id="cb40-18" title="18">  <span class="fu">redis:</span></a>
<a class="sourceLine" id="cb40-19" title="19">    <span class="fu">host:</span><span class="at"> redis-cluster.finance-platform.svc.cluster.local</span></a>
<a class="sourceLine" id="cb40-20" title="20">    <span class="fu">port:</span><span class="at"> </span><span class="dv">6379</span></a>
<a class="sourceLine" id="cb40-21" title="21">    <span class="fu">db:</span><span class="at"> </span><span class="dv">0</span></a>
<a class="sourceLine" id="cb40-22" title="22">    <span class="fu">keyPrefix:</span><span class="at"> </span><span class="st">&quot;finance:&quot;</span></a>
<a class="sourceLine" id="cb40-23" title="23"></a>
<a class="sourceLine" id="cb40-24" title="24"><span class="fu">ml:</span></a>
<a class="sourceLine" id="cb40-25" title="25">  <span class="fu">models:</span></a>
<a class="sourceLine" id="cb40-26" title="26">    <span class="fu">categorization:</span></a>
<a class="sourceLine" id="cb40-27" title="27">      <span class="fu">path:</span><span class="at"> </span><span class="st">&quot;/models/categorization/v1.2.0&quot;</span></a>
<a class="sourceLine" id="cb40-28" title="28">      <span class="fu">confidence_threshold:</span><span class="at"> </span><span class="fl">0.7</span></a>
<a class="sourceLine" id="cb40-29" title="29">      <span class="fu">batch_size:</span><span class="at"> </span><span class="dv">32</span></a>
<a class="sourceLine" id="cb40-30" title="30">    </a>
<a class="sourceLine" id="cb40-31" title="31">    <span class="fu">anomaly_detection:</span></a>
<a class="sourceLine" id="cb40-32" title="32">      <span class="fu">path:</span><span class="at"> </span><span class="st">&quot;/models/anomaly/v1.1.0&quot;</span></a>
<a class="sourceLine" id="cb40-33" title="33">      <span class="fu">threshold:</span><span class="at"> </span><span class="fl">0.8</span></a>
<a class="sourceLine" id="cb40-34" title="34">      <span class="fu">window_size:</span><span class="at"> </span><span class="dv">100</span></a>
<a class="sourceLine" id="cb40-35" title="35"></a>
<a class="sourceLine" id="cb40-36" title="36"><span class="fu">ocr:</span></a>
<a class="sourceLine" id="cb40-37" title="37">  <span class="fu">tesseract:</span></a>
<a class="sourceLine" id="cb40-38" title="38">    <span class="fu">config:</span><span class="at"> </span><span class="st">&quot;--oem 3 --psm 6&quot;</span></a>
<a class="sourceLine" id="cb40-39" title="39">    <span class="fu">languages:</span><span class="at"> </span><span class="kw">[</span><span class="st">&quot;eng&quot;</span><span class="kw">]</span></a>
<a class="sourceLine" id="cb40-40" title="40">  </a>
<a class="sourceLine" id="cb40-41" title="41">  <span class="fu">preprocessing:</span></a>
<a class="sourceLine" id="cb40-42" title="42">    <span class="fu">enhance_contrast:</span><span class="at"> </span><span class="ch">true</span></a>
<a class="sourceLine" id="cb40-43" title="43">    <span class="fu">denoise:</span><span class="at"> </span><span class="ch">true</span></a>
<a class="sourceLine" id="cb40-44" title="44">    <span class="fu">deskew:</span><span class="at"> </span><span class="ch">true</span></a>
<a class="sourceLine" id="cb40-45" title="45"></a>
<a class="sourceLine" id="cb40-46" title="46"><span class="fu">performance:</span></a>
<a class="sourceLine" id="cb40-47" title="47">  <span class="fu">cache:</span></a>
<a class="sourceLine" id="cb40-48" title="48">    <span class="fu">ttl:</span></a>
<a class="sourceLine" id="cb40-49" title="49">      <span class="fu">analytics:</span><span class="at"> </span><span class="dv">3600</span><span class="at">  </span><span class="co"># 1 hour</span></a>
<a class="sourceLine" id="cb40-50" title="50">      <span class="fu">categorization:</span><span class="at"> </span><span class="dv">1800</span><span class="at">  </span><span class="co"># 30 minutes</span></a>
<a class="sourceLine" id="cb40-51" title="51">      <span class="fu">user_data:</span><span class="at"> </span><span class="dv">900</span><span class="at">  </span><span class="co"># 15 minutes</span></a>
<a class="sourceLine" id="cb40-52" title="52">  </a>
<a class="sourceLine" id="cb40-53" title="53">  <span class="fu">rate_limiting:</span></a>
<a class="sourceLine" id="cb40-54" title="54">    <span class="fu">api_calls_per_minute:</span><span class="at"> </span><span class="dv">1000</span></a>
<a class="sourceLine" id="cb40-55" title="55">    <span class="fu">ml_requests_per_minute:</span><span class="at"> </span><span class="dv">500</span></a>
<a class="sourceLine" id="cb40-56" title="56"></a>
<a class="sourceLine" id="cb40-57" title="57"><span class="fu">security:</span></a>
<a class="sourceLine" id="cb40-58" title="58">  <span class="fu">jwt:</span></a>
<a class="sourceLine" id="cb40-59" title="59">    <span class="fu">secret:</span><span class="at"> ${JWT_SECRET}</span></a>
<a class="sourceLine" id="cb40-60" title="60">    <span class="fu">expiration:</span><span class="at"> </span><span class="st">&quot;24h&quot;</span></a>
<a class="sourceLine" id="cb40-61" title="61">  </a>
<a class="sourceLine" id="cb40-62" title="62">  <span class="fu">encryption:</span></a>
<a class="sourceLine" id="cb40-63" title="63">    <span class="fu">algorithm:</span><span class="at"> </span><span class="st">&quot;aes-256-gcm&quot;</span></a>
<a class="sourceLine" id="cb40-64" title="64">    <span class="fu">key:</span><span class="at"> ${ENCRYPTION_KEY}</span></a></code></pre></div>
<p>This LLD provides implementation-ready specifications with complete class structures, database schemas, API implementations, and deployment configurations that build upon all previous documents, enabling direct development of the finance spend analytics platform. # Pseudocode ## Finance Spend Analytics and Optimization Platform</p>
<p><em>Building upon PRD, FRD, NFRD, AD, HLD, and LLD for executable implementation logic</em></p>
<h2 id="etvx-framework-6">ETVX Framework</h2>
<h3 id="entry-criteria-6">ENTRY CRITERIA</h3>
<ul>
<li>✅ PRD, FRD, NFRD, AD, HLD, and LLD completed</li>
<li>✅ All component specifications and class structures defined</li>
</ul>
<h3 id="task-6">TASK</h3>
<p>Create executable pseudocode algorithms for core system components that can be directly translated to production code.</p>
<h3 id="exit-criteria-6">EXIT CRITERIA</h3>
<ul>
<li>✅ Complete pseudocode for all core processing algorithms</li>
<li>✅ Ready for direct translation to production code</li>
</ul>
<hr />
<h2 id="expense-processing-pipeline">1. Expense Processing Pipeline</h2>
<h3 id="receipt-ocr-processing">1.1 Receipt OCR Processing</h3>
<pre class="pseudocode"><code>ALGORITHM ProcessReceiptOCR
INPUT: image_data (bytes)
OUTPUT: ExtractedReceiptData

BEGIN
    // Image enhancement
    enhanced_image = EnhanceImage(image_data)
    
    // OCR text extraction
    raw_text = ExtractTextOCR(enhanced_image)
    
    // NLP data extraction
    structured_data = ExtractStructuredData(raw_text)
    
    // Validation and scoring
    validated_data = ValidateAndScore(structured_data)
    
    RETURN validated_data
END</code></pre>
<h3 id="ml-expense-categorization">1.2 ML Expense Categorization</h3>
<pre class="pseudocode"><code>ALGORITHM CategorizeExpenseML
INPUT: expense_data (ExpenseData)
OUTPUT: CategoryPrediction

BEGIN
    // Check cache
    cache_key = GenerateCacheKey(expense_data)
    cached_result = redis.Get(cache_key)
    IF cached_result THEN RETURN cached_result
    
    // Extract features
    features = ExtractMLFeatures(expense_data)
    embeddings = GetBERTEmbeddings(features.text)
    combined_features = CONCATENATE(embeddings, features.numerical)
    
    // ML prediction
    model = LoadCategorizationModel()
    prediction = model.Predict(combined_features)
    confidence = MAX(prediction)
    category = DecodePrediction(prediction)
    
    // Cache and return
    result = CategoryPrediction(category, confidence)
    redis.SetEx(cache_key, 3600, result)
    RETURN result
END</code></pre>
<h2 id="analytics-processing">2. Analytics Processing</h2>
<h3 id="query-engine">2.1 Query Engine</h3>
<pre class="pseudocode"><code>ALGORITHM ExecuteAnalyticsQuery
INPUT: query (AnalyticsQuery)
OUTPUT: QueryResult

BEGIN
    // Query optimization
    optimized_query = OptimizeQuery(query)
    
    // Cache check
    cache_key = GenerateQueryCacheKey(optimized_query)
    cached_result = redis.Get(cache_key)
    IF cached_result THEN RETURN cached_result
    
    // Data source selection
    IF ShouldUseClickHouse(query) THEN
        result = ExecuteClickHouseQuery(optimized_query)
    ELSE
        result = ExecutePostgresQuery(optimized_query)
    END IF
    
    // Cache result
    redis.SetEx(cache_key, GetCacheTTL(query), result)
    RETURN result
END</code></pre>
<h3 id="real-time-stream-processing">2.2 Real-Time Stream Processing</h3>
<pre class="pseudocode"><code>ALGORITHM ProcessSpendEventStream
INPUT: spend_event (SpendEvent)
OUTPUT: StreamProcessingResult

BEGIN
    // Update real-time metrics
    UpdateRealTimeMetrics(spend_event)
    
    // Anomaly detection
    anomaly_score = DetectStreamingAnomaly(spend_event)
    IF anomaly_score &gt; THRESHOLD THEN
        TriggerAnomalyAlert(spend_event, anomaly_score)
    END IF
    
    // Broadcast updates
    BroadcastRealTimeUpdate(spend_event)
    
    RETURN StreamProcessingResult(success=TRUE, anomaly_score)
END</code></pre>
<h2 id="anomaly-detection">3. Anomaly Detection</h2>
<h3 id="statistical-anomaly-detection">3.1 Statistical Anomaly Detection</h3>
<pre class="pseudocode"><code>ALGORITHM DetectStatisticalAnomalies
INPUT: transactions (List[Transaction])
OUTPUT: List[AnomalyResult]

BEGIN
    anomalies = []
    grouped_data = GroupTransactions(transactions)
    
    FOR group IN grouped_data
        model = GetAnomalyModel(group.key)
        features = ExtractAnomalyFeatures(group.transactions)
        
        // Multiple detection methods
        isolation_scores = model.isolation_forest.Score(features)
        statistical_scores = CalculateZScores(features)
        combined_scores = CombineScores(isolation_scores, statistical_scores)
        
        FOR i, score IN combined_scores
            IF score &gt; ANOMALY_THRESHOLD THEN
                anomaly = AnomalyResult(group.transactions[i], score)
                anomalies.APPEND(anomaly)
            END IF
        END FOR
    END FOR
    
    RETURN RankAnomaliesBySeverity(anomalies)
END</code></pre>
<h3 id="fraud-detection">3.2 Fraud Detection</h3>
<pre class="pseudocode"><code>ALGORITHM DetectFraudulentActivity
INPUT: expense (ExpenseData), user_context (UserContext)
OUTPUT: FraudDetectionResult

BEGIN
    risk_score = 0.0
    
    // Behavioral analysis
    behavioral_score = AnalyzeBehavioralPatterns(expense, user_context)
    risk_score += 0.4 * behavioral_score
    
    // Rule-based detection
    rule_violations = ApplyFraudRules(expense)
    rule_score = CalculateRuleScore(rule_violations)
    risk_score += 0.3 * rule_score
    
    // Vendor analysis
    vendor_risk = AnalyzeVendorRelationships(expense)
    risk_score += 0.3 * vendor_risk
    
    fraud_probability = ConvertToFraudProbability(risk_score)
    recommended_action = DetermineAction(fraud_probability)
    
    RETURN FraudDetectionResult(fraud_probability, recommended_action)
END</code></pre>
<h2 id="forecasting-algorithms">4. Forecasting Algorithms</h2>
<h3 id="budget-forecasting">4.1 Budget Forecasting</h3>
<pre class="pseudocode"><code>ALGORITHM GenerateBudgetForecast
INPUT: historical_data (List[SpendData]), params (ForecastParameters)
OUTPUT: BudgetForecast

BEGIN
    // Prepare time series
    time_series = PrepareTimeSeriesData(historical_data)
    
    // Model selection
    seasonality = DetectSeasonality(time_series)
    trend = DetectTrend(time_series)
    model = SelectForecastingModel(seasonality, trend)
    
    // Training and prediction
    trained_model = TrainModel(model, time_series)
    forecast = trained_model.Forecast(params.horizon)
    
    // Scenarios and confidence intervals
    scenarios = GenerateScenarios(forecast, params.scenarios)
    confidence_intervals = CalculateConfidenceIntervals(forecast)
    
    RETURN BudgetForecast(forecast, scenarios, confidence_intervals)
END</code></pre>
<h2 id="integration-workflows">5. Integration Workflows</h2>
<h3 id="erp-integration">5.1 ERP Integration</h3>
<pre class="pseudocode"><code>ALGORITHM SyncERPData
INPUT: erp_system (string), sync_config (SyncConfig)
OUTPUT: SyncResult

BEGIN
    connector = GetERPConnector(erp_system)
    
    // Extract data
    erp_data = connector.ExtractExpenseData(sync_config)
    
    // Transform data
    transformed_data = TransformData(erp_data, erp_system)
    
    // Load data
    load_result = LoadData(transformed_data)
    
    // Update sync status
    UpdateSyncStatus(erp_system, load_result)
    
    RETURN SyncResult(load_result.success, load_result.records_processed)
END</code></pre>
<h3 id="real-time-banking-integration">5.2 Real-Time Banking Integration</h3>
<pre class="pseudocode"><code>ALGORITHM ProcessBankFeed
INPUT: bank_code (string), feed_data (BankFeedData)
OUTPUT: ProcessingResult

BEGIN
    // Parse bank feed
    transactions = ParseBankFeed(feed_data)
    
    // Match with existing expenses
    matched_transactions = MatchTransactions(transactions)
    
    // Create new expense records
    new_expenses = CreateExpenseRecords(matched_transactions.unmatched)
    
    RETURN ProcessingResult(
        matched=matched_transactions.matched.LENGTH,
        created=new_expenses.LENGTH
    )
END</code></pre>
<p>This pseudocode provides executable algorithms for all core system components, ready for direct translation to production code implementing the finance spend analytics platform.</p>
