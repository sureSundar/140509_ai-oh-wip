<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RetailAI Inventory Optimizer - LIVE DEMO</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }
        .metric-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 20px;
            margin: 10px 0;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }
        .metric-card:hover {
            transform: translateY(-5px);
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-critical { background-color: #dc3545; }
        .status-low { background-color: #ffc107; }
        .status-optimal { background-color: #28a745; }
        .status-overstock { background-color: #17a2b8; }
        .live-indicator {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .api-status {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
        .chart-container {
            position: relative;
            height: 300px;
            margin: 20px 0;
        }
        .action-btn {
            margin: 5px;
            padding: 5px 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .sell-btn { background-color: #dc3545; color: white; }
        .restock-btn { background-color: #28a745; color: white; }
    </style>
</head>
<body>
    <!-- API Status Indicator -->
    <div class="api-status">
        <div class="alert alert-success" id="apiStatus">
            <i class="fas fa-circle live-indicator me-2"></i>
            <span id="statusText">Connecting to API...</span>
        </div>
    </div>

    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark" style="background: rgba(0,0,0,0.2);">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-chart-line me-2"></i>
                RetailAI Inventory Optimizer - LIVE SYSTEM
            </a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text text-white">
                    <i class="fas fa-database me-1"></i>
                    Real Database Connected
                </span>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- Live System Status -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="glass-card p-4">
                    <h2 class="text-white mb-3">
                        <i class="fas fa-broadcast-tower me-2 live-indicator"></i>
                        LIVE SYSTEM - Real Database & API Integration
                    </h2>
                    <div class="row">
                        <div class="col-md-3">
                            <div class="text-white">
                                <h6>Backend Status</h6>
                                <span class="badge bg-success" id="backendStatus">FastAPI Running</span>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-white">
                                <h6>Database Status</h6>
                                <span class="badge bg-success" id="dbStatus">SQLite Connected</span>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-white">
                                <h6>Last Update</h6>
                                <span id="lastUpdate">Loading...</span>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-white">
                                <h6>Auto Refresh</h6>
                                <span class="badge bg-info">Every 5 seconds</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Live Inventory Overview -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="glass-card p-4">
                    <h3 class="text-white mb-3">
                        <i class="fas fa-boxes me-2"></i>
                        Live Inventory Status - Real Database Data
                    </h3>
                    <div class="row" id="inventoryOverview">
                        <div class="col-12 text-center">
                            <div class="spinner-border text-white" role="status">
                                <span class="visually-hidden">Loading real data...</span>
                            </div>
                            <p class="text-white mt-2">Loading live inventory data from API...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Live Forecasting -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="glass-card p-4">
                    <h3 class="text-white mb-3">
                        <i class="fas fa-chart-area me-2"></i>
                        Live ML Forecasting - Real Predictions
                    </h3>
                    <div class="row">
                        <div class="col-md-8">
                            <div class="metric-card">
                                <h5>Real-time Demand Forecast</h5>
                                <div class="chart-container">
                                    <canvas id="liveforecastChart"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="metric-card">
                                <h6>Live Model Performance</h6>
                                <div id="modelMetrics">
                                    <div class="spinner-border" role="status"></div>
                                    <p>Loading model metrics...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Live Alerts -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="glass-card p-4">
                    <h3 class="text-white mb-3">
                        <i class="fas fa-bell me-2"></i>
                        Live Alert System - Real-time Notifications
                    </h3>
                    <div class="row" id="liveAlerts">
                        <div class="col-12 text-center">
                            <div class="spinner-border text-white" role="status"></div>
                            <p class="text-white mt-2">Loading live alerts...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Live KPIs -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="glass-card p-4">
                    <h3 class="text-white mb-3">
                        <i class="fas fa-tachometer-alt me-2"></i>
                        Live Executive KPIs - Real Business Metrics
                    </h3>
                    <div class="row" id="liveKPIs">
                        <div class="col-12 text-center">
                            <div class="spinner-border text-white" role="status"></div>
                            <p class="text-white mt-2">Loading live KPIs...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000/api';
        let forecastChart = null;

        // API Status Management
        function updateAPIStatus(status, message) {
            const statusElement = document.getElementById('apiStatus');
            const statusText = document.getElementById('statusText');
            
            statusElement.className = `alert alert-${status}`;
            statusText.textContent = message;
        }

        // Fetch data from real API
        async function fetchFromAPI(endpoint) {
            try {
                const response = await fetch(`${API_BASE}${endpoint}`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return await response.json();
            } catch (error) {
                console.error(`API Error (${endpoint}):`, error);
                updateAPIStatus('danger', `API Error: ${error.message}`);
                throw error;
            }
        }

        // Update inventory action
        async function updateInventory(productId, change, action) {
            try {
                await fetch(`${API_BASE}/inventory/${productId}/update`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ quantity_change: change })
                });
                
                // Show success message
                const alert = document.createElement('div');
                alert.className = 'alert alert-success alert-dismissible fade show position-fixed';
                alert.style.top = '100px';
                alert.style.right = '20px';
                alert.style.zIndex = '1050';
                alert.innerHTML = `
                    <strong>Success!</strong> ${action} completed.
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                document.body.appendChild(alert);
                
                // Auto remove after 3 seconds
                setTimeout(() => alert.remove(), 3000);
                
                // Refresh data
                loadInventoryData();
                loadKPIData();
            } catch (error) {
                console.error('Update error:', error);
            }
        }

        // Load live inventory data
        async function loadInventoryData() {
            try {
                const data = await fetchFromAPI('/inventory');
                updateAPIStatus('success', 'API Connected - Live Data');
                
                const container = document.getElementById('inventoryOverview');
                container.innerHTML = data.map(item => `
                    <div class="col-md-4 col-lg-2">
                        <div class="metric-card text-center">
                            <div class="status-indicator status-${item.status}"></div>
                            <h6>${item.product_name}</h6>
                            <div class="h4 ${getStatusColor(item.status)}">
                                ${item.current_stock}
                            </div>
                            <small class="text-muted">
                                EOQ: ${item.eoq}<br>
                                Reorder: ${item.reorder_point}<br>
                                Days left: ${item.days_of_stock}
                            </small>
                            <div class="mt-2">
                                ${getStatusBadge(item.status)}
                            </div>
                            <div class="mt-2">
                                <button class="action-btn sell-btn" onclick="updateInventory(${item.product_id}, -5, 'Sale')">
                                    <i class="fas fa-minus"></i> Sell 5
                                </button>
                                <button class="action-btn restock-btn" onclick="updateInventory(${item.product_id}, 10, 'Restock')">
                                    <i class="fas fa-plus"></i> +10
                                </button>
                            </div>
                            <div class="mt-1">
                                <small class="text-success">Savings: $${item.cost_savings}</small>
                            </div>
                        </div>
                    </div>
                `).join('');
                
                document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
            } catch (error) {
                document.getElementById('inventoryOverview').innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Unable to load live inventory data. Please ensure the API server is running on port 8000.
                            <br><small>Error: ${error.message}</small>
                        </div>
                    </div>
                `;
            }
        }

        // Load live forecast data
        async function loadForecastData(productId = 1) {
            try {
                const data = await fetchFromAPI(`/forecast/${productId}`);
                
                // Update model metrics
                document.getElementById('modelMetrics').innerHTML = `
                    <div class="mb-3">
                        <strong>Model:</strong> ${data.model_used}<br>
                        <strong>Accuracy:</strong> ${data.accuracy}%<br>
                        <strong>Product:</strong> ${data.product_name}
                    </div>
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle me-2"></i>
                        Live predictions active
                    </div>
                `;

                // Create forecast chart
                const ctx = document.getElementById('liveforecastChart').getContext('2d');
                
                if (forecastChart) {
                    forecastChart.destroy();
                }

                const labels = data.forecast_data.map(d => new Date(d.date).toLocaleDateString());
                const predictions = data.forecast_data.map(d => d.predicted_demand);
                const upperBounds = data.forecast_data.map(d => d.upper_bound);
                const lowerBounds = data.forecast_data.map(d => d.lower_bound);

                forecastChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Predicted Demand',
                                data: predictions,
                                borderColor: '#28a745',
                                backgroundColor: 'rgba(40, 167, 69, 0.1)',
                                fill: false,
                                tension: 0.4
                            },
                            {
                                label: 'Upper Confidence',
                                data: upperBounds,
                                borderColor: 'rgba(255, 193, 7, 0.5)',
                                backgroundColor: 'rgba(255, 193, 7, 0.1)',
                                fill: '+1',
                                tension: 0.4,
                                pointRadius: 0
                            },
                            {
                                label: 'Lower Confidence',
                                data: lowerBounds,
                                borderColor: 'rgba(255, 193, 7, 0.5)',
                                backgroundColor: 'rgba(255, 193, 7, 0.1)',
                                fill: false,
                                tension: 0.4,
                                pointRadius: 0
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: `Live Forecast: ${data.product_name} (${data.accuracy}% accuracy)`
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: { display: true, text: 'Demand Units' }
                            }
                        }
                    }
                });
            } catch (error) {
                document.getElementById('modelMetrics').innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Unable to load forecast data
                    </div>
                `;
            }
        }

        // Load live alerts
        async function loadAlerts() {
            try {
                const data = await fetchFromAPI('/alerts');
                
                const container = document.getElementById('liveAlerts');
                if (data.length === 0) {
                    container.innerHTML = `
                        <div class="col-12">
                            <div class="alert alert-success">
                                <i class="fas fa-check-circle me-2"></i>
                                No active alerts - All systems optimal
                            </div>
                        </div>
                    `;
                } else {
                    container.innerHTML = data.map(alert => `
                        <div class="col-md-4">
                            <div class="metric-card">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-${getSeverityIcon(alert.severity)} me-2"></i>
                                    <div>
                                        <h6 class="mb-1">${alert.product_name}</h6>
                                        <p class="mb-1">${alert.message}</p>
                                        <small class="text-muted">${new Date(alert.created_at).toLocaleString()}</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                document.getElementById('liveAlerts').innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-warning">
                            Unable to load live alerts: ${error.message}
                        </div>
                    </div>
                `;
            }
        }

        // Load live KPIs
        async function loadKPIData() {
            try {
                const data = await fetchFromAPI('/kpis');
                
                const kpis = [
                    { title: "Cost Reduction", data: data.cost_reduction, icon: "dollar-sign", color: "success" },
                    { title: "Service Level", data: data.service_level, icon: "chart-line", color: "primary" },
                    { title: "Inventory Turnover", data: data.inventory_turnover, icon: "sync", color: "info" },
                    { title: "Forecast Accuracy", data: data.forecast_accuracy, icon: "bullseye", color: "warning" }
                ];

                const container = document.getElementById('liveKPIs');
                container.innerHTML = kpis.map(kpi => `
                    <div class="col-md-3">
                        <div class="metric-card text-center">
                            <i class="fas fa-${kpi.icon} fa-2x text-${kpi.color} mb-2"></i>
                            <h6>${kpi.title}</h6>
                            <div class="h3 text-${kpi.color}">${kpi.data.value}</div>
                            <small class="text-success">
                                <i class="fas fa-arrow-up me-1"></i>
                                ${kpi.data.change}
                            </small>
                        </div>
                    </div>
                `).join('');

                // Add summary metrics
                container.innerHTML += `
                    <div class="col-12 mt-3">
                        <div class="metric-card">
                            <div class="row text-center">
                                <div class="col-md-6">
                                    <h6>Total Inventory Value</h6>
                                    <div class="h4 text-info">$${data.total_inventory_value.toLocaleString()}</div>
                                </div>
                                <div class="col-md-6">
                                    <h6>Monthly Sales</h6>
                                    <div class="h4 text-success">$${data.monthly_sales.toLocaleString()}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } catch (error) {
                document.getElementById('liveKPIs').innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-warning">
                            Unable to load live KPIs: ${error.message}
                        </div>
                    </div>
                `;
            }
        }

        // Helper functions
        function getStatusColor(status) {
            const colors = {
                'critical': 'text-danger',
                'low': 'text-warning',
                'optimal': 'text-success',
                'overstock': 'text-info'
            };
            return colors[status] || 'text-secondary';
        }

        function getStatusBadge(status) {
            const badges = {
                'critical': '<div class="badge bg-danger">Critical</div>',
                'low': '<div class="badge bg-warning">Low Stock</div>',
                'optimal': '<div class="badge bg-success">Optimal</div>',
                'overstock': '<div class="badge bg-info">Overstock</div>'
            };
            return badges[status] || '<div class="badge bg-secondary">Unknown</div>';
        }

        function getSeverityIcon(severity) {
            const icons = {
                'critical': 'exclamation-triangle text-danger',
                'warning': 'exclamation-circle text-warning',
                'info': 'info-circle text-info'
            };
            return icons[severity] || 'info-circle text-secondary';
        }

        // Initialize and start live updates
        async function initializeLiveSystem() {
            console.log('Initializing live system...');
            
            // Load all data
            await Promise.all([
                loadInventoryData(),
                loadForecastData(),
                loadAlerts(),
                loadKPIData()
            ]);

            // Set up auto-refresh
            setInterval(async () => {
                await Promise.all([
                    loadInventoryData(),
                    loadAlerts(),
                    loadKPIData()
                ]);
            }, 5000); // Refresh every 5 seconds

            console.log('Live system initialized successfully');
        }

        // Start the system when page loads
        document.addEventListener('DOMContentLoaded', initializeLiveSystem);
    </script>
</body>
</html>
